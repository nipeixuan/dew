<!--
  ~ Copyright 2022. the original author or authors
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="author" content="v3.0.0-Beta3">
<title>Dew:一站式微服务解决方案</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Dew:一站式微服务解决方案</h1>
<div class="details">
<span id="author" class="author">v3.0.0-Beta3</span><br>
<span id="revdate">2020-6-10</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#dew微服务体系_dew_microservice_system">1. Dew微服务体系 Dew Microservice System</a>
<ul class="sectlevel2">
<li><a href="#设计理念">1.1. 设计理念</a>
<ul class="sectlevel3">
<li><a href="#微服务架构的尴尬">1.1.1. 微服务架构的尴尬</a></li>
<li><a href="#dew设计理念">1.1.2. Dew设计理念</a></li>
</ul>
</li>
<li><a href="#项目结构">1.2. 项目结构</a></li>
</ul>
</li>
<li><a href="#架构设计_architecture_chapter">2. 架构设计 Architecture Chapter</a></li>
<li><a href="#编码开发_framework_chapter">3. 编码开发 Framework Chapter</a>
<ul class="sectlevel2">
<li><a href="#framework-quick-start">3.1. 框架快速入门</a>
<ul class="sectlevel3">
<li><a href="#需求分析">3.1.1. 需求分析</a></li>
<li><a href="#功能体验">3.1.2. 功能体验</a></li>
<li><a href="#模块设计">3.1.3. 模块设计</a></li>
<li><a href="#framework-quick-start-core-code-instructions">3.1.4. 核心代码说明</a></li>
</ul>
</li>
<li><a href="#framework-user-manual">3.2. 框架使用手册</a>
<ul class="sectlevel3">
<li><a href="#framework-user-manual-import">3.2.1. 引入方式</a></li>
<li><a href="#dew类介绍">3.2.2. Dew类介绍</a></li>
<li><a href="#常用工具集">3.2.3. 常用工具集</a></li>
<li><a href="#framework-user-manual-cluster">3.2.4. 集群功能</a></li>
<li><a href="#统一响应">3.2.5. 统一响应</a></li>
<li><a href="#异常处理">3.2.6. 异常处理</a></li>
<li><a href="#数据验证">3.2.7. 数据验证</a></li>
<li><a href="#cors支持">3.2.8. CORS支持</a></li>
<li><a href="#framework-user-manual-auth">3.2.9. 权限认证</a></li>
<li><a href="#测试支持">3.2.10. 测试支持</a></li>
<li><a href="#幂等处理">3.2.11. 幂等处理</a></li>
<li><a href="#dew_sdk_插件">3.2.12. Dew SDK 插件</a></li>
<li><a href="#代码质量检查">3.2.13. 代码质量检查</a></li>
</ul>
</li>
<li><a href="#framework-configuration">3.3. 框架配置速查</a>
<ul class="sectlevel3">
<li><a href="#dew_参数">3.3.1. <code>Dew</code> 参数</a></li>
<li><a href="#spring_boot_核心参数">3.3.2. <code>Spring boot</code> 核心参数</a></li>
</ul>
</li>
<li><a href="#framework-best-practices">3.4. 框架最佳实践</a>
<ul class="sectlevel3">
<li><a href="#项目模块设计">3.4.1. 项目模块设计</a></li>
<li><a href="#代码包设计">3.4.2. 代码包设计</a></li>
<li><a href="#代码质量管理">3.4.3. 代码质量管理</a></li>
<li><a href="#validated_注解">3.4.4. <code>@Validated</code> 注解</a></li>
<li><a href="#jackson_对于_java8_时间转换_springmvc_以_jackson_接收_json_数据">3.4.5. <code>jackson</code> 对于 <code>Java8</code> 时间转换（ <code>SpringMVC</code> 以 <code>jackson</code> 接收 <code>json</code> 数据）</a></li>
<li><a href="#缓存处理">3.4.6. 缓存处理</a></li>
<li><a href="#jdbc_批量插入性能问题">3.4.7. jdbc 批量插入性能问题</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Devops-chapter">4. 部署运维 DevOps Chapter</a>
<ul class="sectlevel2">
<li><a href="#devops-quick-start">4.1. DevOps快速入门</a>
<ul class="sectlevel3">
<li><a href="#功能体验_2">4.1.1. 功能体验</a></li>
<li><a href="#what-for-dew-devops">4.1.2. 发生了什么？</a></li>
</ul>
</li>
<li><a href="#devops-user-manual">4.2. DevOps使用手册</a>
<ul class="sectlevel3">
<li><a href="#devops-user-manual-import">4.2.1. 引入方式</a></li>
<li><a href="#支持的项目类型">4.2.2. 支持的项目类型</a></li>
<li><a href="#nodejs项目的特殊处理">4.2.3. NodeJS项目的特殊处理</a></li>
<li><a href="#项目配置">4.2.4. 项目配置</a></li>
<li><a href="#打包部署">4.2.5. 打包部署</a></li>
<li><a href="#版本回滚">4.2.6. 版本回滚</a></li>
<li><a href="#应用卸载">4.2.7. 应用卸载</a></li>
<li><a href="#日志查看">4.2.8. 日志查看</a></li>
<li><a href="#伸缩扩展">4.2.9. 伸缩扩展</a></li>
<li><a href="#应用刷新">4.2.10. 应用刷新</a></li>
<li><a href="#应用远程调试">4.2.11. 应用远程调试</a></li>
<li><a href="#cicd工具支持">4.2.12. CI/CD工具支持</a></li>
<li><a href="#执行通知">4.2.13. 执行通知</a></li>
<li><a href="#dew-devops-deploy">4.2.14. Dew DevOps 脚本部署</a></li>
<li><a href="#监控管理">4.2.15. 监控管理</a></li>
</ul>
</li>
<li><a href="#devops-env-install">4.3. 开发/测试环境安装配置</a></li>
</ul>
</li>
<li><a href="#note">NOTE</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>本分支构建 <code>Dew</code> 3.x 版本，此版本移除了 <code>Spring Cloud</code>，服务调度完全基于 <code>Istio</code> 以进一步简化服务开发。</p>
</div>
<div class="paragraph">
<p>最新稳定版是 <code>2.1.0-rc</code> 请切换到 <a href="https://github.com/gudaoxuri/dew/tree/2.1.0-rc">2.1.0-RC</a> tag.</p>
</div>
<div class="paragraph">
<p>如需基于 <code>Spring boot 1.x</code> 的非容器版本请切换到 <a href="https://github.com/gudaoxuri/dew/tree/1.5.1-RC">1.5.1-RC</a> tag.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dew微服务体系_dew_microservice_system"><a class="anchor" href="#dew微服务体系_dew_microservice_system"></a>1. Dew微服务体系 Dew Microservice System</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<a class="image" href="https://travis-ci.org/gudaoxuri/dew"><img src="https://img.shields.io/travis/gudaoxuri/dew.svg" alt="dew"></a>
</div>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://app.codacy.com/app/gudaoxuri/dew?utm_source=github.com&utm_medium=referral&utm_content=gudaoxuri/dew&utm_campaign=Badge_Grade_Dashboard"><img src="https://api.codacy.com/project/badge/Grade/aacfdad1579043f0a2c1928b53096b7b" alt="aacfdad1579043f0a2c1928b53096b7b"></a>
</div>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.apache.org/licenses/LICENSE-2.0.txt"><img src="https://img.shields.io/badge/license-ASF2-blue.svg" alt="Apache License 2"></a>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="https://img.shields.io/maven-central/v/group.idealworld.dew/parent-starter" alt="Maven Central">
</div>
</div>
<div class="paragraph">
<p>微服务一站式解决方案( <a href="http://doc.dew.idealworld.group" class="bare">http://doc.dew.idealworld.group</a> )，提供：架构指南、容器优先/兼容Spring与Service Mesh的框架、最佳实践及DevOps标准化流程。</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Dew [du:] 意为 <code>露水</code> ，希望此体系可以像晨间的露水一样透明、静谧、丰盈。让使用者尽量不要感知Dew的存在，专注业务实现。</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="设计理念"><a class="anchor" href="#设计理念"></a>1.1. 设计理念</h3>
<div class="sect3">
<h4 id="微服务架构的尴尬"><a class="anchor" href="#微服务架构的尴尬"></a>1.1.1. 微服务架构的尴尬</h4>
<div class="paragraph">
<p>几乎人人都在谈微服务，每个IT企业都在做微服务架构，但大部分项目都会存在这样的尴尬：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>什么是微服务？怎么做微服务架构？为什么这么乱？</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>缺乏微服务架构设计思想</strong> 导致成功的微服务项目屈指可数，只听说微服务的好，却不知微服务的坑</p>
</div>
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>架构好了，框架怎么选择？ dubbo、Spring Boot/Cloud、Istio、Vert.x、还是自研？大一点的企业都会选择自研，但自研又会遇到如下问题：</p>
<div class="ulist">
<ul>
<li>
<p>无法传承，框架的研发人员离职后没有可以接手</p>
</li>
<li>
<p>上手难度大，很多框架喜欢重复造轮子，做出来的与业界主流思想/标准格格不入，导致学习培训成本很高</p>
</li>
<li>
<p>功能片面，不通用，服务框架讲求通用性，尽量让整个公司使用同一套规范以方便维护，但很多框架只实现了某些特定场景的功能，无法通用化</p>
</li>
<li>
<p>维护成本高，尤其是对于完全自研的框架，往往需要专职人员维护</p>
</li>
<li>
<p>与主流脱节，无法分享微服务化、容器化、服务网格化的红利</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>没有合适的微服务框架</strong> 导致人员技能要求高、项目研发成本高</p>
</div>
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>框架选型也有了，但怎么测试、发布与运维？都在说容器化，要怎么做？</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>缺少一体化的研发流程支撑</strong> 导致各项目规范不统一、发布效率低、容器化问题频出</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="dew设计理念"><a class="anchor" href="#dew设计理念"></a>1.1.2. Dew设计理念</h4>
<div class="paragraph">
<p>上述问题是Dew必须面对的，应对的设计核心理念是：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>提供微服务架构指南 + 扩展主流微服务框架 + 标准化DevOps流程</pre>
</div>
</div>
<div class="paragraph">
<div class="title"><strong>提供微服务架构指南</strong></div>
<p>项目要上微服务，其架构思想是前提，《微服务架构设计》(<a href="https://gudaoxuri.gitbook.io/microservices-architecture" class="bare">https://gudaoxuri.gitbook.io/microservices-architecture</a>) 做为入门书籍非常合适。</p>
</div>
<div class="olist arabic">
<div class="title"><strong>扩展主流微服务框架</strong></div>
<ol class="arabic">
<li>
<p>简单，用最通用的、标准的、开发人员都熟悉的开发模型</p>
</li>
<li>
<p>全面，尽量重用市场已有能力实现，减少框架自身的维护成本</p>
</li>
<li>
<p>轻量，原则上不引入高侵入性的三方框架/类库</p>
</li>
<li>
<p>可替换，只做扩展，尽量不修改基础框架代码，开发人员完全可以直接基于基础框架开发</p>
</li>
<li>
<p>主流，整合流行的微服务框架</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>实现上我们选择 <code>Spring Boot</code> 这一业界主流框架，对上兼容 <code>Spring Boot</code> 与 <code>Service Mesh</code>。</p>
</div>
<div class="paragraph">
<div class="title"><strong>标准化DevOps流程</strong></div>
<p>目前市场有两种主流的DevOps做法：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>以 <code>Jenkins X</code> 、 <code>Gitlab CI</code> 为代表的CI/CD工具主导的DevOps流程</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>集成度低、操作不友好</strong></p>
</div>
<div class="paragraph">
<p>DevOps是一个系统性工程，想通过传统的CI/CD工具的方法实现难度较大</p>
</div>
</blockquote>
</div>
<div class="ulist">
<ul>
<li>
<p>以 <a href="http://https://develop.aliyun.com/devops">阿里云</a> 、 <a href="https://azure.microsoft.com/zh-cn/solutions/devops/">Azure</a>
为代表的云厂商DevOps方案</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>平台依赖，不通用</strong></p>
</div>
<div class="paragraph">
<p>云厂商方案做了高度集成，弥补了工具型方案的不足，但问题也很明显，各厂商都有自己的一套标准，互不兼容，导致平台绑定，无法迁移</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><code>Dew</code> 在DevOps上另辟蹊径，以Maven为核心构建，其优点在于：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Maven是行业标准，并且兼容除JVM外的其它语言环境，可支撑所有主流项目</p>
</li>
<li>
<p>可在本地执行完成DevOps开发流程，也可与CI/CD工具整合提供测试/生产等环境的DevOps</p>
</li>
<li>
<p>对CI/CD工具的依赖度低、开源、标准化，无厂商绑定</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>基于这一理念，我们提供的一体化的Maven插件，实现了：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>CI/CD流程支持，自动化依赖管理、测试、质检、打包与发布、回滚、远程Debug等</p>
</li>
<li>
<p>全面容器化，所有环境均为容器方案</p>
</li>
<li>
<p>支持与 <code>Gitlab CI</code> 或其它 CI/CD服务整合</p>
</li>
<li>
<p>实现针对JVM服务、类库、前端等主流项目的支撑</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>一言蔽之， <code>Dew</code> 致力于成为微服务一站式解决方案。</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="项目结构"><a class="anchor" href="#项目结构"></a>1.2. 项目结构</h3>
<div class="listingblock">
<div class="content">
<pre>|- framework
|-  |- modules
|-  |-  |- parent-starter                  // 父Pom模块
|-  |-  |- boot-starter                    // 核心模块，包含Spring Boot Web相关依赖
|-  |-  |- cluster-common                  // 集群能力接口
|-  |-  |- cluster-common-test             // 集群测试模块
|-  |-  |- cluster-hazelcast               // Hazelcast集群能力实现
|-  |-  |- cluster-rabbit                  // RabbitMQ集群能力实现
|-  |-  |- cluster-redis                   // Redis集群能力实现
|-  |-  |- cluster-mqtt                    // MQTT集群能力实现
|-  |-  |- idempotent-starter              // 幂等处理模块
|-  |-  |- notification                    // 通知处理模块
|-  |-  |- test-starter                    // 单元测试模块
|-  |-  |- hbase-starter                   // Spring Boot HBase Starter 模块
|-  |- assists                             // 框架辅助工具
|-  |-  |- sdkgen-maven-plugin             // SDK自动生成、上传插件
|-  |- checkstyle                          // 项目CheckStyle
|- devops                                  // DevOps部分
|-  |- maven                               // DevOps使用到的Maven插件
|-  |-  |- dew-maven-plugin                // DevOps核心插件
|-  |-  |- dew-maven-agent                 // DevOps部署优化插件
|-  |- sh                                  // DevOps执行脚本
|-  |- cicd                                // 各CI服务的 CI/CD 配置
|-  |-  |- gitlabci                        // Gitlab CI CI/CD配置
|-  |-  |- jenkins                         // Jenkins CI/CD配置
|-  |- docker                              // DevOps使用到的镜像
|-  |-  |- dew-devops                      // 集成 Java Maven Node Git 的镜像
|-  |- it                                  // 集成测试
|- docs                                    // 文档</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="架构设计_architecture_chapter"><a class="anchor" href="#架构设计_architecture_chapter"></a>2. 架构设计 Architecture Chapter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>微服务架构设计请参见本书：</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/gudaoxuri/Microservices-Architecture" class="bare">https://github.com/gudaoxuri/Microservices-Architecture</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="编码开发_framework_chapter"><a class="anchor" href="#编码开发_framework_chapter"></a>3. 编码开发 Framework Chapter</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="framework-quick-start"><a class="anchor" href="#framework-quick-start"></a>3.1. 框架快速入门</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
本文以 To-Do 项目为示例讲解 <code>Dew</code> 框架部分的入门操作，项目地址： <a href="https://github.com/dew-ms/devops-example-todo" class="bare">https://github.com/dew-ms/devops-example-todo</a> 。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="需求分析"><a class="anchor" href="#需求分析"></a>3.1.1. 需求分析</h4>
<div class="paragraph">
<p>To-Do项目实现一个简单的任务记录功能，要求支持：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>对任务的添加、删除，任务列表的查看等基础功能</p>
</li>
<li>
<p>加入类似Excel的公式计算能力，所有以 <code>=</code> 号开头的任务均被视为计算公式，输入后返回计算后的值，
例如输入 <code>=1024*1024</code> 返回<code>1048576</code></p>
</li>
<li>
<p>终端支持H5、微信小程序等平台</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="功能体验"><a class="anchor" href="#功能体验"></a>3.1.2. 功能体验</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
体验环境要求安装 Java(&gt;=8)、Maven、NodeJS(&gt;=8)
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre>git clone https://github.com/dew-ms/devops-example-todo.git
cd devops-example-todo
# 先执行安装
mvn install -Dmaven.test.skip=true
# 打开两个命令窗口分别启动两个组件（各组件的作用后文会说明）
mvn spring-boot:run -pl backend/services/kernel
mvn spring-boot:run -pl backend/services/compute
# 打开新的命令窗口，启动前端
cd frontend &amp;&amp; npm install &amp;&amp; npm run dev:h5
# 自动打开浏览器，切换到移动模式体验</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/todo-demo.gif" alt="todo demo">
</div>
</div>
</div>
<div class="sect3">
<h4 id="模块设计"><a class="anchor" href="#模块设计"></a>3.1.3. 模块设计</h4>
<div class="paragraph">
<p>此程序比较简单，核心能力由 <code>kernel</code> 组件提供，
考虑到公式计算对CPU的要求较高，所以独立成 <code>compute</code> 组件，由 <code>kernel</code> 发起调用，同时这也演示了服务间Rest调用。
另外程序添加 <code>notifier</code> 组件，所有操作都可发起通知，用于演示MQ调用。
三个组件共用的代码放在 <code>common</code> 模块中。</p>
</div>
<div class="paragraph">
<p>为兼容不同终端，前端使用<code>taro</code> 框架。</p>
</div>
<div class="paragraph">
<p>目录结构如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>|- backend                  // 后端服务
|-  |- libraries            // 类库
|-  |-  |- common           // 公共模块，三个服务组件都依赖于此
|-  |- services             // 服务组件
|-  |-  |- kernel           // 核心服务，与前端交互的唯一入口
|-  |-  |- compute          // 公式计算服务，由kernel通过Rest调用
|-  |-  |- notifier         // 通知服务，由kernel通过MQ调用
|- frontend                 // 前端
|- pom.xml                  // 父Pom</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="framework-quick-start-core-code-instructions"><a class="anchor" href="#framework-quick-start-core-code-instructions"></a>3.1.4. 核心代码说明</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
这里只关注后端的实现，前端代码不展开说明。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- 引用 Dew的 parent-starter --&gt;
&lt;parent&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;parent-starter&lt;/artifactId&gt;
    &lt;version&gt;...&lt;/version&gt;
&lt;/parent&gt;

&lt;!-- ... --&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">backend/libraries/common/pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- ... --&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
        &lt;artifactId&gt;boot-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- 添加JPA支持  --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;

&lt;!-- ... --&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
详见 <a href="#framework-user-manual-import">引入方式</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">backend/services/kernel/pom.xml</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- ... --&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;group.idealworld.dew.devops.it&lt;/groupId&gt;
            &lt;artifactId&gt;todo-common&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- 引用 cluster-spi-redis 实现Dew集群能力的Redis实现 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
            &lt;artifactId&gt;cluster-spi-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
            &lt;artifactId&gt;test-starter&lt;/artifactId&gt;
            &lt;!--仅用于演示， 启用内嵌的Redis及 H2--&gt;
            &lt;scope&gt;compile&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;!-- ... --&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">backend/services/kernel/resources/bootstrap.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">dew:
  cluster:
    mq: redis # 使用Redis做为Dew集群的MQ实现

# ...</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
详见 <a href="#framework-user-manual-cluster">集群功能</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">backend/services/kernel/resources/bootstrap-default.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spring:
  redis: # Redis配置
    host: localhost
    port: 6379
    database: 0
  datasource: # DB配置
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:test

todo-compute:
  ribbon: # 使用自定义ribbon列表
    listOfServers: localhost:8082

# ...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">backend/libraries/common/group.idealworld.dew.devops.it.todo.common.TodoParentApplication.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/**
 * 空实现，做为所有组件启动类的父类
 */
// 启用 Spring Boot 能力
@SpringBootApplication
public class TodoParentApplication {

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">backend/services/kernel/group.idealworld.dew.devops.it.todo.kernel.TodoKernelApplication.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 继承自TodoParentApplication
public class TodoKernelApplication extends TodoParentApplication {

    // 启动类
    public static void main(String[] args) {
        new SpringApplicationBuilder(TodoKernelApplication.class).run(args);
    }

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">backend/services/kernel/group.idealworld.dew.devops.it.todo.kernel.controller.TodoController.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RestController
// Swagger文档注解
@Api("TODO示例")
@RequestMapping("/api")
public class TodoController {

    @Autowired
    private TodoService todoService;

    /**
     * Add int.
     *
     * @param content the content
     * @return the int
     */
    @PostMapping("")
    @ApiOperation(value = "添加Todo记录")
    public Todo add(@RequestBody String content) {
        return todoService.add(content);
    }

    // ...

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">backend/services/kernel/group.idealworld.dew.devops.it.todo.kernel.service.TodoService.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Service
public class TodoService {

    @Autowired
    private RestTemplate restTemplate;

    /**
     * Add int.
     *
     * @param content the content
     * @return id int
     */
    public Todo add(String content) {
        if (content.trim().startsWith("=")) {
            // 去掉 = 号
            content = content.trim().substring(1);
            // 此为幂等修改操作，故使用 put 方法
            // restTemplate 的 put 方法没有返回值，只能使用此方式
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.TEXT_PLAIN);
            HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(content, headers);
            // 使用Spring的 restTemplate 实现服务间 rest 调用
            // computeService 为配置的服务地址，在Kubernetes下为service name + port
            content = restTemplate
                    .exchange(computeService + "/compute", HttpMethod.PUT, entity, String.class)
                    .getBody();
        }
        // ...
        // 使用Dew的集群MQ功能实现消息点对点发送
        Dew.cluster.mq.request(Constants.MQ_NOTIFY_TODO_ADD, $.json.toJsonString(todo));
        return todo;
    }

    // ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">backend/services/notifier/group.idealworld.dew.devops.it.todo.notifier.controller.NotifierController.java</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RestController
public class NotifierController {

    private static final Logger logger = LoggerFactory.getLogger(NotifierController.class);

    @PostConstruct
    public void processTodoAddEvent() {
        // 使用Dew的集群MQ功能实现消息点对点接收
        Dew.cluster.mq.response(Constants.MQ_NOTIFY_TODO_ADD, todo -&gt; {
            logger.info("Received add todo event :" + todo);
        });
    }

    // ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="framework-user-manual"><a class="anchor" href="#framework-user-manual"></a>3.2. 框架使用手册</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Dew</code> 框架部分是对 <code>Spring Boot</code> 的扩展，使用之前务必了解相关框架的基础知识。
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
本手册只介绍 <code>Dew</code> 框架部分的扩展功能！
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="framework-user-manual-import"><a class="anchor" href="#framework-user-manual-import"></a>3.2.1. 引入方式</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:examples/bone-example</pre>
</div>
</div>
<div class="paragraph">
<p><code>Dew</code> 所有模块均为Maven结构，使用如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!--引入Dew父依赖，也可以使用import方式--&gt;
&lt;parent&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;parent-starter&lt;/artifactId&gt;
    &lt;!--生产环境请选择合适的版本!--&gt;
    &lt;version&gt;${dew.version}&lt;/version&gt;
&lt;/parent&gt;
...
&lt;dependencies&gt;
    &lt;!--引入需要的模块--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
        &lt;artifactId&gt;对应模块名，见下文&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
...
&lt;!--开发者介绍--&gt;
&lt;developers&gt;
    &lt;developer&gt;
        &lt;name&gt;...&lt;/name&gt;
        &lt;email&gt;...&lt;/email&gt;
    &lt;/developer&gt;
&lt;/developers&gt;
&lt;!--SCM信息--&gt;
&lt;scm&gt;
    &lt;connection&gt;...&lt;/connection&gt;
    &lt;developerConnection&gt;...&lt;/developerConnection&gt;
    &lt;url&gt;&lt;/url&gt;
&lt;/scm&gt;
...</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>parent-starter</code> 中已包含各模块的版本，引用模块依赖时可省略版本号。
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. 功能模块</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">模块名</th>
<th class="tableblock halign-left valign-top">核心功能</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parent-starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">父Pom模块</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boot-starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">核心模块，包含Spring Boot Web相关依赖</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cluster-common</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群能力接口</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cluster-hazelcast</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hazelcast集群能力实现</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cluster-rabbit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RabbitMQ集群能力实现</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cluster-redis</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redis集群能力实现</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cluster-mqtt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MQTT集群能力实现</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hbase-starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HBase Spring Boot 实现</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">idempotent-starter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">幂等处理模块</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">通知处理模块</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="dew类介绍"><a class="anchor" href="#dew类介绍"></a>3.2.2. Dew类介绍</h4>
<div class="paragraph">
<p><code>Dew</code>类包装了一些常用的功能，是Dew的能力的主要输出口。</p>
</div>
<div class="listingblock">
<div class="title"><code>Dew</code>功能说明</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 获取集群操作能力，见下文
Dew.cluster.xx
// 获取通知操作能力，见下文
Dew.notify.xx
// 获取Spring上下文
Dew.applicationContext.xx
// 获取Dew配置，说见 框架配置速查
Dew.dewConfig.xx
// 获取认证处理能力，见下文
Dew.auth.xx

//  ============ 获取请求上下文信息  ============
// 当次请求的ID
Dew.context().getId()
// 请求来源IP
Dew.context().getSourceIP()
// 请求最初的URL
Dew.context().getRequestUri()
// 请求对应的token，详见下文
Dew.context().getToken()
// 请求对应的操作者信息，详见下文
Dew.context().optInfo()

// ============ 获取当前组件基础信息 ============
// 应用名称，对应为 spring.application.name
Dew.Info.name
// 应用环境，对应为 spring.profiles.active
Dew.Info.profile
// 应用主机Web端口，对应为 server.port
Dew.Info.webPort
// 应用主机IP
Dew.Info.ip
// 应用主机Host
Dew.Info.host
// 应用实例，各组件实例唯一
Dew.Info.instance

// ============ 定时任务操作 ============
// 此类下的操作会自动带入Dew.context()
/**
* 设定一个周期性调度任务.
*
* @param initialDelaySec 延迟启动的秒数
* @param periodSec       周期调度秒数
* @param fun             调度方法
*/
Dew.Timer.periodic(long initialDelaySec, long periodSec, VoidExecutor fun)
/**
* 设定一个定时任务.
*
* @param delaySec 延迟启动的秒数
* @param fun      定时任务方法
*/
Dew.Timer.timer(long delaySec, VoidExecutor fun)

// ============ 常用工具 ============
/**
* 获取真实IP.
*
* @param request 请求信息
* @return 真实的IP
*/
Dew.Util.getRealIP(HttpServletRequest request)
**
* 获取真实IP.
*
* @param requestHeader     请求头信息
* @param defaultRemoteAddr 缺省的IP地址
* @return 真实的IP
*/
Dew.Util.getRealIP(Map&lt;String, String&gt; requestHeader, String defaultRemoteAddr)
/**
* 创建一个新的线程.
* &lt;p&gt;
* 自动带入Dew.context()
*
* @param fun 执行的方法
*/
Dew.Util.newThread(Runnable fun)

/**
* 统一异常处理.
* &lt;p&gt;
* 封装任意异常到统一的格式，见下文
*
* @param &lt;E&gt;            上抛的异常类型
* @param code           异常编码
* @param ex             上抛的异常对象
* @param customHttpCode 自定义Http状态码
* @return 上抛的异常对象
*/
Dew.E.e(String code, E ex, int customHttpCode)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="常用工具集"><a class="anchor" href="#常用工具集"></a>3.2.3. 常用工具集</h4>
<div class="paragraph">
<p><code>Dew</code> 的常用工具由 <code>Dew-Common</code> 包提供（ <a href="https://github.com/gudaoxuri/dew-common" class="bare">https://github.com/gudaoxuri/dew-common</a> ），功能如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Json与Java对象互转，支持泛型</p>
</li>
<li>
<p>Java Bean操作，Bean复制、反射获取/设置注解、字段、方法等</p>
</li>
<li>
<p>Java Class扫描操作，根据注解或名称过滤</p>
</li>
<li>
<p>Shell脚本操作，Shell内容获取、成功捕获及进度报告等</p>
</li>
<li>
<p>安全（加解密、信息摘要等）操作，Base64、MD5/BCrypt/AES/SHA等对称算法和RSA等非对称算法</p>
</li>
<li>
<p>Http操作，包含Get/Post/Put/Delete/Head/Options/Patch操作</p>
</li>
<li>
<p>金额操作，金额转大写操作</p>
</li>
<li>
<p>通用拦截器栈，前/后置、错误处理等</p>
</li>
<li>
<p>定时器操作，定时和周期性任务</p>
</li>
<li>
<p>常用文件操作，根据不同情况获取文件内容、Glob匹配等</p>
</li>
<li>
<p>常用字段操作，各类字段验证、身份证提取、UUID创建等</p>
</li>
<li>
<p>常用时间处理，常规时间格式化模板</p>
</li>
<li>
<p>主流文件MIME整理，MIME分类</p>
</li>
<li>
<p>服务降级处理</p>
</li>
<li>
<p>脚本处理</p>
</li>
<li>
<p>响应处理及分页模型</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title"><code>Dew Common</code> 的使用</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// Dew Common 功能均以 $ 开始，如:

//Json转成Java对象:
$.json.toObject(json,JavaModel.class)
//Json字符串转成List对象
$.json.toList(jsonArray, JavaModel.class)
//Bean复制
$.bean.copyProperties(ori, dist)
//获取Class的注解信息
$.bean.getClassAnnotation(IdxController.class, TestAnnotation.RPC.class)
//非对称加密
$.encrypt.Asymmetric.encrypt(d.getBytes("UTF-8"), publicKey, 1024, "RSA")
//Http Get
$.http.get("https://httpbin.org/get")
//验证手机号格式是否合法
$.field.validateMobile("18657120000")
//...</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
完整使用手册见 <a href="https://gudaoxuri.github.io/dew-common/" class="bare">https://gudaoxuri.github.io/dew-common/</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="framework-user-manual-cluster"><a class="anchor" href="#framework-user-manual-cluster"></a>3.2.4. 集群功能</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:cluster-example</pre>
</div>
</div>
<div class="paragraph">
<p><code>Dew</code> 的集群支持 <code>分布式缓存</code> <code>分布式Map</code> <code>分布式锁</code> <code>MQ</code> <code>领导者选举</code>，
并且做了接口抽象以适配不同的实现，目前支持 <code>Redis</code> <code>Hazelcast</code> <code>Rabbit</code> 。</p>
</div>
<div class="paragraph">
<p>各实现对应的支持如下：</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">功能</th>
<th class="tableblock halign-left valign-top">Redis</th>
<th class="tableblock halign-left valign-top">Hazelcast</th>
<th class="tableblock halign-left valign-top">Rabbit</th>
<th class="tableblock halign-left valign-top">MQTT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">分布式缓存</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">分布式Map</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">分布式锁</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MQ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*(只支持pub-sub)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">领导者选举</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">各实现的差异</div>
<div class="ulist">
<ul>
<li>
<p>Redis实现了所有功能，但其MQ上不适用于高可用场景</p>
</li>
<li>
<p>只有Rabbit的MQ支持跟踪日志（见跟踪日志章节）</p>
</li>
<li>
<p>MQTT多用于IoT环境</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="启用方式"><a class="anchor" href="#启用方式"></a>启用方式</h5>
<div class="listingblock">
<div class="title">依赖</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!--引入集群依赖，可选redis/hazelcast/rabbit--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-hazelcast&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-rabbit&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;cluster-spi-mqtt&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">增加配置</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">dew:
    cluster:                            # 集群功能
        cache:                          # 分布式缓存实现，默认为 redis
        map:                            # 分布式Map实现，默认为 redis
        lock:                           # 分布式锁实现，默认为 redis
        mq:                             # MQ实现，默认为 redis
        election:                       # 领导者选举实现，默认为 redis

spring:
    redis:
        host:                           # redis主机
        port:                           # redis端口
        database:                       # redis数据库
        password:                       # redis密码
        lettuce:
          pool:                         # 连接池配置
    rabbitmq:
      host:                             # rabbit主机
      port:                             # rabbit端口
      username:                         # rabbit用户名
      password:                         # rabbit密码
      virtual-host:                     # rabbit VH
    hazelcast:
        addresses: []                   # hazelcast地址，端口可选
dew:
  mw:                                   # 中间件
    mqtt:                               # MQTT集群实现
      broker:                           # Broker地址，e.g. tcp://127.0.0.1:1883
      clientId: Dew_Cluster_&lt;Cluster.instanceId&gt;
                                        # 连接客户端ID，注意一个集群内客户端ID必须唯一
      persistence:                      # 存储，默认为File，可选 memory
      userName:                         # 用户名
      password:                         # 密码
      timeoutSec:                       # 连接超时时间
      keepAliveIntervalSec:             # 心跳间隔时间
      cleanSession: true                # 是否消除Session</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
集群服务的使用入口统一为： <code>Dew.cluster.XX</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="分布式缓存"><a class="anchor" href="#分布式缓存"></a>分布式缓存</h5>
<div class="listingblock">
<div class="title">API</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2020. the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package group.idealworld.dew.core.cluster;

import java.util.List;
import java.util.Map;
import java.util.Set;

/**
 * 缓存服务.
 *
 * @author gudaoxuri
 */
public interface ClusterCache {

    /**
     * key是否存在.
     *
     * @param key key
     * @return 是否存在
     */
    boolean exists(String key);

    /**
     * 获取字符串值.
     *
     * @param key key
     * @return 值
     */
    String get(String key);

    /**
     * 设置字符串值.
     *
     * @param key   key
     * @param value value
     */
    void set(String key, String value);

    /**
     * 设置字符串值.
     *
     * @param key   key
     * @param value value
     */
    void setIfAbsent(String key, String value);

    /**
     * 设置字符串值，带过期时间.
     *
     * @param key       key
     * @param value     value
     * @param expireSec 过期时间(seconds)，0表示永不过期
     */
    void setex(String key, String value, long expireSec);

    /**
     * 字符串不存在时设置值，带过期时间.
     *
     * @param key       key
     * @param value     value
     * @param expireSec 过期时间(seconds)，0表示永不过期
     * @return true 设置成功 , false 设置失败（key已存在）
     */
    boolean setnx(String key, String value, long expireSec);


    /**
     * 设置字符串值，并返回其旧值，不存在时返回null.
     *
     * @param key   key
     * @param value value
     */
    String getSet(String key, String value);

    /**
     * 删除key.
     *
     * @param key key
     */
    void del(String key);

    /**
     * 添加列表值.
     *
     * @param key   key
     * @param value value
     */
    void lpush(String key, String value);

    /**
     * 添加列表.
     *
     * @param key       key
     * @param values    values
     * @param expireSec 过期时间(seconds)，0表示永不过期
     */
    void lmset(String key, List&lt;String&gt; values, long expireSec);

    /**
     * 添加列表.
     *
     * @param key    key
     * @param values values
     */
    void lmset(String key, List&lt;String&gt; values);

    /**
     * 弹出栈顶的列表值.
     * &lt;p&gt;
     * 注意，Redis的列表是栈结构，先进后出
     *
     * @param key key
     * @return 栈顶的列表值
     */
    String lpop(String key);

    /**
     * 获取列表值的长度.
     *
     * @param key key
     * @return 长度
     */
    long llen(String key);

    /**
     * 获取列表中的所有值.
     *
     * @param key key
     * @return 值列表
     */
    List&lt;String&gt; lget(String key);

    /**
     * 添加Set集合.
     *
     * @param key    key
     * @param values values
     */
    void smset(String key, List&lt;String&gt; values);

    /**
     * 添加Set集合.
     *
     * @param key       key
     * @param values    values
     * @param expireSec 过期时间(seconds)，0表示永不过期
     */
    void smset(String key, List&lt;String&gt; values, long expireSec);

    /**
     * 设置Set集合.
     *
     * @param key   key
     * @param value value
     */
    void sset(String key, String value);

    /**
     * 返回一个随机的成员值.
     *
     * @param key key
     * @return 返回值
     */
    String spop(String key);

    /**
     * 获取Set集合的长度.
     *
     * @param key key
     * @return 长度
     */
    long slen(String key);

    /**
     * 删除Set集合对应的values.
     *
     * @param key    key
     * @param values values
     * @return 影响的行数
     */
    long sdel(String key, String... values);

    /**
     * 返回set集合.
     *
     * @param key key
     * @return 值集合
     */
    Set&lt;String&gt; sget(String key);

    /**
     * 设置Hash集合.
     *
     * @param key       key
     * @param items     items
     * @param expireSec 过期时间(seconds)，0表示永不过期
     */
    void hmset(String key, Map&lt;String, String&gt; items, long expireSec);

    /**
     * 设置Hash集合.
     *
     * @param key   key
     * @param items items
     */
    void hmset(String key, Map&lt;String, String&gt; items);


    /**
     * 设置Hash集合field对应的value.
     *
     * @param key   key
     * @param field field
     * @param value value
     */
    void hset(String key, String field, String value);

    /**
     * 设置Hash集合field对应的value.
     *
     * @param key   key
     * @param field field
     * @param value value
     */
    void hsetIfAbsent(String key, String field, String value);


    /**
     * 获取Hash集合field对应的value.
     *
     * @param key   key
     * @param field field
     * @return field对应的value，不存在时返回null
     */
    String hget(String key, String field);

    /**
     * 获取Hash集合的所有items.
     *
     * @param key key
     * @return 所有items
     */
    Map&lt;String, String&gt; hgetAll(String key);

    /**
     * 判断Hash集合field是否存在.
     *
     * @param key   key
     * @param field field
     * @return 是否存在
     */
    boolean hexists(String key, String field);

    /**
     * 获取Hash集合的所有keys.
     *
     * @param key key
     * @return 所有keys
     */
    Set&lt;String&gt; hkeys(String key);

    /**
     * 获取Hash集合的所有values.
     *
     * @param key key
     * @return 所有values
     */
    Set&lt;String&gt; hvalues(String key);

    /**
     * 获取Hash集合的长度.
     *
     * @param key key
     * @return 长度
     */
    long hlen(String key);

    /**
     * 删除Hash集合是对应的field.
     *
     * @param key   key
     * @param field field
     */
    void hdel(String key, String field);

    /**
     * 原子加操作.
     *
     * @param key       key，key不存在时会自动创建值为0的对象
     * @param incrValue 要增加的值，必须是Long Int Float 或 Double
     * @return 操作后的值
     */
    long incrBy(String key, long incrValue);

    /**
     * Hash原子加操作.
     *
     * @param h         h
     * @param hk        hk
     * @param incrValue 要增加的值，必须是Long Int Float 或 Double
     * @return 操作后的值
     */
    long hashIncrBy(String h, String hk, long incrValue);


    /**
     * 原子减操作.
     *
     * @param key       key不存在时会自动创建值为0的对象
     * @param decrValue 要减少的值，必须是Long  或 Int
     * @return 操作后的值
     */
    long decrBy(String key, long decrValue);

    /**
     * 原子减操作.
     *
     * @param h         h
     * @param hk        hk
     * @param decrValue 要减少的值，必须是Long  或 Int
     * @return 操作后的值
     */
    long hashDecrBy(String h, String hk, long decrValue);

    /**
     * 设置过期时间.
     *
     * @param key       key
     * @param expireSec 过期时间(seconds)，0表示永不过期
     */
    void expire(String key, long expireSec);

    /**
     * 获取过期时间（秒）.
     *
     * @param key key
     * @return -2 key不存在，-1 对应的key永不过期，正数 过期时间(seconds)
     */
    long ttl(String key);

    /**
     * 删除当前数据库中的所有Key.
     */
    void flushdb();

    /**
     * 设置bit.
     *
     * @param key    key
     * @param offset offset
     * @param value  值
     * @return 原来的值
     */
    boolean setBit(String key, long offset, boolean value);

    /**
     * 获取指定偏移bit的值.
     *
     * @param key    key
     * @param offset offset
     * @return 指定偏移的值
     */
    boolean getBit(String key, long offset);

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 清空DB
Dew.cluster.cache.flushdb();
// 删除key
Dew.cluster.cache.del("n_test");
// 判断是否存在
Dew.cluster.cache.exists("n_test");
// 设置值
Dew.cluster.cache.set("n_test", "{\"name\":\"jzy\"}", 1);
// 获取值并转成Json
$.json.toJson(Dew.cluster.cache.get("n_test"));</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Dew的缓存默认只实现了String、List、Set、Hash等结构常用的、时间复杂度低的操作，
如需要的操作Dew没有提供可使用Spring Boot Data Redis原生的<code>RedisTemplate&lt;String,String&gt;</code>
</td>
</tr>
</table>
</div>
<div id="framework-user-manual-cluster-redis-mutli-connection" class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">多实例支持</div>
Redis的Cache实现支持多连接实例，目前只支持Lettuce client。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre># 配置
spring
    redis:
        host:       # Redis主机
        port:       # Redis端口
        ...
        multi:      # &lt;- 多实例支持
          &lt;key&gt;:    # 实例名称
                    # 可用 Dew.cluster.caches.instance(&lt;key&gt;) 获取
                    # 同时可以用 @Autowired &lt;Key&gt;RedisTemplate 获取Bean
            host:   # Redis主机
            port:   # Redis端口
            ...

# 使用
Dew.cluster.caches.instance("&lt;key&gt;").XXX

# 示例
# 使用key为auth的连接
Dew.cluster.caches.instance("auth").set("token", "xxxxx");
# 使用默认连接
Dew.cluster.cache.set("name", "xxxxx")</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="分布式map"><a class="anchor" href="#分布式map"></a>分布式Map</h5>
<div class="listingblock">
<div class="title">API</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2020. the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package group.idealworld.dew.core.cluster;

import java.util.Map;
import java.util.function.Consumer;

/**
 * 分布式Map服务.
 *
 * @param &lt;M&gt; 值的类型
 * @author gudaoxuri
 */
public interface ClusterMap&lt;M&gt; {

    /**
     * 添加Item，同步实现.
     *
     * @param key   key
     * @param value value
     */
    void put(String key, M value);

    /**
     * 添加Item，异步实现.
     *
     * @param key   key
     * @param value value
     */
    void putAsync(String key, M value);

    /**
     * 添加不存在的Item，同步实现.
     *
     * @param key   key
     * @param value value
     */
    void putIfAbsent(String key, M value);

    /**
     * 指定Key是否存在.
     *
     * @param key key
     * @return 是否存在 boolean
     */
    boolean containsKey(String key);

    /**
     * 获取所有Item.
     *
     * @return 所有Item all
     */
    Map&lt;String, M&gt; getAll();

    /**
     * 获取指定key的value.
     *
     * @param key key
     * @return 对应的value m
     */
    M get(String key);

    /**
     * 删除指定key的Item，同步实现.
     *
     * @param key key
     */
    void remove(String key);

    /**
     * 删除指定key的Item，异步实现.
     *
     * @param key key
     */
    void removeAsync(String key);

    /**
     * 清空Map.
     */
    void clear();

    /**
     * 注册新增Item时要执行的函数.
     * &lt;p&gt;
     * 目前只支持Hazelcast实现
     *
     * @param fun 执行的函数
     * @return the cluster map
     */
    default ClusterMap&lt;M&gt; regEntryAddedEvent(Consumer&lt;EntryEvent&lt;M&gt;&gt; fun) {
        return this;
    }

    /**
     * 注册删除Item时要执行的函数.
     * &lt;p&gt;
     * 目前只支持Hazelcast实现
     *
     * @param fun 执行的函数
     * @return the cluster map
     */
    default ClusterMap&lt;M&gt; regEntryRemovedEvent(Consumer&lt;EntryEvent&lt;M&gt;&gt; fun) {
        return this;
    }

    /**
     * 注册更新Item时要执行的函数.
     * &lt;p&gt;
     * 目前只支持Hazelcast实现
     *
     * @param fun 执行的函数
     * @return the cluster map
     */
    default ClusterMap&lt;M&gt; regEntryUpdatedEvent(Consumer&lt;EntryEvent&lt;M&gt;&gt; fun) {
        return this;
    }

    /**
     * 注册清空Map时要执行的函数.
     * &lt;p&gt;
     * 目前只支持Hazelcast实现
     *
     * @param fun 执行的函数
     * @return the cluster map
     */
    default ClusterMap&lt;M&gt; regMapClearedEvent(VoidProcessFun fun) {
        return this;
    }

    /**
     * Entry event.
     *
     * @param &lt;V&gt; the type parameter
     */
    class EntryEvent&lt;V&gt; {
        private String key;
        private V oldValue;
        private V value;

        /**
         * Gets key.
         *
         * @return the key
         */
        public String getKey() {
            return key;
        }

        /**
         * Sets key.
         *
         * @param key the key
         */
        public void setKey(String key) {
            this.key = key;
        }

        /**
         * Gets old value.
         *
         * @return the old value
         */
        public V getOldValue() {
            return oldValue;
        }

        /**
         * Sets old value.
         *
         * @param oldValue the old value
         */
        public void setOldValue(V oldValue) {
            this.oldValue = oldValue;
        }

        /**
         * Gets value.
         *
         * @return the value
         */
        public V getValue() {
            return value;
        }

        /**
         * Sets value.
         *
         * @param value the value
         */
        public void setValue(V value) {
            this.value = value;
        }

    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 创建指定名为test_obj_map的分布Map实例
ClusterMap&lt;TestMapObj&gt; mapObj = Dew.cluster.map.instance("test_obj_map", TestMapObj.class);
// 清空记录
mapObj.clear();
TestMapObj obj = new TestMapObj();
obj.a = "测试";
// 添加一条记录
mapObj.put("test", obj);
// 获取记录
mapObj.get("test");</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="分布式锁"><a class="anchor" href="#分布式锁"></a>分布式锁</h5>
<div class="listingblock">
<div class="title">API</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2020. the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package group.idealworld.dew.core.cluster;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * 分布式锁服务.
 *
 * @author gudaoxuri
 */
public interface ClusterLock {

    Logger logger = LoggerFactory.getLogger(ClusterLock.class);

    /**
     * 尝试加锁，加锁成功后执行对应的函数，执行完成自动解锁.
     * &lt;p&gt;
     * 推荐使用 {@link #tryLockWithFun(long waitMillSec, long leaseMillSec, VoidProcessFun fun)}
     *
     * @param fun 加锁成功后执行的函数
     */
    void tryLockWithFun(VoidProcessFun fun) throws Exception;

    /**
     * 尝试加锁，加锁成功后执行对应的函数，执行完成自动解锁.
     * &lt;p&gt;
     * 推荐使用 {@link #tryLockWithFun(long waitMillSec, long leaseMillSec, VoidProcessFun fun)}
     *
     * @param fun 加锁成功后执行的函数
     */
    void tryLockWithFun(long waitMillSec, VoidProcessFun fun) throws Exception;

    /**
     * 尝试加锁，加锁成功后执行对应的函数，执行完成自动解锁.
     *
     * @param waitMillSec  等待毫秒数
     * @param leaseMillSec 锁释放毫秒数
     * @param fun          加锁成功后执行的函数
     */
    void tryLockWithFun(long waitMillSec, long leaseMillSec, VoidProcessFun fun) throws Exception;

    /**
     * 尝试加锁.
     * &lt;p&gt;
     * 推荐使用 {@link #tryLock(long waitMillSec, long leaseMillSec)}
     */
    boolean tryLock();

    /**
     * 尝试加锁.
     * &lt;p&gt;
     * 推荐使用 {@link #tryLock(long waitMillSec, long leaseMillSec)}
     *
     * @param waitMillSec 等待毫秒数
     */
    boolean tryLock(long waitMillSec) throws InterruptedException;

    /**
     * 尝试加锁.
     *
     * @param waitMillSec  等待毫秒数
     * @param leaseMillSec 锁释放毫秒数，估计值，实际释放时间视各中间件的配置及执行环境会有一定偏差
     */
    boolean tryLock(long waitMillSec, long leaseMillSec) throws InterruptedException;

    /**
     * 解锁操作，只有加锁的实例及线程才能解锁.
     */
    boolean unLock();

    /**
     * 强制解锁，不用匹配加锁的实例与线程.
     * &lt;p&gt;
     * 谨慎使用
     */
    void delete();

    /**
     * 判断是否有锁.
     */
    boolean isLocked();

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 创建指定名为test_lock的分布锁实例
ClusterLock lock = Dew.cluster.lock.instance("test_lock");
// tryLock 示例，等待0ms，忘了手工unLock或出异常时1s后自动解锁
if (lock.tryLock(0, 1000)) {
    try {
        // 已加锁，执行业务方法
    } finally {
        // 手工解锁
        lock.unLock();
    }
}
// 上面的示例可用 tryLockWithFun 简化
lock.tryLockWithFun(0, 1000, () -&gt; {
    // 已加锁，执行业务方法，tryLockWithFun会将业务方法包裹在try-finally中，无需手工解锁
});</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="mq"><a class="anchor" href="#mq"></a>MQ</h5>
<div class="listingblock">
<div class="title">API</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2020. the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package group.idealworld.dew.core.cluster;

import group.idealworld.dew.core.cluster.dto.MessageWrap;

import java.util.Map;
import java.util.function.Consumer;

/**
 * MQ服务.
 *
 * @author gudaoxuri
 */
public interface ClusterMQ {

    /**
     * MQ 发布订阅模式 之 发布.
     * &lt;p&gt;
     * 请确保发布之前 topic 已经存在
     *
     * @param topic   主题
     * @param message 消息内容
     * @param header  消息头
     * @param confirm 是否需要确认
     * @return 是否发布成功 ，此返回值仅在 confirm 模式下才能保证严格准确！
     */
    boolean publish(String topic, String message, Map&lt;String, Object&gt; header, boolean confirm);

    /**
     * MQ 发布订阅模式 之 发布.
     * &lt;p&gt;
     * 请确保发布之前 topic 已经存在
     *
     * @param topic   主题
     * @param message 消息内容
     * @param header  消息头
     */
    default void publish(String topic, String message, Map&lt;String, Object&gt; header) {
        publish(topic, message, header, false);
    }

    /**
     * MQ 发布订阅模式 之 发布.
     * &lt;p&gt;
     * 请确保发布之前 topic 已经存在
     *
     * @param topic   主题
     * @param message 消息内容
     */
    default void publish(String topic, String message) {
        publish(topic, message, null);
    }


    /**
     * MQ 发布订阅模式 之 订阅.
     * &lt;p&gt;
     * 非阻塞方式
     *
     * @param topic    主题
     * @param consumer 订阅处理方法
     */
    void subscribe(String topic, Consumer&lt;MessageWrap&gt; consumer);

    /**
     * MQ 请求响应模式 之 请求.
     *
     * @param address 请求地址
     * @param message 消息内容
     * @param header  消息头
     * @param confirm 是否需要确认
     * @return 是否发布成功 ，此返回值仅在 confirm 模式下才能保证严格准确！
     */
    boolean request(String address, String message, Map&lt;String, Object&gt; header, boolean confirm);

    /**
     * MQ 请求响应模式 之 请求.
     *
     * @param address 请求地址
     * @param message 消息内容
     * @param header  消息头
     */
    default void request(String address, String message, Map&lt;String, Object&gt; header) {
        request(address, message, header, false);
    }


    /**
     * MQ 请求响应模式 之 请求.
     *
     * @param address 请求地址
     * @param message 消息内容
     */
    default void request(String address, String message) {
        request(address, message, null);
    }


    /**
     * MQ 请求响应模式 之 响应.
     * &lt;p&gt;
     * 非阻塞方式
     *
     * @param address  请求对应的地址
     * @param consumer 响应处理方法
     */
    void response(String address, Consumer&lt;MessageWrap&gt; consumer);

    /**
     * Gets mq header.
     *
     * @param name the name
     * @return the mq header
     */
    default Map&lt;String, Object&gt; getMQHeader(String name) {
        return Cluster.getMQHeader(name);
    }

    /**
     * Sets mq header.
     *
     * @param name   the name
     * @param header the header
     * @return the mq header
     */
    default Map&lt;String, Object&gt; setMQHeader(String name, Map&lt;String, Object&gt; header) {
        return Cluster.setMQHeader(name, header);
    }

    /**
     * Is header support.
     *
     * @return the result
     */
    boolean supportHeader();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// pub-sub
Dew.cluster.mq.subscribe("test_pub_sub", message -&gt;
        logger.info("pub_sub&gt;&gt;" + message.getBody()));
Dew.cluster.mq.publish("test_pub_sub", "msgA",new HashMap&lt;String, Object&gt;() {
      {
          put("h", "001");
      }
  });
Dew.cluster.mq.publish("test_pub_sub", "msgB");
// req-resp
Dew.cluster.mq.response("test_rep_resp", message -&gt;
        logger.info("req_resp&gt;&gt;" + message.getBody()));
Dew.cluster.mq.request("test_rep_resp", "msg1",new HashMap&lt;String, Object&gt;() {
      {
          put("h", "001");
      }
  });
Dew.cluster.mq.request("test_rep_resp", "msg2");</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
发布订阅模式时，发布前 <code>topic</code> 必须已经存在，可先使用 <code>subscribe</code> 订阅，此操作会自动创建 <code>topic</code> 。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>Rabbit</code> 实现支持单条 <code>confirm</code> 模式。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">MQ的HA功能</div>
<p>MQ的HA（高可用）支持，默认为禁用，可通过<code>dew.cluster.config.ha-enabled=true</code>启用。</p>
</div>
<div class="paragraph">
<p>Dew的MQ仅在数据处理完成后才做commit，这限制了对同一个队列只能串行处理，
MQ的HA开启后，您可以以多线程的方式消费消息，处理过程中如发生服务宕机重启后仍可从未处理完成的消息开始消费。</p>
</div>
</div>
<div class="sect4">
<h5 id="领导者选举"><a class="anchor" href="#领导者选举"></a>领导者选举</h5>
<div class="listingblock">
<div class="title">API</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2020. the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package group.idealworld.dew.core.cluster;

/**
 * 领导者选举服务.
 *
 * @author gudaoxuri
 */
public interface ClusterElection {

    /**
     * 当前工程是否是领导者.
     *
     * @return 是否是领导者
     */
    boolean isLeader();

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 实例化fun1类型的领导者选举，Redis的实现支持多类型领导者
ClusterElection electionFun1 = Dew.cluster.election.instance("fun1");
// ...
if (electionFun1.isLeader()) {
   // 当前节点是fun1类型的领导者
   // ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="统一响应"><a class="anchor" href="#统一响应"></a>3.2.5. 统一响应</h4>
<div class="paragraph">
<p><code>Dew</code> 推荐使用 <code>协议无关的响应格式</code>，此格式在 <code>方法间调用</code> <code>非HTTP协议RPC</code> <code>MQ</code> 等数据交互场景做到真正的 <code>统一响应格式</code>。
要求返回的格式为<code>Resp</code>对象，格式为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "code": "", // 响应编码，与http状态码类似，200表示成功
    "message":"", // 响应附加消息，多有于错误描述
    "body": // 响应正文
}</pre>
</div>
</div>
<div class="listingblock">
<div class="title">示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public Resp&lt;String&gt; test(){
    return Resp.success("enjoy!");
    // OR return Resp.notFound("…")/conflict("…")/badRequest("…")/…
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Resp</code>类提供了常用操作：详见 <a href="https://gudaoxuri.github.io/dew-common/#true-resp">https://gudaoxuri.github.io/dew-common/#true-resp</a></p>
</div>
<div class="paragraph">
<p><code>Dew</code>使用返回格式中的code表示操作状态码，此状态码与HTTP状态码无关，一般情况下HTTP状态码均为200，如需要降级处理时返回500。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">500 Http状态码说明</div>
<div class="paragraph">
<p><code>500</code> 状态码仅用于告诉 <code>Hystrix</code> 或其它熔断器这次请求是需要降级的错误，对于 <code>Resp</code> 中的 <code>code</code> 没有影响。</p>
</div>
<div class="paragraph">
<p><code>dew</code> 框架会把所有 <code>5xx</code>（服务端错误，需要降级） 的异常统一转换成 <code>500</code> 的Http状态码返回给调用方。</p>
</div>
<div class="paragraph">
<p><code>Resp.xxx.fallback()</code> 用于显式声明当前返回需要降级，
比如 <code>Resp.serverError("some message")</code> 不会降级，返回http状态码为200，body为 <code>{"code":"500","message":"some message","body":null}</code>，
但 <code>Resp.serverError("some message").fallback()</code> 会降级，返回http状态码为500，body为 同上。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="消息通知"><a class="anchor" href="#消息通知"></a>消息通知</h5>
<div class="paragraph">
<p><code>Dew</code> 支持发送消息到钉钉、邮件或自定义HTTP地址，默认支持对未捕获异常通知。</p>
</div>
<div class="listingblock">
<div class="title">通知配置</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml"># 格式
dew:
  notifies:
    "": # 通知的标识
      type: DD # 通知的类型，DD=钉钉 MAIL=邮件，邮件方式需要有配置spring.mail下相关的smtp信息 HTTP=自定义HTTP Hook
      defaultReceivers: # 默认接收人列表，钉钉为手机号，邮件为邮箱
      dndTimeReceivers: # 免扰时间内的接收人列表，只有该列表中的接收人才能在免扰时间内接收通知
      args: # 不同类型的参数，邮件不需要设置
        url: # type=DD表示钉钉的推送地址
             # 说明详见：https://open-doc.dingtalk.com/microapp/serverapi2/qf2nxq
             # type=HTTP表示HTTP Hook的地址
        msgType: # 仅用于type=DD，支持 text/markdown            strategy: # 通知策略
        minIntervalSec: 0 # 最小间隔的通知时间，0表示不设置，如为10则表示10s内只会发送一次
        dndTime: # 开启免扰时间，HH:mm-HH:mm 如，18:00-06:00
        forceSendTimes: 3 # 同一免扰周期间通知调用达到几次后强制发送

# 示例
dew:
  notifies:
    __DEW_ERROR__:
      type: DD
      defaultReceivers: xxxx
      args:
        url: https://oapi.dingtalk.com/robot/send?access_token=8ff65c48001c1981df7d3269
      strategy:
        minIntervalSec: 5
    sendMail:
      type: MAIL
      defaultReceivers: x@y.z
    custom:
      type: HTTP
      defaultReceivers: x@y.z
      args:
        url: https://...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">通知使用</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"># 最简单的调用
Resp&lt;Void&gt; result = Dew.notify.send("&lt;通知的标识&gt;", "&lt;通知的内容或Throwable&gt;");
# 带通知标题，标题会加上``Dew.Info.instance``
Resp&lt;Void&gt; result = Dew.notify.send("&lt;通知的标识&gt;", "&lt;通知的内容或Throwable&gt;", "&lt;通知标题&gt;");
# 加上特殊接收人列表，非免扰时间内的接收人=配置默认接收人列表+特殊接收人列表，免扰时间内的接收人=配置的免扰时间内的接收人列表
Resp&lt;Void&gt; result = Dew.notify.send("&lt;通知的标识&gt;", "&lt;通知的内容或Throwable&gt;", "&lt;通知标题&gt;", "&lt;特殊接收人列表&gt;");
# 上述三个方法都有异步的重载方法，如
Dew.notify.sendAsync("&lt;通知的标识&gt;", "&lt;通知的内容或Throwable&gt;");</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">默认通知标识</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>未捕获异常: <code><em>DEW_ERROR</em></code>，所有未捕获异常（ErrorController）调用此标识发送错误，可通过<code>dew.basic.format.error-flag</code> 修改</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>要启用以上两个通知请确保<code>dew.notifies</code>下有相应的配置。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">HTTP自定义通知格式</div>
<div class="paragraph">
<p>POST请求，Body格式为:</p>
</div>
<div class="paragraph">
<p>{
    "title": "", // 标题
    "content": "", // 内容
    "receivers": [] // 接收人列表
}</p>
</div>
<div class="paragraph">
<p>调用正常需要返回200状态码</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
消息通知由 <code>notification</code> 模块提供，<code>boot-starter</code> 集成了此模块，开发中也可以单独引用 <code>notification</code>。
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="异常处理"><a class="anchor" href="#异常处理"></a>3.2.6. 异常处理</h4>
<div class="paragraph">
<p><code>Dew</code> 会把程序没有捕获的异常统一上抛，同时框架也支持上文统一响应的异常处理：</p>
</div>
<div class="listingblock">
<div class="title">自定义异常以支持统一响应API</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/**
* 统一异常处理.
* &lt;p&gt;
* 封装任意异常到统一的格式，见下文
*
* @param &lt;E&gt;            上抛的异常类型
* @param code           异常编码
* @param ex             上抛的异常对象
* @param customHttpCode 自定义Http状态码
* @return 上抛的异常对象
*/
Dew.E.e(String code, E ex, int customHttpCode)</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">自定义异常以支持统一响应示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 业务代码捕获了一个异常
Exception someError = new IOException("xxx不存在")
// 使用统一异常处理封装
throw Dew.E.e("NBE00123",someError,200)
// 请求方得到的结果为 http状态=200，响应体：
{
    "code": "NBE00123",
    "message": "xxx不存在",
    "body": null
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上面介绍的是编码的方式将某些异常封装处理，我们也可以用配置解决：</p>
</div>
<div class="listingblock">
<div class="title">自定义异常配置，启用后此类异常均使用此模块</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">dew:
  basic:
    error-mapping:
      "[&lt;异常类名&gt;]":
        http-code: # http状态码，不存在时使用实例级http状态码
        business-code: # 业务编码，不存在时使用实例级业务编码
        message: # 错误描述，不存在时使用实例级错误描述</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">自定义异常配置示例</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">dew:
  basic:
    error-mapping:
      "java.io.IOException":
        http-code: 200
        business-code: "NBE00123"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="数据验证"><a class="anchor" href="#数据验证"></a>3.2.7. 数据验证</h4>
<div class="paragraph">
<p><code>Dew</code>集成了<code>Spring validate</code> 机制，支持针对 <code>URL</code> 及 <code>Bean</code> 的验证。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>在 java bean 中添加各项validation，支持标准<code>javax.validation.constraints</code>包下的诸如：<code>NotNull</code> ，同时框架扩展了几个检查，如：
IdNumber、Phone</p>
</li>
<li>
<p>在Controller中添加 <code>@Validated</code> 注解 ( Spring还支持@Vaild，但这一注解不支持分组 )</p>
</li>
<li>
<p>支持Spring原生分组校验</p>
</li>
<li>
<p><code>URL</code> 类型的验证必须在类头添加 <code>@Validated</code> 注解</p>
</li>
<li>
<p><code>Dew</code> 框架内置了 <code>CreateGroup</code> <code>UpdateGroup</code> 两个验证组，验证组仅是一个标识，可为任何java对象</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">数据验证示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RestController
@Api(value = "测试")
@RequestMapping(value = "/test/")
@Validated
public class WebController {

    /**
     * Valid create user dto.
     *
     * @param userDTO the user dto
     * @return the user dto
     */
    @PostMapping(value = "valid-create")
    public UserDTO validCreate(@Validated(CreateGroup.class) @RequestBody UserDTO userDTO) {
        return userDTO;
    }

    /**
     * Valid update user dto.
     *
     * @param userDTO the user dto
     * @return the user dto
     */
    @PostMapping(value = "valid-update")
    public UserDTO validUpdate(@Validated(UpdateGroup.class) @RequestBody UserDTO userDTO) {
        return userDTO;
    }

    /**
     * Valid in method.
     *
     * @param age the age
     * @return the string
     */
    @GetMapping(value = "valid-method-spring/{age}")
    public String validInMethod(@Min(value = 2, message = "age必须大于2") @PathVariable("age") int age) {
        return String.valueOf(age);
    }

    /**
     * Valid in method.
     *
     * @param phone the phone
     * @return the string
     */
    @GetMapping(value = "valid-method-own/{phone}")
    public String validInMethod(@Phone @PathVariable("phone") String phone) {
        return phone;
    }

    public static class UserDTO {

        @NotNull(groups = CreateGroup.class)
        @IdNumber(message = "身份证号错误", groups = {CreateGroup.class, UpdateGroup.class})
        private String idCard;

        @Min(value = 10, groups = {CreateGroup.class, UpdateGroup.class})
        private Integer age;

        @NotNull(groups = CreateGroup.class)
        @Phone(message = "手机号错误", groups = {CreateGroup.class, UpdateGroup.class})
        private String phone;

        // Get &amp; Set ...
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="cors支持"><a class="anchor" href="#cors支持"></a>3.2.8. CORS支持</h4>
<div class="listingblock">
<div class="title">配置</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">dew:
  security:
    cors:
      allow-origin: # 允许来源，默认 *
      allow-methods: # 允许方法，默认 POST,GET,OPTIONS,PUT,DELETE,HEAD
      allow-headers: # 允许头信息 x-requested-with,content-type</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="framework-user-manual-auth"><a class="anchor" href="#framework-user-manual-auth"></a>3.2.9. 权限认证</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:auth-example</pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>支持 <code>认证缓存</code> ，即支持将鉴权系统生成的登录信息缓存到业务系统中方便即时调用，并提供三方适配。</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">配置认证缓存</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">dew:
  security:
    token-flag: X-Dew-Token             # Token 标识
    token-kind-flag: X-Dew-Token-Kind   # Token类型 标识
    token-in-header: true               # true：token标识在 header 中，反之在url参数中
    token-hash: false                   # Token值是否需要hash，用于解决token值有特殊字符的情况
    router:                             # 路由功能
      enabled: false                    # 是否启用
      block-uri:                        # URL阻止单，支持ant风格
        &lt;Http Method&gt;: [&lt;URLs&gt;]         # URL阻止单列表，Method = all 表示所有方法
      role-auth:                        # 角色认证
        &lt;Role Code&gt;:                    # 角色编码，角色可以带租户，使用.分隔，e.g. tenant1.admin / tenant2.admin
          &lt;Http Method&gt;: [&lt;URLs&gt;]       # 只有该角色才能访问的URL，支持ant风格，支持继承与重写，Method = all 表示所有方法
    token-kinds:                        # Token类型，可为不同的Token类型设置不同的过期时间、保留的版本
      &lt;Kind&gt;:                           # Token类型名称，比如 PC/Android/... ，默认会创建名为 DEFAULT 的类型
        expire-sec: 86400               # Token 过期时间（秒）
        revision-history-limit: 0       # Token 保留的历史版本数量， 0表示不保留历史版本，即有新的登录时会删除此类型下之前所有的Token</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
认证缓存需要 <code>集群缓存</code> 服务支持，请引入相关的依赖并配置对应的连接信息等。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">basic 认证缓存接口</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 添加登录信息，optInfo封装自鉴权系统过来的登录信息
// 一般在登录认证后操作
Dew.auth.setOptInfo(OptInfo optInfo);
// 获取登录信息，要求在http请求加上token信息
Dew.context().optInfo();
// 删除登录信息
// 一般在注销登录OptInfo后操作
Dew.auth.removeOptInfo();

// 登录信息
public class OptInfo {
    // Token
    String token;
    // 账号编码
    String accountCode;
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>OptInfo</code> 为认证缓存信息的基类，使用时可以继承并扩展自己的属性。
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
使用 <code>OptInfo</code> 扩展类型时需要在工程启动时指定扩展类： <code>DewContext.setOptInfoClazz(&lt;扩展类型&gt;)</code> 。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">basic 认证缓存示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/**
 * 模拟用户注册.
 */
@PostMapping(value = "user/register")
public Resp&lt;Void&gt; register(@RequestBody User user) {
    // 实际注册处理
    user.setId($.field.createUUID());
    MOCK_USER_CONTAINER.put(user.getId(), user);
    return Resp.success(null);
}

/**
 * 模拟用户登录.
 */
@PostMapping(value = "auth/login")
public Resp&lt;String&gt; login(@RequestBody LoginDTO loginDTO) {
    // 实际登录处理
    User user = MOCK_USER_CONTAINER.values().stream().filter(u -&gt; u.getIdCard().equals(loginDTO.getIdCard())).findFirst().get();
    String token = $.field.createUUID();
    Dew.auth.setOptInfo(new OptInfoExt()
            .setIdCard(user.getIdCard())
            .setAccountCode($.field.createShortUUID())
            .setToken(token)
            .setName(user.getName())
            .setMobile(user.getPhone())
            .setRoleInfo(new HashSet&lt;&gt;() {
                {
                    add(new OptInfo.RoleInfo()
                            .setCode(userDTO.getRole())
                            .setName("..")
                    );
                }
            }));
    return Resp.success(token);
}

/**
 * 模拟业务操作.
 */
@GetMapping(value = "business/someopt")
public Resp&lt;Void&gt; someOpt() {
    // 获取登录用户信息
    Optional&lt;OptInfoExt&gt; optInfoExtOpt = Dew.auth.getOptInfo();
    if (!optInfoExtOpt.isPresent()) {
        return Resp.unAuthorized("用户认证错误");
    }
    // 登录用户的信息
    optInfoExtOpt.get();
    return Resp.success(null);
}

/**
 * 模拟用户注销.
 */
@DeleteMapping(value = "auth/logout")
public Resp&lt;Void&gt; logout() {
    // 实际注册处理
    Dew.auth.removeOptInfo();
    return Resp.success(null);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上述操作的核心是认证适配器，其接口如下：</p>
</div>
<div class="listingblock">
<div class="title">AuthAdapter</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">/*
 * Copyright 2021. the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package group.idealworld.dew.core.auth;

import group.idealworld.dew.Dew;
import group.idealworld.dew.core.auth.dto.OptInfo;

import java.util.Optional;

/**
 * 登录鉴权适配器.
 *
 * @author gudaoxuri
 */
public interface AuthAdapter {

    /**
     * 获取当前登录的操作用户信息.
     *
     * @param &lt;E&gt; 扩展操作用户信息类型
     * @return 操作用户信息
     */
    default &lt;E extends OptInfo&gt; Optional&lt;E&gt; getOptInfo() {
        return Dew.context().optInfo();
    }

    /**
     * 根据Token获取操作用户信息.
     *
     * @param &lt;E&gt;   扩展操作用户信息类型
     * @param token 登录Token
     * @return 操作用户信息
     */
    &lt;E extends OptInfo&gt; Optional&lt;E&gt; getOptInfo(String token);

    /**
     * 设置操作用户信息类型.
     *
     * @param &lt;E&gt;     扩展操作用户信息类型
     * @param optInfo 扩展操作用户信息
     */
    &lt;E extends OptInfo&gt; void setOptInfo(E optInfo);

    /**
     * 删除当前登录的操作用户信息.
     * &lt;p&gt;
     * 对指注销登录
     */
    default void removeOptInfo() {
        getOptInfo().ifPresent(optInfo -&gt; removeOptInfo(optInfo.getToken()));
    }

    /**
     * 根据Token删除操作用户信息.
     *
     * @param token 登录Token
     */
    void removeOptInfo(String token);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Dew</code> 默认实现了基于 <code>Dew.cluster.cache</code> 的适配器以支持上述功能，
对于Redis的Cache实现了 <a href="#framework-user-manual-cluster-redis-mutli-connection">多实例支持</a> ，默认优先获取key = <code><em>auth</em></code> 的连接配置，不存在时使用默认连接配置。
，项目中也可以实现自己的适配器。</p>
</div>
<div class="listingblock">
<div class="title">自定义认证适配器</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 自定义适配器
public class CustomAuthAdapter implements AuthAdapter {

 // ...

}

// 注册为Bean（可选，如果自定义适配器用到Spring功能时必须）
@Bean
public CustomAuthAdapter customAuthAdapter() {
    return new CustomAuthAdapter();
}

// 注册自定义适配器
Dew.auth = new CustomAuthAdapter() // 或 Bean实例</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="测试支持"><a class="anchor" href="#测试支持"></a>3.2.10. 测试支持</h4>
<div class="paragraph">
<p>良好的单元测试可以保证代码的高质量，单测的重要原则是内聚、无依赖，好的单测应该是"函数化"的——结果的变化只与传入参数有关。
但实际上我们会的代码往往会与数据库、缓存、MQ等外部工具交互，这会使单测的结果不可控，通常的解决方案是使用Mock，但这无行中引入了单测撰写的成本，
<code>Dew</code>使用"内嵌式"工具解决，数据库使用 <code>H2</code> ，Redis使用 <code>embedded redis</code> ，由于 <code>Dew</code> 集群的 <code>Cache</code> <code>Map</code> <code>Lock</code> <code>MQ</code> 都支持 <code>Redis</code> 实现，所以可以做到对主流操作的全覆盖。</p>
</div>
<div class="listingblock">
<div class="title">依赖</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;test-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">配置</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">dew:
  cluster: #所有集群操作都使用reids模拟
    cache: redis
    lock: redis
    map: redis
    mq: redis

spring:
  redis:
    host: 127.0.0.1
    port: 6379
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:test</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="幂等处理"><a class="anchor" href="#幂等处理"></a>3.2.11. 幂等处理</h4>
<div class="listingblock">
<div class="content">
<pre>此章节关联示例:idempotent-example</pre>
</div>
</div>
<div class="paragraph">
<p>支持HTTP和非HTTP幂等操作，对于HTTP操作，要求请求方在请求头或URL参数中加上操作ID标识，非HTTP操作由可自由指定操作类型和操作ID标识的来源。</p>
</div>
<div class="listingblock">
<div class="title">依赖</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!--引入幂等支持--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;idempotent-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">配置</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">dew:
  cluster:
    cache: redis # 启用Redis支持
  idempotent:
    default-expire-ms: 3600000 # 设置默认过期时间，1小时
    default-strategy: item # 设置默认策略，支持 bloom(Bloom Filter)和item(逐条记录)，目前只支持item
    default-opt-id-flag: __IDEMPOTENT_OPT_ID__ # 指定幂等操作ID标识，可以位于HTTP Header或请求参数中</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">HTTP操作</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@GetMapping(xxx)
// 启用幂等支持
// 请求头部或参数加上__IDEMPOTENT_OPT_ID__ = xx
@Idempotent
public void test(xxx) {
    // 业务操作
    // ...
    // 业务失败，在保证业务操作的原子性的情况下，在catch中取消幂等，并抛出异常
    DewIdempotent.cancel();
    // 手工确认
    DewIdempotent.confirm();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Idempotent</code>注解说明：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>optIdFlag：指定幂等操作ID标识，可以位于HTTP Header或请求参数中</p>
</li>
<li>
<p>expireMs：设置过期时间，单位毫秒</p>
</li>
<li>
<p>strategy：设置默认策略</p>
</li>
<li>
<p>needConfirm：设置是否需要显式确认，true时，需要进行显式确认操作: <code>DewIdempotent.confirm() 或 DewIdempotent.confirm(String optType, String optId)</code> 前者要求与请求入口在同一线程中</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">非HTTP操作</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// 初始化类型为transfer_a的幂等操作，需要手工确认，过期时间为1秒
DewIdempotent.initOptTypeInfo("transfer_a", true, 1000, StrategyEnum.ITEM);
// 第一次请求transfer_a类型下的xxxxxxx这个ID，返回不存在，表示可以下一步操作
Assert.assertEquals(StatusEnum.NOT_EXIST, DewIdempotent.process("transfer_a", "xxxxxxx"));
// 第二次请求transfer_a类型下的xxxxxxx这个ID，返回未确认，表示上次操作还在进行中
Assert.assertEquals(StatusEnum.UN_CONFIRM, DewIdempotent.process("transfer_a", "xxxxxxx"));
// 确认操作完成
DewIdempotent.confirm("transfer_a", "xxxxxxx");
// 第三次请求transfer_a类型下的xxxxxxx这个ID，返回已确认，但未过期，仍不能操作
Assert.assertEquals(StatusEnum.CONFIRMED, DewIdempotent.process("transfer_a", "xxxxxxx"));
// 延时1秒
Thread.sleep(1000);
// 再次请求transfer_a类型下的xxxxxxx这个ID，返回不存在（上次请求已过期），表示可以下一步操作
Assert.assertEquals(StatusEnum.NOT_EXIST, DewIdempotent.process("transfer_a", "xxxxxxx"));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dew_sdk_插件"><a class="anchor" href="#dew_sdk_插件"></a>3.2.12. Dew SDK 插件</h4>
<div class="paragraph">
<p>本插件为Dew微服务体系的组成部分，用于SDK的自动生成并上传到Maven仓库。</p>
</div>
<div class="sect4">
<h5 id="使用"><a class="anchor" href="#使用"></a>使用</h5>
<div class="olist arabic">
<div class="title">Dew体系下的使用</div>
<ol class="arabic">
<li>
<p>使用OpenAPI V3规范（By Swagger）添加API注解</p>
</li>
<li>
<p>执行 <code>mvn deploy -P release</code></p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">非Dew体系下的使用</div>
<ol class="arabic">
<li>
<p>使用OpenAPI V3规范（By Swagger）添加API注解</p>
</li>
<li>
<p>在项目POM中添加本插件</p>
</li>
<li>
<p>执行项目自定义的 <code>mvn deploy xx</code> （需要指定部署的仓库地址）</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="配置"><a class="anchor" href="#配置"></a>配置</h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">名称</th>
<th class="tableblock halign-left valign-top">默认值</th>
<th class="tableblock halign-left valign-top">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dew_sdk_gen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否生成SDK</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dew_sdk_release_skip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否跳过SDK发布</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dew_main_class</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Main方法所在Class（包名+类名），为空时启用自动发现功能</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dew_sdk_gen_openapi_path</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">自定义http的open API路径，为空时通过单元测试自动生成</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dew_sdk_gen_lang</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SDK的语言</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
目前仅支持java，后续会集成更多语言。
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="核心逻辑"><a class="anchor" href="#核心逻辑"></a>核心逻辑</h5>
<div class="olist arabic">
<div class="title">OpenAPI文件生成</div>
<ol class="arabic">
<li>
<p>在 maven phase = validate 时触发</p>
</li>
<li>
<p>如果 dew_sdk_gen_openapi_path 存在，则下载 OpenAPI 文件到 dew-sdkgen 目录，结束</p>
</li>
<li>
<p>如果 dew_main_class 不存在，则查找 src 下 main class 文件，返回 main class 所在的包</p>
</li>
<li>
<p>以 testFile.mustache 为模板，注入 main class 等变量生成名为 DewSDKGenTest 的测试类到 main class 所在的同名包下</p>
</li>
<li>
<p>在 maven phase = test 时触发单元测试，执行 DewSDKGenTest 生成 OpenAPI 文件到 dew-sdkgen 目录</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">SDK工程生成</div>
<ol class="arabic">
<li>
<p>在 maven phase = deploy 时触发</p>
</li>
<li>
<p>自定义 swagger-codegen-maven-plugin ，生成对应的SDK工程，包含了对JDK11支持、统一入口支持等自定义内容</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">SDK发布</div>
<ol class="arabic">
<li>
<p>在 maven phase = deploy 时触发</p>
</li>
<li>
<p>在 SDK工程生成 后调用 maven-invoker-plugin 插件，执行 deploy goal，并传入主工程的Maven仓库地址到 -DaltDeploymentRepository 参数，完成SDK发布</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="代码质量检查"><a class="anchor" href="#代码质量检查"></a>3.2.13. 代码质量检查</h4>
<div class="paragraph">
<p><code>Dew</code> 已集成 <code>Sonar</code> 插件，只需要在maven中配置 <code>sonar.host.url</code> 为目标地址，
然后执行 <code>mvn clean verify sonar:sonar -P qa -Dsonar.login=&lt;用户名&gt; -Dsonar.password=&lt;密码&gt;</code> 即可。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
也可以设置 <code>sonar.forceAuthentication=false</code> ，但要注意安全管控。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
使用 <code>&lt;maven.test.skip&gt;true&lt;/maven.test.skip&gt;</code> 可跳过特定模块的测试，<code>&lt;sonar.skip&gt;true&lt;/sonar.skip&gt;</code> 可跳过特定模块的Sonar检查。
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="spring_boot_hbase"><a class="anchor" href="#spring_boot_hbase"></a>Spring Boot HBase</h5>
<div class="paragraph">
<p>在集成 HBase 客户端能力的基础之上，支持 Spring Boot 配置管理、支持 Kerberos 认证。</p>
</div>
<div class="listingblock">
<div class="title">依赖</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;hbase-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">配置</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">spring:
  hbase:
    zkQuorum: localhost  # zookeeper url
    znodeParent: /hbase-secure # zookeeper znode parent
    auth:
      type: kerberos # 认证类型，默认是 simple，可选：simple 和 kerberos
      principal: # kerberos 下 principal
      keytab: # kerberos 下 keytab 路径
      hbaseMasterPrincipal: # kerberos 下 hbase master principal
      hbaseRegionServerPrincipal: # kerberos 下 hbase region server principal
      hbaseClientRetriesNumber: # hbase 客户端重试次数，默认：5
      hbaseClientOperationTimeout: # hbase 客户端超时时间，默认：300000
      hbaseClientScannerTimeoutPeriod: # hbase 客户端 scan 超时时间，默认：60000
      hbaseClientPause: # hbase 重试的休眠时间，默认：30</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">使用</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Autowired
private HBaseTemplate hbaseTemplate;

hbaseTemplate.get("table_hbase", "0002093140000000",
                "0", "reg_platform", (result, row) -&gt; Bytes.toString(result.value()));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
HBaseTemplate 其他使用方法可以详见 hbase-starter 模块下的 test 内容。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="framework-configuration"><a class="anchor" href="#framework-configuration"></a>3.3. 框架配置速查</h3>
<div class="sect3">
<h4 id="dew_参数"><a class="anchor" href="#dew_参数"></a>3.3.1. <code>Dew</code> 参数</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">dew:                                    # Dew 参数key前缀
  basic:                                # 基础配置
    name:                               # 服务名称，用于API文档显示等
    version: 1.0                        # 服务版本号，用于API文档显示等
    desc:                               # 服务描述，用于API文档显示等
    webSite:                            # 官网，用于API文档显示等
    doc:                                # 文档配置
      enabled: true                     # 是否启用默认文档配置，关闭后可自定义文档管理，默认为true
      base-package:                     # API文档要扫描的根包，多指定到 Controller 包中
      contact:                          # 联系人信息
        name:                           # 联系人姓名
        url:                            # 联系人URL
        email:                          # 联系人邮箱
    format:                             # 格式化配置
      use-unity-error: true             # 是否启用统一响应
      auto-trim-from-req: false         # 是否自动去掉请求中字符串类型的前后空格
      error-flag: __DEW_ERROR__         # 默认的通知标识
    error-mapping:                      # 自定义错误映射
      "[&lt;&gt;]":                           # 异常类名
        http-code:                      # http状态码，不存在时使用实例级http状态码
        business-code:                  # 业务编码，不存在时使用实例级业务编码
        message:                        # 错误描述，不存在时使用实例级错误描述
  cluster:                              # 集群功能
    cache: redis                        # 缓存实现
    lock: redis                         # 分布式锁实现，可选 redis/hazelcast，默认redis
    map: redis                          # 分布式Map实现，可选 redis/hazelcast，默认redis
    mq: redis                           # MQ实现，可选 redis/hazelcast/rabbit，默认redis
    election: redis                     # 领导者选举实现，可选 redis，默认redis
    config:                             # 集群相关配置
      election-period-sec: 60           # 领导者选举时间区间，默认60秒
      ha-enabled: false                 # 是否启用HA，默认为false
  notifies:                             # 通知功能
    "":                                 # 通知的标识
      type: DD                          # 通知的类型，DD=钉钉 MAIL=邮件，邮件方式需要有配置spring.mail下相关的smtp信息 HTTP=自定义HTTP Hook
      defaultReceivers:                 # 默认接收人列表，钉钉为手机号，邮件为邮箱
      dndTimeReceivers:                 # 免扰时间内的接收人列表，只有该列表中的接收人才能在免扰时间内接收通知
      args:                             # 不同类型的参数，邮件不需要设置
        url:                            # type=DD表示钉钉的推送地址
                                        # 说明详见：https://open-doc.dingtalk.com/microapp/serverapi2/qf2nxq
                                        # type=HTTP表示HTTP Hook的地址
        msgType:                        # 仅用于type=DD，支持 text/markdown
      strategy:                         # 通知策略
        minIntervalSec: 0               # 最小间隔的通知时间，0表示不设置，如为10则表示10s内只会发送一次
        dndTime:                        # 免扰时间，HH:mm-HH:mm 如，18:00-06:00
                                        # HH:mm-HH:mm，如果两个时间相等表示全天免扰，如果后者大于前者表示跨天免扰
        forceSendTimes: 3               # 同一免扰周期间通知调用达到几次后强制发送
  security:                             # 安全功能
    cors:                               # 跨域设置
      allow-origin: *                   # 允许的来源，建议修改
      allow-methods: POST,GET,OPTIONS,PUT,DELETE,HEAD
                                        # 允许的方法
      allow-headers: x-requested-with,content-type
                                        # 允许的头信息
    token-flag: X-Dew-Token             # Token 标识
    token-kind-flag: X-Dew-Token-Kind   # Token类型 标识
    token-in-header: true               # true：token标识在 header 中，反之在url参数中
    token-hash: false                   # Token值是否需要hash，用于解决token值有特殊字符的情况
    router:                             # 路由功能
      enabled: false                    # 是否启用
      block-uri:                        # URL阻止单，支持ant风格
        &lt;Http Method&gt;: [&lt;URLs&gt;]         # URL阻止单列表，Method = all 表示所有方法
      role-auth:                        # 角色认证
        &lt;Role Code&gt;:                    # 角色编码，角色可以带租户，使用.分隔，e.g. tenant1.admin / tenant2.admin
          &lt;Http Method&gt;: [&lt;URLs&gt;]       # 只有该角色才能访问的URL，支持ant风格，支持继承与重写，Method = all 表示所有方法
    token-kinds:                        # Token类型，可为不同的Token类型设置不同的过期时间、保留的版本
      &lt;Kind&gt;:                           # Token类型名称，比如 PC/Android/... ，默认会创建名为 DEFAULT 的类型
        expire-sec: 86400               # Token 过期时间（秒）
        revision-history-limit: 0       # Token 保留的历史版本数量， 0表示不保留历史版本，即有新的登录时会删除此类型下之前所有的Token
    error:                              # 错误配置
      enabled: false                    # 启用降级邮件通知，默认为false
      notify-event-types: FAILURE,SHORT_CIRCUITED,TIMEOUT,THREAD_POOL_REJECTED,SEMAPHORE_REJECTED
                                        # 通知的事件类型
      notify-include-keys:              # 需监控的方法key值，与notify-exclude-keys互斥，client类名+#+方法名，for example:  ExampleClient#deleteExe(int,String)
      notify-exclude-keys:              # 不需要监控的方法key值，与notify-include-keys互斥，client类名+#+方法名，for example:  ExampleClient#deleteExe(int,String)
  idempotent:                           # 需要引入 idempotent-starter 模块
    default-expire-ms: 3600000          # 设置默认过期时间，1小时
    default-strategy: item              # 设置默认策略，目前支持item(逐条记录)
    default-opt-id-flag: __IDEMPOTENT_OPT_ID__
                                        # 指定幂等操作ID标识，可以位于HTTP Header或请求参数中
  mw:                                   # 中间件
    mqtt:                               # MQTT集群实现
      broker:                           # Broker地址，e.g. tcp://127.0.0.1:1883
      clientId: Dew_Cluster_&lt;Cluster.instanceId&gt;
                                        # 连接客户端ID，注意一个集群内客户端ID必须唯一
      persistence:                      # 存储，默认为File，可选 memory
      userName:                         # 用户名
      password:                         # 密码
      timeoutSec:                       # 连接超时时间
      keepAliveIntervalSec:             # 心跳间隔时间
      cleanSession: true                # 是否消除Session

spring:                                 # 常用 Spring 配置
  application:
    name:                               # 项目名称,若使用Dew，请配置
  mail:                               # Mail配置
    host: smtp.163.com
    username:
    password:
    properties:
      mail:
        smtp:
          auth: true
            starttls:
              enable: true
              required: true
  redis:
    host:                           # Redis主机
    port:                           # Redis端口
    database:                       # Redis数据库
    password:                       # Redis密码
    lettuce:
      pool:                         # 连接池配置
    multi:                          # 多实例支持（Dew功能）
      &lt;key&gt;:                        # 实例名称
                                    # 可用 Dew.cluster.caches.instance(&lt;key&gt;) 获取
                                    # 同时可以用 @Autowired &lt;Key&gt;RedisTemplate 获取Bean
        host:                       # Redis主机
        port:                       # Redis端口
        ...
  rabbitmq:
    host:                           # Rabbit主机
    port:                           # Rabbit端口
    username:                       # Rabbit用户名
    password:                       # Rabbit密码
    virtual-host:                   # Rabbit VH
  hazelcast:
    username:
    password:
    addresses: ["127.0.0.1"]

server:
  port: 8081                          # 服务端口

management:
  endpoints:
    web:
      base-path: /management          # 管理路径前缀

logging:
  level:
    ROOT: INFO
    group.idealworld.dew: DEBUG                     # Dew目录日志配置
    org.springframework.jdbc.core: TRACE
                                      # Jdbc目录日志配置</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="spring_boot_核心参数"><a class="anchor" href="#spring_boot_核心参数"></a>3.3.2. <code>Spring boot</code> 核心参数</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html" class="bare">https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html</a>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="framework-best-practices"><a class="anchor" href="#framework-best-practices"></a>3.4. 框架最佳实践</h3>
<div class="sect3">
<h4 id="项目模块设计"><a class="anchor" href="#项目模块设计"></a>3.4.1. 项目模块设计</h4>
<div class="paragraph">
<p><code>Dew</code>推荐的项目结构为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>X Build Project                 // 构建工程
|- sources                      // 源码目录
|-  |- basics                   // 基础源码，为各服务工程的依赖，要求deploy到Maven仓库
|-  |-  |- parent               // 父工程，所有服务端应用的根POM
|-  |-  |- common               // 公共工程，所有服务端应用的基础依赖
|-  |-  |- common-service       // 公共服务工程，所有服务工程的根POM，自身依赖于common
|-  |-  |- &lt;...&gt;                // 其它基础工程，比如common-spark，大数据服务的基础依赖
|-  |- services                 // 服务源码，对应于一个个微服务
|-  |-  |- &lt;service 1&gt;          // 服务1工程
|-  |-  |- &lt;service ...&gt;        // 其它服务工程
|-  |- sdk                      // SDK源码，如项目需要提供SDK时建立此目录
|-  |-  |- &lt;java&gt;               // Java版本的SDK工程
|-  |-  |- &lt;js&gt;                 // JS版本的SDK工程
|-  |-  |- &lt;rest&gt;               // REST版本的SDK工程
|-  |-  |- &lt;...&gt;                // 其它语言版本的SDK工程
|-  |- terminals                // 终端源码
|-  |-  |- &lt;android&gt;            // Android APP工程
|-  |-  |- &lt;ios&gt;                // IOS APP工程
|-  |-  |- &lt;wechat&gt;             // Wechat工程
|-  |-  |- &lt;...&gt;                // 其它终端工程
|- docs                         // 文档工程，所有团队共同维护，Asciidoc方案，后文会介绍
|-  |- src
|-  |-  |- main
|-  |-  |-  |- asciidoc
|-  |-  |-  |-  |- book.adoc    // 文档主目录
|-  |-  |-  |-  |- &lt;...&gt;        // 分模块建立不同的文档文件
|-  |-  |- resources            // 文档引用资源目录，如图片、CSS
|-  |-  |-  |- images
|-  |-  |-  |-  |- &lt;...&gt;
|-  |-  |- pom.xml              // 文档工程使用Maven管理
|-  |-  |- .gitignore
|- env                          // 环境配置工程，以Spring Cloud Config为例，配置存放于Git
|-  |- application.yml
|-  |- &lt;...&gt;
|-  |- .gitignore
|- pom.xml                      // 构建工程的POM
|- .gitmodules                  // Git子模块定义，所有工程都注册到此文件中
|- .gitignore
|- README.adoc                  // 构建工程使用说明</pre>
</div>
</div>
<div class="paragraph">
<p>推荐各工程使用独立Git库，详见： <a href="https://gudaoxuri.gitbook.io/microservices-architecture/wei-fu-wu-hua-zhi-kai-fa-yu-ce-shi/code-managerment">微服务架构设计-代码管理</a></p>
</div>
</div>
<div class="sect3">
<h4 id="代码包设计"><a class="anchor" href="#代码包设计"></a>3.4.2. 代码包设计</h4>
<div class="paragraph">
<p><code>Dew</code>推荐的包结构为：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>|- X service
|-  |- src
|-  |-  |- main
|-  |-  |-  |- java
|-  |-  |-  |-  |- src
|-  |-  |-  |-  |-  |- x.y.z
|-  |-  |-  |-  |-  |-  |- XApplication <i class="conum" data-value="1"></i><b>(1)</b>
|-  |-  |-  |-  |-  |-  |- XConfig <i class="conum" data-value="2"></i><b>(2)</b>
|-  |-  |-  |-  |-  |-  |- XInitiator <i class="conum" data-value="3"></i><b>(3)</b>
|-  |-  |-  |-  |-  |-  |- controller
|-  |-  |-  |-  |-  |-  |-  |- EventController <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>XApplication : 服务启动类</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>XConfig：当前服务的配置文件（Spring Cloud格式）</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>XInitiator：当前服务启动初始化器，原则上所有与数据库、缓存、定时任务相关的初始化操作都应该从此类发起，以方便排错</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>EventController：事件处理器，名称可以更具象，原则上所有与MQ receive相关的操作都被视为交互接口，应该放到controller包下
<div class="literalblock">
<div class="content">
<pre>.示例
----
@PostConstruct
public void processTodoAddEvent() {
    // 使用Dew的集群MQ功能实现消息点对点接收
    Dew.cluster.mq.response(Constants.MQ_NOTIFY_TODO_ADD, todo -&gt; {
        logger.info("Received add todo event :" + todo);
    });
}
----</pre>
</div>
</div></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="代码质量管理"><a class="anchor" href="#代码质量管理"></a>3.4.3. 代码质量管理</h4>
<div class="paragraph">
<p>推荐使用 <code>checkstyle</code> 管理代码风格，使用方式：</p>
</div>
<div class="listingblock">
<div class="title">checkstyle使用</div>
<div class="content">
<pre># 在Maven中配置自定义的 checkstyle 文件的路径
&lt;properties&gt;
    &lt;checkstyle.config.path&gt;../../checkstyle/checkstyle.xml&lt;/checkstyle.config.path&gt;
&lt;/properties&gt;

# 使用Maven命令
mvn -P qa compile

# 也可以IDE的checkstyle插件实现</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="validated_注解"><a class="anchor" href="#validated_注解"></a>3.4.4. <code>@Validated</code> 注解</h4>
<div class="ulist">
<ul>
<li>
<p>在Spring Controller类里，<code>@Validated</code> 注解初使用会比较不易上手，在此做下总结</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>对于基本数据类型和String类型，要使校验的注解生效，需在该类上方加 <code>@Validated</code> 注解</p>
</li>
<li>
<p>对于抽象数据类型，需在形式参数前加<code>@Validated</code>注解</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Spring对抽象数据类型校验抛出异常为<code>MethodArgumentNotValidException</code>，http状态码为400，对基本数据类型校验抛出异常为<code>ConstraintViolationException</code>，http状态码为500，dew对这两种异常做了统一处理，http状态码均返回200，code为400
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="jackson_对于_java8_时间转换_springmvc_以_jackson_接收_json_数据"><a class="anchor" href="#jackson_对于_java8_时间转换_springmvc_以_jackson_接收_json_数据"></a>3.4.5. <code>jackson</code> 对于 <code>Java8</code> 时间转换（ <code>SpringMVC</code> 以 <code>jackson</code> 接收 <code>json</code> 数据）</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>对于 <code>LocalDateTime</code> 类型，需在参数上加 <code>@JsonFormat</code> 注解，如下：<code>@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss")</code></p>
</li>
<li>
<p><code>LocalDate,LocalTime,Instant</code> 等，无需配置可自行转换</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>jackson</code> 对于 <code>LocalDateTime</code> 类型的支持与其他三种类型不具有一致性，这是 <code>jackson</code> 需要优化的一个点
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="缓存处理"><a class="anchor" href="#缓存处理"></a>3.4.6. 缓存处理</h4>
<div class="paragraph">
<p><code>Spring Cache</code> 提供了很好的注解式缓存，但默认没有超时，需要根据使用的缓存容器特殊配置</p>
</div>
<div class="listingblock">
<div class="title">Redis缓存过期时间设置</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Bean
RedisCacheManager cacheManager() {
    final RedisCacheManager redisCacheManager = new RedisCacheManager(redisTemplate);
    redisCacheManager.setUsePrefix(true);
    redisCacheManager.setDefaultExpiration(&lt;过期秒数&gt;);
    return redisCacheManager;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jdbc_批量插入性能问题"><a class="anchor" href="#jdbc_批量插入性能问题"></a>3.4.7. jdbc 批量插入性能问题</h4>
<div class="paragraph">
<p>如果不开启rewriteBatchedStatements=true，那么jdbc会把批量插入当做一行行的单条处理，也就没有达到批量插入的效果</p>
</div>
<div class="listingblock">
<div class="title">jdbc配置示例</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">spring:
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql://127.0.0.1:3306/dew?useUnicode=true&amp;characterEncoding=utf-8&amp;rewriteBatchedStatements=true
    username: root
    password: 123456</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Devops-chapter"><a class="anchor" href="#Devops-chapter"></a>4. 部署运维 DevOps Chapter</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="devops-quick-start"><a class="anchor" href="#devops-quick-start"></a>4.1. DevOps快速入门</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
本文以 To-Do 项目为示例讲解 <code>Dew</code> DevOps部分的入门操作，项目地址： <a href="https://github.com/dew-ms/devops-example-todo" class="bare">https://github.com/dew-ms/devops-example-todo</a> 。
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
关于 To-Do 项目的介绍请先阅读 <a href="#framework-quick-start">框架快速入门</a>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="功能体验_2"><a class="anchor" href="#功能体验_2"></a>4.1.1. 功能体验</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
体验环境要求安装 Java(&gt;=11)、Maven、NodeJS(&gt;=8)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>目录结构如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre># ======= 前置准备 =======
# 执行dew-devops.sh根据提示创建项目
sh dew-devops.sh
# 添加本地Host映射
-
x.x.x.x todo-uat.idealworld.group
x.x.x.x todo-api-uat.idealworld.group
-
# ======= 前置准备 =======
git clone https://github.com/dew-ms/devops-example-todo.git
cd devops-example-todo
# 执行安装
mvn install -Dmaven.test.skip=true
# 部署到Kubernetes
mvn -P devops deploy -Ddew_devops_profile=uat

# 打开浏览器，输入 http://todo-uat.idealworld.group，切换到移动模式体验</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="what-for-dew-devops"><a class="anchor" href="#what-for-dew-devops"></a>4.1.2. 发生了什么？</h4>
<div class="paragraph">
<p>当执行 <code>sh dew-devops.sh</code> 创建项目时实际上做了：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>创建一个Harbor project及对应的用户，并做了权限绑定</p>
</li>
<li>
<p>创建一个kubernetes namespace</p>
</li>
<li>
<p>为这个kubernetes namespace绑定service-discovery-client角色，用于服务间发现</p>
</li>
<li>
<p>为这个kubernetes namespace创建docker-registry Secret，用于Harbor认证</p>
</li>
<li>
<p>为这个Kubernetes namespace创建Ingress，绑定服务与域名，内容类似：</p>
<div class="literalblock">
<div class="content">
<pre>apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
  name: dew-ingress
  namespace: dew-uat
spec:
  rules:
  - host: api-uat.idealworld.group
    http:
      paths:
      - backend:
          serviceName: kernel
          servicePort: 8080
        path: /
  - host: uat.dew.idealworld.group
    http:
      paths:
      - backend:
          serviceName: frontend
          servicePort: 80
        path: /</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>当执行 <code>mvn -P devops deploy -Ddew_devops_profile=uat</code> 时实际上做了：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>根据根目录的 <code>pom.xml</code> 配置找到所有的Maven模块并按依赖排序</p>
</li>
<li>
<p>对比当前的Git版本(git commit)与已部署的服务版本找到之间变更的文件</p>
</li>
<li>
<p>遍历每个Maven模块找到当前有文件变更的模块，视这些模块为要部署的模块</p>
</li>
<li>
<p>提示用户是否部署</p>
</li>
<li>
<p>根据模块对应的类型执行不同的准备操作：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>JVM服务(Spring Boot): 执行 <code>mvn package spring-boot-maven-plugin:repackage</code> 打出fatjar</p>
</li>
<li>
<p>前端工程: 执行<code>cd ./frontend &amp;&amp; npm install &amp;&amp; npm install -g @tarojs/cli &amp;&amp; set NODE_ENV=test &amp;&amp; npm run build:h5</code> 打出dist文件</p>
</li>
</ol>
</div>
</li>
<li>
<p>根据模块对应的类型执行不同的编译操作：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>JVM服务/前端工程: 执行 <code>docker build</code> 与 <code>docker push</code> 发布到 Harbor</p>
</li>
</ol>
</div>
</li>
<li>
<p>根据模块对应的类型执行不同的部署操作：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>JVM类库/Pom工程: 执行 <code>mvn deploy</code> 发布到Maven仓库，并创建 configmap 打上版本记录</p>
</li>
<li>
<p>JVM服务/前端工程: 部署 deployment 与 service 到 kuberenetes，并创建 configmap 打上版本记录</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="devops-user-manual"><a class="anchor" href="#devops-user-manual"></a>4.2. DevOps使用手册</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>Dew</code> DevOps部分的核心是由 <code>dew-maven-plugin</code> 实现。
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="devops-user-manual-import"><a class="anchor" href="#devops-user-manual-import"></a>4.2.1. 引入方式</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>若您的项目模块内部使用 <code>spring-boot-maven-plugin</code> 打包，请移除，避免容器化之后，服务启动时出现以下报错</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>...
Caused by: java.lang.reflect.InvocationTargetException
	... 1024 more
Caused by: java.lang.StackOverflowError
	at java.util.concurrent.ConcurrentHashMap.putVal(ConcurrentHashMap.java:1012)
...</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>为了保证项目的maven包正常发布，请在根pom.xml中配置<code>dependencyManagement</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="使用_dew_framework"><a class="anchor" href="#使用_dew_framework"></a>使用 <code>Dew Framework</code></h5>
<div class="paragraph">
<p>如果您的项目使用 <code>Dew Framework</code> 构建则只要确保引入了 <code>parent-starter</code> 即可。</p>
</div>
</div>
<div class="sect4">
<h5 id="不使用_dew_framework"><a class="anchor" href="#不使用_dew_framework"></a>不使用 <code>Dew Framework</code></h5>
<div class="paragraph">
<p><code>Dew DevOps</code> 完全可以独立于 <code>Dew Framework</code> 使用，只需要在项目的父POM中加上如下配置即可。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;profile&gt;
    &lt;id&gt;devops&lt;/id&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
                &lt;artifactId&gt;dew-maven-plugin&lt;/artifactId&gt;
                &lt;!--生产环境请选择合适的版本!--&gt;
                &lt;version&gt;${dew.version}&lt;/version&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;init&lt;/goal&gt;
                            &lt;goal&gt;release&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/profile&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="支持的项目类型"><a class="anchor" href="#支持的项目类型"></a>4.2.2. 支持的项目类型</h4>
<div class="paragraph">
<p>目前支持以下项目类型：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Spring Boot/Cloud</code> 发布到 <code>Kubernetes</code></p>
</li>
<li>
<p><code>NodeJS</code> 发布到 <code>Kubernetes</code></p>
</li>
<li>
<p><code>JVM Libraries</code> 发布到 <code>Maven Repository</code></p>
</li>
<li>
<p><code>POM</code> 发布到 <code>Maven Repository</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="nodejs项目的特殊处理"><a class="anchor" href="#nodejs项目的特殊处理"></a>4.2.3. NodeJS项目的特殊处理</h4>
<div class="paragraph">
<p>NodeJS项目需要添加Maven项目。</p>
</div>
<div class="listingblock">
<div class="title">处理步骤</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- 1. 添加pom.xml文件，格式如下 --&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;!-- parent要最终指向带有 profile为 devops 的父pom，比如 parent-starter --&gt;
  &lt;parent&gt;
    ...
  &lt;/parent&gt;

  &lt;groupId&gt;...&lt;/groupId&gt;
  &lt;artifactId&gt;...&lt;/artifactId&gt;
  &lt;packaging&gt;pom&lt;/packaging&gt;

  &lt;!-- 如果前端工程是原生NodeJS启动方式，请在pom中添加一下配置，如果前端工程是打包成静态文件的方式则不需要添加 --&gt;
  &lt;!--  默认配置此项的NodeJS项目的端口为3000，如需修改端口，请添加.dew配置文件，设置app.port为指定值。--&gt;
  &lt;properties&gt;
    &lt;frontend.package.type&gt;NATIVE&lt;/frontend.package.type&gt;
  &lt;/properties&gt;

  ...
&lt;/project&gt;

&lt;!-- 2. 将此项目做为module引入 --&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pom.xml示例</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!--
  ~ Copyright 2021. the original author or authors.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  --&gt;

&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

  &lt;parent&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;parent-starter&lt;/artifactId&gt;
    &lt;version&gt;3.0.0-Beta3&lt;/version&gt;
  &lt;/parent&gt;

  &lt;groupId&gt;group.idealworld.dew.devops.it&lt;/groupId&gt;
  &lt;artifactId&gt;todo-frontend&lt;/artifactId&gt;
  &lt;packaging&gt;pom&lt;/packaging&gt;

  &lt;properties&gt;
    &lt;sonar.skip&gt;true&lt;/sonar.skip&gt;
  &lt;/properties&gt;

  &lt;repositories&gt;
    &lt;repository&gt;
      &lt;id&gt;central&lt;/id&gt;
      &lt;url&gt;https://repo.maven.apache.org/maven2&lt;/url&gt;
    &lt;/repository&gt;
    &lt;repository&gt;
      &lt;id&gt;oss-public&lt;/id&gt;
      &lt;url&gt;https://oss.sonatype.org/content/groups/public&lt;/url&gt;
    &lt;/repository&gt;
    &lt;repository&gt;
      &lt;id&gt;oss-snapshot&lt;/id&gt;
      &lt;url&gt;https://oss.sonatype.org/content/repositories/snapshots&lt;/url&gt;
      &lt;snapshots&gt;
        &lt;enabled&gt;true&lt;/enabled&gt;
        &lt;checksumPolicy&gt;warn&lt;/checksumPolicy&gt;
      &lt;/snapshots&gt;
    &lt;/repository&gt;
  &lt;/repositories&gt;

&lt;/project&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="项目配置"><a class="anchor" href="#项目配置"></a>4.2.4. 项目配置</h4>
<div class="listingblock">
<div class="title">项目初始化</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -O https://raw.githubusercontent.com/gudaoxuri/dew/master/devops/sh/dew-devops.sh
sh dew-devops.sh
# 选择对应操作，根据提示操作即可
# 选择 1 进行集群初始化
# 选择 2 安装 Gitlab runner
# 选择 3 创建项目：为项目创建namespace、ingress、拉取镜像的secret；对应的 Harbor 账户和镜像仓库等</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
如使用Jenkins进行部署，可跳过选项2，详见：<a href="#dew-jenkins-pipeline">Dew Jenkins Pipeline 部署</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Dew和Maven的配置</div>
<p>见：<a href="#devops-configuration">[devops-configuration]</a></p>
</div>
</div>
<div class="sect3">
<h4 id="打包部署"><a class="anchor" href="#打包部署"></a>4.2.5. 打包部署</h4>
<div class="paragraph">
<p>用于部署一个项目下的多个应用，此命令多在项目根目录下执行。</p>
</div>
<div style='position:relative; padding-bottom:calc(64.51% + 44px)'><iframe src='https://gfycat.com/ifr/WellwornAmbitiousBalloonfish' frameborder='0' scrolling='no' width='100%' height='100%' style='position:absolute;top:0;left:0;' allowfullscreen></iframe></div>
<div class="listingblock">
<div class="title">命令</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 基础命令
mvn -P devops deploy

# ====================== 附加参数 ======================
# dew_devops_profile                           # 指定的环境
# dew_devops_kube_config                       # Kubernetes Base64 后的配置，使用 ``echo $(cat ~/.kube/config | base64) | tr -d " "`` 获取
# dew_devops_docker_host                       # Dockerd的Host e.g. tcp://dockerd.dew.idealworld.group:2375
# dew_devops_docker_registry_url               # Docker Registry Url  e.g. https://harbor.dew.idealworld.group/v2
# dew_devops_docker_registry_username          # Docker Registry 用户名
# dew_devops_docker_registry_password          # Docker Registry 密码
# dew_devops_assignation_projects              # 指定部署应用artifactId  多个以逗号分隔
# dew_devops_quiet                             # 是否静默处理</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
在CI/CD工具中附加参数的kubernetes、docker相关参数应作为变量配置到执行器中，对应用本身不可见。
</td>
</tr>
</table>
</div>
<div class="ulist">
<div class="title">核心流程</div>
<ul>
<li>
<p>依赖排序，使用Maven自身的Reactor机制为项目中的各应用（模块）做依赖排序</p>
</li>
<li>
<p>配置装配，根据 <a href="#devops-configuration-dew-inheritance-rules">继承规则</a> 完成配置组装</p>
</li>
<li>
<p>部署探测，用于确定要部署哪些应用</p>
<div class="ulist">
<ul>
<li>
<p>命令优先，如指定部署应用( <code>dew_devops_assignation_projects</code> ) 则短路后续探测</p>
</li>
<li>
<p>配置次之，如配置中指定了 <code>skip: true</code> 则视之为不需要部署的应用</p>
</li>
<li>
<p>版本比对，比对已部署的各应用版本与当前各应用的代码，找到有代码变更的应用，视之为要部署的应用</p>
</li>
<li>
<p>依赖传递分析，分析没有代码变更的应用，如其依赖包有变更（比如依赖了某些SNAPSHOT的模块）时这些应用也被视为要部署的应用</p>
</li>
</ul>
</div>
</li>
<li>
<p>编译准备，根据配置装配时分析到的应用类型，为不同应用类型执行不同的编译方案</p>
<div class="ulist">
<ul>
<li>
<p><code>Spring Boot</code> 应用需要执行 <code>repackage</code> 以打出 <code>fatjar</code></p>
</li>
<li>
<p><code>NodeJS</code> 应用需要执行对应的 <code>node</code> 命令完成打包</p>
</li>
</ul>
</div>
</li>
<li>
<p>单元测试（可通过 <code>-Dmaven.test.skip=true</code> 跳过）</p>
</li>
<li>
<p>发布部署，根据配置装配时分析到的部署类型，为不同部署类型执行不同的发布方案</p>
<div class="ulist">
<ul>
<li>
<p><code>Maven</code> 方式直接使用 <code>mvn deploy</code></p>
</li>
<li>
<p><code>Kubernetes</code> 方式先编译 <code>Docker Image</code> 并上传到 <code>Registry</code> ，再部署到 <code>Kubernetes</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>版本处理，部署完成后打上当前版本号</p>
</li>
<li>
<p>结果通知，发送钉钉或HTTP请求完成结果通知</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">版本重用模式</div>
<p>一般项目都会要求生产环境的代码要与预发/UAT环境最后一次验收通过的代码保持一致，具体到容器中即要保证两者的 <code>Docker Image</code> 相同。</p>
</div>
<div class="paragraph">
<p>版本重用模式可以实现部署时重用某一环境 <code>Docker Image</code> 的要求。其核心流程如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>重用判定，以一套规则判断当前是否在重用模式下，也可使用 <code>disableReuseVersion: true/false , reuseLastVersionFromProfile: &lt;目标环境名称&gt;</code> 指定是否是重用模式</p>
</li>
<li>
<p>镜像获取，从目标环境获取镜像并上传到当前环境的 <code>Registry</code> 中</p>
</li>
<li>
<p>后续操作同普通模式的流程</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">并行部署</div>
<p><code>Dew</code> 支持使用Maven的 <code>-T </code> 实现并行编译部署，例如： <code>mvn -T 1C deploy</code></p>
</div>
<div id="devops-user-manual-release-skip" class="paragraph">
<div class="title">不需要部署的应用处理</div>
<p><code>Dew</code> 会自行判断应用是否需要部署，对于不需要部署的应用为加速执行会设置一系列的skip，<br>
部署执行的是 <a href="https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html">Default Lifecycle</a> ，<br>
默认包含了如下插件的skip：<br>
. Core plugins（clean、compiler、deploy、failsafe、install、resources、site、surefire）
. Packaging types/tools（war、jar、source）
. Reporting plugins（checkstyle）
. Tools（assembly、dependency、gpg）</p>
</div>
<div class="paragraph">
<p>同时 <code>Dew</code> 提供了 <code>dew.devops.skip</code> ，用户可自行添加到其它插件、环境中。</p>
</div>
<div class="listingblock">
<div class="title">dew.devops.skip使用示例</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- 动态跳过特定插件 --&gt;
&lt;plugin&gt;
     &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
     &lt;artifactId&gt;maven-antrun-plugin&lt;/artifactId&gt;
     &lt;configuration&gt;
         &lt;skip&gt;${dew.devops.skip}&lt;/skip&gt;
     &lt;/configuration&gt;
&lt;/plugin&gt;

&lt;!--
  并不是所有插件都提供了skip配置（比如maven-shade-plugin），这时可以使用profile + activation的方式解决

  1. 定义一个profile，id随意
  2. activation &gt; property 中添加 name 为 dew.devops.skip , value 为 !true 的属性
  3. 添加需要动态skip的内容，可以是插件、依赖、属性等
--&gt;
&lt;profile&gt;
    &lt;id&gt;devops-ext&lt;/id&gt;
    &lt;activation&gt;
        &lt;property&gt;
            &lt;name&gt;dew.devops.skip&lt;/name&gt;
            &lt;value&gt;!true&lt;/value&gt;
        &lt;/property&gt;
    &lt;/activation&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
                ...
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/profile&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">使用 <code>javaagent</code> 动态跳过不需要部署的应用</div>
<p>详见 <a href="#dew-devops-maven-agent">[dew-devops-maven-agent]</a></p>
</div>
</div>
<div class="sect3">
<h4 id="版本回滚"><a class="anchor" href="#版本回滚"></a>4.2.6. 版本回滚</h4>
<div class="paragraph">
<p>用于回滚某一个应用，此命令在要回滚的应用目录下执行。</p>
</div>
<div class="listingblock">
<div class="title">命令</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 基础命令
mvn -P devops dew:rollback

# ====================== 附加参数 ======================
# dew_devops_version_history                    # 是否显示发布的历史版本，为true时，只显示历史版本信息，不进行回滚。默认为false。
# dew_devops_rollback_version                  # 指定版本进行回滚。为空时使用交互式回滚方式。
# dew_devops_assignation_projects              # 指定回滚的应用artifactId，多个以逗号分隔。
# dew_devops_quiet                             # 是否静默处理
# dew_devops_profile                           # 指定的环境
# dew_devops_kube_config                       # Kubernetes Base64 后的配置，使用 echo $(cat ~/.kube/config | base64) | tr -d " " 获取
# dew_devops_docker_host                       # Dockerd的Host e.g. tcp://dockerd.dew.idealworld.group:2375
# dew_devops_docker_registry_url               # Docker Registry Url  e.g. https://harbor.dew.idealworld.group/v2
# dew_devops_docker_registry_username          # Docker Registry 用户名
# dew_devops_docker_registry_password          # Docker Registry 密码</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
在CI/CD工具中附加参数的kubernetes、docker相关参数应作为变量配置到执行器中，对应用本身不可见。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="应用卸载"><a class="anchor" href="#应用卸载"></a>4.2.7. 应用卸载</h4>
<div class="paragraph">
<p>用于卸载某一个应用，但不会删除其对应的版本信息，此命令在要卸载的应用目录下执行。</p>
</div>
<div class="listingblock">
<div class="title">命令</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 基础命令
mvn -P devops dew:unrelease

# ====================== 附加参数 ======================
# dew_devops_assignation_projects              # 指定卸载的应用artifactId  多个以逗号分隔
# dew_devops_profile                           # 指定的环境
# dew_devops_kube_config                       # Kubernetes Base64 后的配置，使用 ``echo $(cat ~/.kube/config | base64) | tr -d " "`` 获取</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="日志查看"><a class="anchor" href="#日志查看"></a>4.2.8. 日志查看</h4>
<div class="paragraph">
<p>用于查看某一个应用的日志，此命令在要查看日志的应用目录下执行。</p>
</div>
<div class="listingblock">
<div class="title">命令</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 基础命令
mvn -P devops dew:log

# ====================== 附加参数 ======================
# dew_devops_profile                           # 指定的环境
# dew_devops_kube_config                       # Kubernetes Base64 后的配置，使用 ``echo $(cat ~/.kube/config | base64) | tr -d " "`` 获取
# dew_devops_podName                           # 要使用的Pod名称，如不填写当存在多个Pod时会要求用户选择
# dew_devops_log_follow                        # 是否滚动查看日志</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="伸缩扩展"><a class="anchor" href="#伸缩扩展"></a>4.2.9. 伸缩扩展</h4>
<div class="paragraph">
<p>用于伸缩某一个应用，此命令在要伸缩的应用目录下执行。</p>
</div>
<div class="listingblock">
<div class="title">命令</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 基础命令
mvn -P devops dew:scale

# ====================== 附加参数 ======================
# dew_devops_scale_replicas                    # 伸缩Pod数量
# dew_devops_scale_auto                        # 是否启用自动伸缩
# dew_devops_scale_auto_minReplicas            # 自动伸缩Pod数下限
# dew_devops_scale_auto_maxReplicas            # 自动伸缩Pod数上限
# dew_devops_scale_auto_cpu_averageUtilization # 自动伸缩条件：CPU平均使用率标识</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>dew_devops_scale_auto: false</code>（默认情况） 时 <code>dew_devops_scale_replicas</code> 为必要参数，反之另几个参数为必要参数。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="应用刷新"><a class="anchor" href="#应用刷新"></a>4.2.10. 应用刷新</h4>
<div class="paragraph">
<p>用于刷新重启某一个应用，此命令在要重启的应用目录下执行。</p>
</div>
<div class="listingblock">
<div class="title">命令</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 基础命令
mvn -P devops dew:refresh

# ====================== 附加参数 ======================
# dew_devops_assignation_projects              # 指定刷新的应用artifactId  多个以逗号分隔</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="应用远程调试"><a class="anchor" href="#应用远程调试"></a>4.2.11. 应用远程调试</h4>
<div class="paragraph">
<p>用于远程调试服务，此命令在要调试的应用目录下执行。请结合<code>-Dew_devops_assignation_projects=</code>指定服务名进行调试。</p>
</div>
<div class="listingblock">
<div class="title">命令</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 基础命令
mvn -P devops dew:debug

# ====================== 附加参数 ======================
# dew_devops_assignation_projects              # 指定刷新的应用artifactId  多个以逗号分隔</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
启动调试后，会在控制台输出调试端口相关内容，e.g. <code>Http-debug nodePort:[30537].   Http-new nodePort: [30198]</code>，Http-debug nodePort为远程debug的端口，Http-new nodePort为远程启动的用于调试服务的端口。<br>
调试完毕请结束debug进程。
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="cicd工具支持"><a class="anchor" href="#cicd工具支持"></a>4.2.12. CI/CD工具支持</h4>
<div class="sect4">
<h5 id="gitlab_ci"><a class="anchor" href="#gitlab_ci"></a>Gitlab CI</h5>
<div class="paragraph">
<p>应用的部署与回滚为 <code>DevOps</code> 的核心操作，这些操作应该与 <code>CI/CD</code> 工具集成使用。</p>
</div>
<div class="paragraph">
<p><code>Dew</code> 官方支持与 <code>Gitlab CI</code> 集成，步骤如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>使用 <code>dew-devops.sh</code> 初始化项目时，执行2，填写 <code>Gitlab CI</code> 相关信息，安装Gitlab Runner</p>
</li>
<li>
<p>在项目根目录下添加 <code>.gitlab-ci.yml</code> 即可，格式如下：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">stages:
  - deploy

cache:
  paths:
    - frontend/node_modules/
    - .m2/

uat deploy:
  stage: deploy
  only:
    - uat
  tags:
    - uat
  script:
    - mvn -P devops deploy

prod deploy:
  stage: deploy
  only:
    - prod
  tags:
    - prod
  script:
    - mvn -P devops deploy</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">自动化部署</div>
<p>当对应的分支有commit时即可触发部署。</p>
</div>
<div class="paragraph">
<div class="title">版本回滚</div>
<p>在 <code>Gitlab CI Pipelines</code> 中进入要回滚的 <code>Pipeline</code> ，点击 <code>Retry</code> 即可。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/gitlab-ci-rollback.png" alt="gitlab ci rollback">
</div>
</div>
</div>
<div class="sect4">
<h5 id="jenkins_pipeline"><a class="anchor" href="#jenkins_pipeline"></a>Jenkins Pipeline</h5>
<div class="paragraph">
<p>关于 Jenkins Pipeline 的 Job 设置，可参考 <a href="#dew-jenkins-pipeline">Dew DevOps : Jenkins Pipeline 部署</a>。</p>
</div>
<div class="paragraph">
<p>如需自动化部署，可使用 <a href="https://github.com/jenkinsci/gitlab-plugin">GitLab Plugin</a> 实现。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="执行通知"><a class="anchor" href="#执行通知"></a>4.2.13. 执行通知</h4>
<div class="paragraph">
<p>目前支持 <code>钉钉</code> 与 <code>HTTP</code> 两种方式：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>钉钉支持markdown格式的钉钉消息</p>
</li>
<li>
<p>HTTP数据结构分为以下几种情况</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">// PROCESS_EMPTY(空项目)
{
	"title": "DevOps process successful",         // 消息标题
	"content": {                                  // 消息内容
		"kind": "PROCESS_EMPTY",                  // 过程处理类型
		"ci": "",                                 // CI操作
		"message": {}                             // 消息结果内容
	}
}
// PROCESS_INIT(初始化)
{
	"title": "DevOps process successful",         // 消息标题
	"content": {                                  // 消息内容
		"kind": "PROCESS_INIT",                   // 过程处理类型
		"ci": "",                                 // CI操作
		"message": {                              // 消息结果内容
			"profile": "uat",                     // 分支或者环境
			"project": "todo-parent",             // 应用名称
		}
	}
}
// PROCESS_EXECUTE_SUCCESS(成功)/PROCESS_EXECUTE_FAILURE(失败)
{
	"title": "DevOps process successful",         // 消息标题
	"content": {                                  // 消息内容
		"kind": "PROCESS_EXECUTE_SUCCESS",        // 过程处理类型
		"ci": "",                                 // CI操作
		"message": {                              // 消息结果内容
			"mojoName": "release",                // mvn操作步骤
            "profile": "uat",                     // 分支或者环境
            "project": "todo-parent",             // 应用名称
            "successfulFlag": "Successful",       // 成功标识
            "group": "group.idealworld.dew.devops.it",          // 应用group名称
            "message":"***",                      // 错误信息
            "throwable":"**"                      // 错误
		}
	}
}
// PROCESS_GLOBAL_ERROR(全局错误)
{
	"title": "DevOps process successful",         // 消息标题
	"content": {                                  // 消息内容
		"kind": "PROCESS_GLOBAL_ERROR",           // 过程处理类型
		"ci": "",                                 // CI操作
		"message": {                              // 消息结果内容
			"error": "release",                   // 错误信息
            "errorStackTrace": "uat"              // 错误堆栈信息
		}
	}
}
// PROCESS_SHUTDOWN(关闭)
{
	"title": "DevOps process successful",         // 消息标题
	"content": {                                  // 消息内容
		"kind": "PROCESS_SHUTDOWN",               // 过程处理类型
		"ci": "",                                 // ci操作
		"message": {                              // 消息结果内容
			"successfulExecProjects": [{          // 成功的应用
			    "groupId":"com.terran.message",   // maven groupId
			    "artifactId":"dingtalk",          // maven artifactId
			    "execMojos":"release",            // 执行成功的操作，多个以逗号分隔 有release(发布)、unrelease(卸载)、scale(扩容)、rollback(回滚)四种操作
			    "name":"dingtalk"                 // maven应用名称
			    "reason":null
			}],
			"failureExecProjects": [{             // 失败的应用
                "groupId":"com.terran.message",   // maven groupId
                "artifactId":"dingtalk",          // maven artifactId
                "name":"dingtalk",                // maven应用名称
                "reason":"***"                    // 失败原因
            }],
			"noneExecProjects": [{                // 没有执行的应用，在某一应用处理失败后后续的应用都不会被执行
                "groupId":"com.terran.message",   // maven groupId
                "artifactId":"dingtalk",          // maven artifactId
                "name":"dingtalk"                 // maven应用名称
			}],
			"ignoreExecProjects": [{              // 忽略的应用
                "groupId":"com.terran.message",   // maven groupId
                "artifactId":"dingtalk",          // maven artifactId
                "name":"dingtalk",                // maven应用名称
                "reason":"***"                    // 忽略原因
			}]
		}
	}
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dew-devops-deploy"><a class="anchor" href="#dew-devops-deploy"></a>4.2.14. Dew DevOps 脚本部署</h4>
<div class="paragraph">
<p>此为Dew DevOps 的脚本 <code>dew-devops.sh</code> 部署相关说明。集成说明参见： <a href="#Devops-chapter">Dew Devops 部署运维</a></p>
</div>
<div class="sect4">
<h5 id="before_started"><a class="anchor" href="#before_started"></a>Before Started</h5>
<div class="paragraph">
<p>环境准备：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>正常运行的Kubernetes集群</p>
</li>
<li>
<p>安装 Helm</p>
</li>
<li>
<p>可用的 Harbor 镜像仓库</p>
</li>
<li>
<p>GitLab 仓库</p>
</li>
<li>
<p>DockerD（用于Runner中dew-maven-plugin进行项目镜像的打包上传拉取）</p>
</li>
<li>
<p>MinIO，并创建好对应的 bucket(用于进行Runner的缓存存储) (使用Gitlab Runner部署项目需要此项)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>项目准备：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在项目代码中添加并配置 <code>.dew</code> 文件（详见 <a href="http://doc.dew.idealworld.group/#devops-configuration-dew">.dew 配置详情</a>）</p>
</li>
<li>
<p>若使用 Gitlab Runner 进行部署，需要在项目代码中添加并配置 <code>.gitlab-ci.yml</code> 文件（参考 <a href="#dew-gitlab-ci">Gitlab CI 实现</a>）</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="使用方式"><a class="anchor" href="#使用方式"></a>使用方式</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -O https://raw.githubusercontent.com/gudaoxuri/dew/master/devops/sh/dew-devops.sh
sh dew-devops.sh</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="选项介绍"><a class="anchor" href="#选项介绍"></a>选项介绍</h6>
<div class="paragraph">
<div class="title">Init cluster</div>
<p>集群初始化：创建一个用于集群服务发现的 ClusterRole。一个 Kubernetes 集群只需要初始化一次。</p>
</div>
<div class="paragraph">
<div class="title">Install Gitlab runner</div>
<p>Gitlab runner 安装，用于配合 <a href="#dew-gitlab-ci">Gitlab CI</a>部署项目。<br>
此项执行次数根据 Runner 的 profile 和 tag 的情况自行安装。<br>
执行此选项，实际进行了以下操作：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>创建一个ConfigMap，用于保存Maven的settings.xml。
创建一个Secret用于保存MinIO的key和secret。若不使用MinIO作为缓存存储，需要自行配置。
安装Gitlab Runner,并生成gitlab-runner/gitlab-runner-helm-installation.sh，以便查看配置。</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
若不使用MinIO作为缓存存储，请参考 <a href="https://gitlab.com/charts/gitlab-runner/blob/master/values.yaml">Gitlab Runner Chart</a>自行配置。
</td>
</tr>
</table>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Gitlab Runner 部分配置参数说明：</p>
</div>
</blockquote>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">配置项</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">说明</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">runners.image</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">runner的默认容器镜像，为了保证能使用最新的Dew DevOps功能，建议使用dewms/devops:latest；或者也可使用基于此镜像的自定义镜像</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">runners.tags</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于Gitlab CI 触发部署的runner的tag，此脚本中，tags和项目的profile保持一致。也可在执行脚本时自行修改。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">runners.env.dew_devops_profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">此为指定部署项目的profile，默认与runners.tags只保持一致。可在执行脚本时自行修改。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">runners.env.dew_devops_XXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">更多runner.env配置项，详见： <a href="http://doc.dew.idealworld.group/#maven_%E9%85%8D%E7%BD%AE">Maven 配置</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">Create a project</div>
<p>创建项目：用于给需要部署的项目来创建一个部署的命名空间等。
详见： <a href="#what-for-dew-devops">创建项目</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>变更信息</code> 新增可以通过指定 profile 来使得有不同 profile 前缀的命名空间使用相同的 harbor project 来拉取镜像。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="监控管理"><a class="anchor" href="#监控管理"></a>4.2.15. 监控管理</h4>

</div>
</div>
<div class="sect2">
<h3 id="devops-env-install"><a class="anchor" href="#devops-env-install"></a>4.3. 开发/测试环境安装配置</h3>

</div>
</div>
</div>
<h1 id="note" class="sect0"><a class="anchor" href="#note"></a>NOTE</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>开发环境推荐使用Docker for desktop安装Docker和Kubernetes的基础环境，大陆地区安装可参见 <a href="https://github.com/AliyunContainerService/k8s-for-docker-desktop" class="bare">https://github.com/AliyunContainerService/k8s-for-docker-desktop</a> 此项目。</p>
</div>
<div class="paragraph">
<p>Windows用户建议升级到Windows 10 2004版本及以上，启用WSL2。</p>
</div>
<div class="exampleblock">
<div class="content">

</div>
</div>
<div class="paragraph">
<p>本文各服务使用 <code>x.dew.idealworld.group</code> 做为访问的域名，可根据实际情况替换。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>==== 服务规划</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
常规的项目研发多会分 <code>开发(dev)、测试(test)、预发(pre-prod)/用户验收(uat)、生产(prod)</code> 等多个环境。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>服务整体上三类：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>公共支撑服务，如 Gitlab 、 Harbor 等，这些服务要求所有环境共用、互通</p>
</li>
<li>
<p>每个环境独立部署的支撑服务， 如 RabbitMQ、PostgreSql、Redis、dnsmasq、Minio 等，出于数据、资源隔离的要求这些服务各个环境分别部署</p>
</li>
<li>
<p>每个环境的Docker与Kubernetes集群，原则上各环境使用独立的集群，如果共用集群时需要使用<code>namespace</code>加以区分</p>
</li>
</ol>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. 推荐的服务列表</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">分类</th>
<th class="tableblock halign-left valign-top">域名/主机名</th>
<th class="tableblock halign-left valign-top">服务</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">公共支撑服务</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">domain:gitlab.dew.idealworld.group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gitlab</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gitlab及其CI/CD服务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">公共支撑服务</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">domain:harbor/notary.dew.idealworld.group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Harbor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Docker私有库服务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">公共支撑服务</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">domain:maven.dew.idealworld.group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maven</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maven私有库服务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">环境相关的支撑服务</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dnsmasq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">轻量级DNS解析服务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">环境相关的支撑服务</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">domain:minio.dew.idealworld.group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minio</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">分布式对象存储服务，用于CI/CD时做为分布式缓存</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">环境相关的支撑服务</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">domain:nfs.dew.idealworld.group</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NFS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">用于Kuernetes persistent volumes的文件存储服务，生产环境建议使用云厂商的分布式文件存储或 CephFS，支持的类型见
                                                                   <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes" class="bare">https://kubernetes.io/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">容器集群</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hostname:k8s-X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Docker容器服务，部署到所有Kubernetes所在的节点</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">容器集群</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hostname:k8s-X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;CNI&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes CNI服务，部署到所有Kubernetes所在的节点，本文使用 Flannel</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">容器集群</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hostname:k8s-master-X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes Master</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes Master服务，可做HA</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">容器集群</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hostname:k8s-node-X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes Node</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes Node服务，至少3个节点</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>容器集群各节点主机名与IP的映射配置到 /etc/hosts 中</p>
</li>
<li>
<p>kubernetes Node 应至少分两个组: <code>group=app</code> 用于运行应用， <code>group=devops</code> 用于运行运维管理工具。</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
各支撑服务（中间件）的安装见  <a href="#middleware">[middleware]</a> ，下文介绍容器服务的安装配置。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>==== 基础配置</p>
</div>
<div class="paragraph">
<p><strong>以 Centos7 为例，各节点做好ssh免密互访、关闭防火墙、关闭swap、禁用SELINUX</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 关闭防火墙
systemctl stop firewalld.service
systemctl disable firewalld.service
# 关闭swap
swapoff -a
sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
# 禁用SELINUX
sed -i s/^SELINUX=.*$/SELINUX=disabled/ /etc/selinux/config
# 创建key
ssh-keygen -t rsa</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 每个节点执行完上述命令后再执行ssh复制，每个节点都要执行N次（N为节点数-1）
ssh-copy-id -i ~/.ssh/id_rsa.pub root@k8s-X</code></pre>
</div>
</div>
<div class="paragraph">
<p>==== 核心组件</p>
</div>
<div class="paragraph">
<p>===== Docker</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/" class="bare">https://kubernetes.io/docs/setup/production-environment/container-runtimes/</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">yum install -y yum-utils device-mapper-persistent-data lvm2

yum-config-manager --add-repo \
  https://download.docker.com/linux/centos/docker-ce.repo

yum install docker-ce docker-ce-cli containerd.io

mkdir /etc/docker
cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "insecure-registries": ["harbor.dew.idealworld.group"],
  "hosts":[
    "unix:///var/run/docker.sock",
    "tcp://0.0.0.0:2375"
  ],
  "storage-driver": "overlay2",
  "storage-opts": [
    "overlay2.override_kernel_check=true"
  ]
}
EOF

mkdir -p /etc/systemd/system/docker.service.d

# 添加代理（可选）
cat &gt;&gt;/etc/systemd/system/docker.service.d/http-proxy.conf &lt;&lt;EOF
[Service]
Environment="HTTP_PROXY=http://&lt;代理host&gt;:&lt;代理端口&gt;" "HTTPS_PROXY=http://&lt;代理host&gt;:&lt;代理端口&gt;" "NO_PROXY=localhost,127.0.0.1,dew.idealworld.group"
EOF

# dew-maven-plugin 需要调用 docker 服务，推荐使用独立的一个Docker节点，暴露 DockerD 服务。
# 详见 https://docs.docker.com/config/daemon/

cat &gt;&gt;/etc/systemd/system/docker.service.d/docker.conf &lt;&lt;EOF
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd
EOF
-

systemctl daemon-reload
systemctl restart docker
systemctl enable docker</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
生产环境注意做好相应端口的安全策略或是启用证书
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>===== Kubernetes（与K3s二选一）</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" class="bare">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF

sysctl --system

# 使用阿里云镜像加速下载
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF


K8S_VERSION="1.18"
yum install -y kubelet-${K8S_VERSION} kubeadm-${K8S_VERSION} kubectl-${K8S_VERSION} --disableexcludes=kubernetes
systemctl enable --now kubelet</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" class="bare">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Master安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 安装Git，后续会用到
yum install -y git

# 初始化Kubernetes，二选一，使用代理方式
kubeadm init \
    --pod-network-cidr=10.244.0.0/16

# 初始化Kubernetes，二选一，不使用代理方式，通过image-repository 及 --kubernetes-version 避免被墙，注意版本与yum安装的版本对应
K8S_VERSION="1.18"
kubeadm init \
    --image-repository registry.aliyuncs.com/google_containers \
    --kubernetes-version ${K8S_VERSION} \
    --pod-network-cidr=10.244.0.0/16

# 记录上述操作输出中的kubeadm join
# e.g.
# kubeadm join 10.200.10.10:6443 --token i3i7qw.2gst6kayu1e8ezlg --discovery-token-ca-cert-hash sha256:cabc90823a8e0bcf6e3bf719abc569a47c186f6cfd0e156ed5a3cd5a8d85fab0

mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

export KUBECONFIG=/etc/kubernetes/admin.conf

# 查看集群状态
kubectl get cs

# 安装flannel
kubectl apply -f https://docs.projectcalico.org/v3.14/manifests/calico.yaml

# 都为Running后表示完成
kubectl get pods --all-namespaces</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>默认情况下 master 不会做为 node 节点，可通过此命令强制启用（不推荐）</p>
</div>
<div class="paragraph">
<p><code>kubectl taint nodes --all node-role.kubernetes.io/master-</code></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/" class="bare">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Node安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 执行上一步输出的 kubeadm join ...

# 完成后在master上执行情况如下（以1.18版本为例）
kubectl get no
-
k8s-master-1   Ready    master   22m     v1.18
k8s-node-1     Ready    &lt;none&gt;   11m     v1.18
k8s-node-2     Ready    &lt;none&gt;   8m54s   v1.18
k8s-node-3     Ready    &lt;none&gt;   8m51s   v1.18
k8s-node-4     Ready    &lt;none&gt;   8m49s   v1.18
-</code></pre>
</div>
</div>
<div class="paragraph">
<p>===== Metrics Server（仅Kuberentes可用）</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
若要使用HPA(Horizontal Pod Autoscaler)，需要安装 resource metrics API,官方推荐 Metrics Server
（https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/）
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>@see <a href="https://github.com/kubernetes-sigs/metrics-server" class="bare">https://github.com/kubernetes-sigs/metrics-server</a></p>
</div>
<div class="paragraph">
<p>helm chart: <a href="https://github.com/helm/charts/tree/master/stable/metrics-server" class="bare">https://github.com/helm/charts/tree/master/stable/metrics-server</a></p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.7/components.yaml


git clone https://github.com/kubernetes-incubator/metrics-server.git
# Kuberneters V1.8以上执行
kubectl create -f metrics-server/deploy/1.8+/
# Fix issue: https://github.com/kubernetes-incubator/metrics-server/issues/131
kubectl patch deploy metrics-server -n kube-system -p "
spec:
  template:
    spec:
      containers:
      - name: metrics-server
        command:
        - /metrics-server
        - --kubelet-insecure-tls
        - --kubelet-preferred-address-types=InternalIP"
# 不使用代理，需要修改镜像
kubectl -n kube-system set image deploy metrics-server metrics-server=rancher/metrics-server-amd64:v0.3.1
# 验证安装结果
kubectl top node
kubectl top pod</code></pre>
</div>
</div>
<div class="paragraph">
<p>===== K3s（与Kuberntes二选一）</p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># Docker 修改
# K3s使用的是cgroupfs
# 去掉 /etc/docker/daemon.json 中的 "exec-opts": ["native.cgroupdriver=systemd"]
# systemctl daemon-reload
# systemctl restart docker

# 安装Server
curl -sfL https://docs.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn INSTALL_K3S_EXEC="server --docker --no-deploy traefik" sh -
# 获取Token
cat /var/lib/rancher/k3s/server/token
# 安装Agent
curl -sfL https://docs.rancher.cn/k3s/k3s-install.sh | \
  INSTALL_K3S_MIRROR=cn INSTALL_K3S_EXEC="--docker --no-deploy traefik --no-deploy servicelb" \
  K3S_URL=https://&lt;SERVER IP&gt;:6443 K3S_TOKEN=&lt;TOKEN&gt; sh -

# 查看k3s状态
k3s kubectl get nodes -o wide

# 安装Kubectl
# 使用阿里云镜像加速下载
cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
yum install -y kubectl
cp /etc/rancher/k3s/k3s.yaml   ~/.kube/config

# 使用kubectl查看k3s状态
kubectl get nodes -o wide
kubectl get pod -n kube-system</code></pre>
</div>
</div>
<div class="paragraph">
<p>===== Kubernetes/K3s前置配置</p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 创建分组
kubectl label nodes &lt;NODE NAME X&gt; group=app
kubectl label nodes &lt;NODE NAME Y&gt; group=devops

# 创建namespaces
cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: nginx-ingress
  labels:
    name: nginx-ingress
EOF
cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: devops
  labels:
    name: devops
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">添加外部DNS服务（可选），如dnsmasq</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 编辑Kubernetes的DNS，加上dew.idealworld.group的代理
kubectl -n kube-system edit cm coredns
-
data:
  Corefile: |
    ...
    dew.idealworld.group:53 {
        errors
        cache 30
        proxy . x.x.x.x
    }
-</code></pre>
</div>
</div>
<div class="paragraph">
<p>===== Helm</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://helm.sh/docs/intro/install/" class="bare">https://helm.sh/docs/intro/install/</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
# 添加charts repo
helm repo remove stable
helm repo add stable http://mirror.azure.cn/kubernetes/charts/
helm repo update
# 查看helm版本
helm version</code></pre>
</div>
</div>
<div class="paragraph">
<p>===== Nginx Ingress Controller</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
chart: <a href="https://github.com/helm/charts/tree/master/stable/nginx-ingress" class="bare">https://github.com/helm/charts/tree/master/stable/nginx-ingress</a><br>
源码：https://github.com/kubernetes/ingress-nginx<br>
官网：https://kubernetes.github.io/ingress-nginx/<br>
Nginx ingress ConfigMap配置： <a href="https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md" class="bare">https://github.com/kubernetes/ingress-nginx/blob/master/docs/user-guide/nginx-configuration/configmap.md</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 使用如下方式将80 443暴露出来
helm install dew-nginx stable/nginx-ingress --namespace nginx-ingress \
    --set controller.kind=DaemonSet \
    --set controller.hostNetwork=true \
    --set defaultBackend.enabled=false \
    --set controller.metrics.enabled=true

# 删除 helm uninstall dew-nginx --namespace nginx-ingress</code></pre>
</div>
</div>
<div class="paragraph">
<p>===== Harbor</p>
</div>
<div class="paragraph">
<p>====== 非容器化安装（推荐）</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://github.com/goharbor/harbor/blob/master/docs/install-config/_index.md" class="bare">https://github.com/goharbor/harbor/blob/master/docs/install-config/_index.md</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>====== 容器化安装</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
chart: <a href="https://github.com/goharbor/harbor-helm" class="bare">https://github.com/goharbor/harbor-helm</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">helm repo add harbor https://helm.goharbor.io
helm repo update
helm install dew-harbor harbor/harbor --namespace devops \
    --set expose.type=ingress \
    --set expose.ingress.hosts.core=harbor.dew.idealworld.group \
    --set expose.ingress.hosts.notary=notary.dew.idealworld.group \
    --set externalURL=https://harbor.dew.idealworld.group \
    --set core.nodeSelector.group=devops \
    --set portal.nodeSelector.group=devops \
    --set jobservice.nodeSelector.group=devops \
    --set registry.nodeSelector.group=devops \
    --set chartmuseum.nodeSelector.group=devops \
    --set clair.nodeSelector.group=devops \
    --set notary.nodeSelector.group=devops \
    --set database.internal.nodeSelector.group=devops \
    --set redis.internal.nodeSelector.group=devops

# 删除 helm uninstall dew-harbor --namespace devops

# 添加 ``"insecure-registries": ["harbor.dew.idealworld.group"]`` 到 /etc/docker/daemon.json
# 登录Harbor docker login &lt;host&gt; -u &lt;user&gt; -p &lt;password&gt;
docker login harbor.dew.idealworld.group -u admin -p Harbor12345&lt;请修改&gt;
# e.g. 上传镜像
docker pull dewms/devops:latest
docker tag dewms/devops:latest harbor.dew.idealworld.group/dewms/devops:latest
docker push harbor.dew.idealworld.group/dewms/devops:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>===== Gitlab</p>
</div>
<div class="paragraph">
<p>====== 非容器化安装（推荐）</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://docs.gitlab.com/omnibus/README.html#installation-and-configuration-using-omnibus-package" class="bare">https://docs.gitlab.com/omnibus/README.html#installation-and-configuration-using-omnibus-package</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash
yum install -y gitlab-ce

# 按需修改，可修改说明见: https://docs.gitlab.com/omnibus/settings/
vi /etc/gitlab/gitlab.rb
-
external_url 'http://gitlab.dew.idealworld.group'
...
-
gitlab-ctl reconfigure

# 浏览器访问并修改root密码</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">HA配置</div>
<div class="content">
<pre># @see https://about.gitlab.com/solutions/high-availability/</pre>
</div>
</div>
<div class="paragraph">
<p>===== Sonatype Nexus</p>
</div>
<div class="paragraph">
<p>====== 非容器化安装（推荐）</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://help.sonatype.com/repomanager3/installation" class="bare">https://help.sonatype.com/repomanager3/installation</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>====== 容器化安装</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://github.com/Oteemo/charts/tree/master/charts/sonatype-nexus" class="bare">https://github.com/Oteemo/charts/tree/master/charts/sonatype-nexus</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">部署化部署</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">helm repo add oteemocharts https://oteemo.github.io/charts
helm repo update
helm install dew-nexus oteemocharts/sonatype-nexus --namespace devops \
    --set ingress.enabled=true \
    --set nexusProxy.env.nexusHttpHost=maven.dew.idealworld.group \
    --set nexusProxy.env.nexusDockerHost=maven.dew.idealworld.group

# 用户名 admin 密码 admin123</code></pre>
</div>
</div>
<div class="paragraph">
<p>==== 监控组件</p>
</div>
<div class="paragraph">
<p>===== Elasticsearch</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
建议非容器化部署
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>===== Kibana</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://github.com/helm/charts/tree/master/stable/kibana" class="bare">https://github.com/helm/charts/tree/master/stable/kibana</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 使用NFS存储，创建PV &amp; PVC

# 在NFS节点中创建NFS目录
mkdir -p /data/nfs/kibana

# 在Kubernetes Master节点中创建PV &amp; PVC
cat &lt;&lt;EOF | kubectl -n devops apply -f -
apiVersion: v1
kind: PersistentVolume
metadata:
  labels:
    app: kibana
  name: dew-kibana
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Recycle
  nfs:
    path: /data/nfs/kibana
    server: nfs.dew.idealworld.group
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: kibana
  name: kibana
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  selector:
    matchLabels:
      app: kibana
EOF

# 若使用 StorageClass，则无需创建PV，PVC，需设置以下参数
# 将existingClaim的值改为false    --set persistentVolumeClaim.existingClaim=false
# 设置StorageClass的名字    --set persistentVolumeClaim.storageClass="yourscname"
# 设置size    --set persistentVolumeClaim.size=10Gi
helm install --name dew-kibana stable/kibana --namespace devops --version=2.2.0 \
    --set image.tag="6.6.1" \
    --set env."ELASTICSEARCH_URL"="http://dew-elasticsearch-master:9200" \
    --set service.internalPort=5601 \
    --set ingress.enabled=true,ingress.hosts={kibana.dew.idealworld.group} \
    --set dashboardImport.enabled=true \
    --set dashboardImport.dashboards."k8s"="https://raw.githubusercontent.com/monotek/kibana-dashboards/master/k8s-fluentd-elasticsearch.json" \
    --set serviceAccount.create=true,serviceAccountName=kibana \
    --set plugins.enabled=true \
    --set persistentVolumeClaim.enabled=true \
    --set persistentVolumeClaim.existingClaim=true \
    --set securityContext.enabled=true \
    --set securityContext.allowPrivilegeEscalation=true \
    --set securityContext.runAsUser=0 \
    --set securityContext.fsGroup=0 \
    --set nodeSelector.group=devops</code></pre>
</div>
</div>
<div class="paragraph">
<p>===== Prometheus &amp; Grafana</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" class="bare">https://github.com/helm/charts/tree/master/stable/prometheus-operator</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">prometheus-operator结构</div>
<div class="content">
<pre> |--- prometheus-operator
 |--- prometheus
 |--- alertmanager
 |--- node-exporter
 |--- kube-state-metrics
 |--- service monitors to scrape internal kubernetes components
 |     |---kube-apiserver
 |     |---kube-scheduler
 |     |---kube-controller-manager
 |     |---etcd
 |     |---kube-dns/coredns
 |--- grafana</pre>
</div>
</div>
<div class="listingblock">
<div class="title">创建prometheus 的 PV</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">app=prometheus
components=("alertmanager" "prometheus")
size=100Gi

# 在NFS节点中创建NFS目录
for i in ${components[@]};do
mkdir -p /data/nfs/${app}/${i}
done

# 在Kubernetes Master节点中创建PV
for i in ${components[@]};do
cat &lt;&lt;EOF | kubectl -n devops apply -f -
apiVersion: v1
kind: PersistentVolume
metadata:
  labels:
    component: ${i}
  name: ${app}-${i}
spec:
  capacity:
    storage: ${size}
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Recycle
  nfs:
    path: /data/nfs/${app}/${i}
    server: nfs.dew.idealworld.group
EOF
done</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">创建grafana 的 PV &amp; PVC</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 在NFS节点中创建NFS目录
mkdir -p /data/nfs/grafana

# 在Kubernetes Master节点中创建PV &amp; PVC
cat &lt;&lt;EOF | kubectl -n devops apply -f -
apiVersion: v1
kind: PersistentVolume
metadata:
  labels:
    app: grafana
  name: grafana
spec:
  capacity:
    storage: 50Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Recycle
  nfs:
    path: /data/nfs/grafana
    server: nfs.dew.idealworld.group
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app: grafana
  name: grafana
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 50Gi
  selector:
    matchLabels:
      app: grafana
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">使用helm安装</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 若需要对etcd进行监控，则需要先创建secret
kubectl -n devops create secret generic dew-prometheus-operator-etcd \
  --from-file=/etc/kubernetes/pki/etcd/ca.crt \
  --from-file=/etc/kubernetes/pki/etcd/peer.crt \
  --from-file=/etc/kubernetes/pki/etcd/peer.key

# 安装
# · 不使用代理要加上 --set kube-state-metrics.image.repository=registry.cn-hangzhou.aliyuncs.com/google_containers/kube-state-metrics
# · 若要启用对etcd监控，需设置kubeEtcd相关参数。
# · grafana.'grafana\.ini'为Grafana的配置参数,请安装时自行修改。
# · 使用StorageClass
#    - 若 Grafana 使用StorageClass，需要进行以下配置，无需创建PV，PVC
#      --set grafana.persistence.storageClassName="yourscname"
#      --set grafana.persistence.size=10Gi
#      删去此行配置：    --set grafana.persistence.existingClaim=grafana \
#    - Prometheus使用StorageClass,需要添加以下配置，无需创建PV，PVC
#      --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.storageClassName="yourscname" \
#    - Alertmanager和Prometheus使用StorageClass,需要添加以下配置，无需创建PVC，但因为自动生成的PVC名称过长，
#      而无法动态创建PV，所以需要自行修改chart相关配置或指定已创建好的PV名称：
#      --set alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.volumeName=prometheus-alertmanager \
#      --set alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.storageClassName="yourscname" \
helm install stable/prometheus-operator --name dew-prometheus-operator --namespace devops --version=5.0.10 \
    --set kubelet.serviceMonitor.https=true \
    --set prometheus.ingress.enabled=true \
    --set prometheus.ingress.hosts={prometheus.dew.idealworld.group} \
    --set alertmanager.ingress.enabled=true \
    --set alertmanager.ingress.hosts={alertmanager.dew.idealworld.group} \
    --set prometheusOperator.securityContext.runAsNonRoot=false \
    --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=100Gi \
    --set alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.resources.requests.storage=100Gi \
    --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.selector.matchLabels."component"="prometheus" \
    --set alertmanager.alertmanagerSpec.storage.volumeClaimTemplate.spec.selector.matchLabels."component"="alertmanager" \
    --set prometheus.prometheusSpec.secrets[0]=dew-prometheus-operator-etcd \
    --set kubeEtcd.serviceMonitor.scheme=https \
    --set kubeEtcd.serviceMonitor.insecureSkipVerify=true \
    --set kubeEtcd.serviceMonitor.caFile="/etc/prometheus/secrets/dew-prometheus-operator-etcd/ca.crt" \
    --set kubeEtcd.serviceMonitor.certFile="/etc/prometheus/secrets/dew-prometheus-operator-etcd/peer.crt" \
    --set kubeEtcd.serviceMonitor.keyFile="/etc/prometheus/secrets/dew-prometheus-operator-etcd/peer.key" \
    --set grafana.enabled=true \
    --set grafana.adminPassword=Dew123456 \
    --set grafana.defaultDashboardsEnabled=true \
    --set grafana.ingress.enabled=true \
    --set grafana.ingress.hosts={grafana.dew.idealworld.group} \
    --set grafana.sidecar.dashboards.enabled=true \
    --set grafana.sidecar.dashboards.searchNamespace="devops"\
    --set grafana.sidecar.dashboards.label=grafana_dashboard \
    --set grafana.sidecar.datasources.enabled=true \
    --set grafana.sidecar.datasources.searchNamespace="devops" \
    --set grafana.sidecar.datasources.label=grafana_datasource \
    --set grafana.'grafana\.ini'.smtp.enabled="true" \
    --set grafana.'grafana\.ini'.smtp.host="smtp.163.com:25" \
    --set grafana.'grafana\.ini'.smtp.user=XXXXX@163.com \
    --set grafana.'grafana\.ini'.smtp.password=XXXXX \
    --set grafana.'grafana\.ini'.smtp.from_address="XXXXX@163.com" \
    --set grafana.'grafana\.ini'.smtp.skip_verify=true \
    --set grafana.'grafana\.ini'.server.root_url="http://grafana.dew.idealworld.group" \
    --set grafana.persistence.enabled=true \
    --set grafana.persistence.existingClaim=grafana \
    --set prometheusOperator.nodeSelector.group=devops \
    --set alertmanager.alertmanagerSpec.nodeSelector.group=devops \
    --set prometheus.prometheusSpec.nodeSelector.group=devops \
    --set kube-state-metrics.nodeSelector.group=devops \
    --set grafana.nodeSelector.group=devops


# grafana默认用户名：admin
# 访问 http://prometheus.dew.idealworld.group
# 访问 http://alertmanager.dew.idealworld.group
# 访问 http://grafana.dew.idealworld.group</code></pre>
</div>
</div>
<div class="quoteblock">
<div class="title">常见问题</div>
<blockquote>
<div class="paragraph">
<p>如何查看设置的密码</p>
</div>
</blockquote>
</div>
<div class="literalblock">
<div class="content">
<pre>kubectl get secret --namespace devops dew-prometheus-operator-grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo</pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>如何重置grafana密码</p>
</div>
</blockquote>
</div>
<div class="literalblock">
<div class="content">
<pre>进入grafana的容器内部后执行
grafana-cli admin reset-admin-password passwordvalue</pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>有pod启动失败,报文件权限拒绝相关问题，如 "opening storage failed: create dir: mkdir /prometheus/wal: permission denied"</p>
</div>
</blockquote>
</div>
<div class="literalblock">
<div class="content">
<pre>很可能和PV的文件目录的权限有关，检查下权限是否一致，设置对应的securityContext进行排查。例：
kubectl edit statefulset prometheus-dew-prometheus-operator-prometheus -n devops
设置securityContext为以下内容
-
 securityContext:
   fsGroup: 0
   runAsNonRoot: false
   runAsUser: 0
-</pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>通过UI查看prometheus的target中，kube-scheduler、kube-controller处于down状态</p>
</div>
</blockquote>
</div>
<div class="literalblock">
<div class="content">
<pre>因为它们只能在宿主机上通过127.0.0.1访问，可使用以下操作：
. 如果使用kubeadm启动的集群，初始化时的config.yml里可以加入如下参数
    controllerManagerExtraArgs:
      address: 0.0.0.0
    schedulerExtraArgs:
      address: 0.0.0.0
. 已经启动后的使用下面命令更改就会滚动更新
    sed -e "s/- --address=127.0.0.1/- --address=0.0.0.0/" -i /etc/kubernetes/manifests/kube-controller-manager.yaml
    sed -e "s/- --address=127.0.0.1/- --address=0.0.0.0/" -i /etc/kubernetes/manifests/kube-scheduler.yaml
  或者全部替换：
    sed -ri '/--address/s#=.+#=0.0.0.0#' /etc/kubernetes/manifests/kube-*
. 参考文章：
  http://www.servicemesher.com/blog/prometheus-operator-manual/
  https://github.com/coreos/prometheus-operator/blob/master/Documentation/troubleshooting.md</pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>如何监控APP</p>
</div>
</blockquote>
</div>
<div class="literalblock">
<div class="content">
<pre>1.首先需要将项目instrument
  参考文章：https://prometheus.io/docs/instrumenting/clientlibs/
2.部署项目及创建进行监控的ServiceMonitor
  注意ServiceMonitor的labels要含有Prometheus-operator创建的Prometheus的serviceMonitorSelector的label。
  详细文章：https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/getting-started.md#related-resources
            https://coreos.com/operators/prometheus/docs/latest/user-guides/getting-started.html
3.Demo
  以devops-example-todo的compute模块为例创建ServiceMonitor
  link: https://github.com/dew-ms/devops-example-todo
  -
  cat &lt;&lt;EOF | kubectl -n devops apply -f -
  apiVersion: monitoring.coreos.com/v1
  kind: ServiceMonitor
  metadata:
    labels:
      app: todo-compute
      release: dew-prometheus-operator
    name: dew-app-todo-compute
  spec:
    endpoints:
    - honorLabels: true
      interval: 10s
      path: /actuator/prometheus
      port: http
    jobLabel: dew-app-todo-compute
    namespaceSelector:
      matchNames:
      - dew-uat
    selector:
      matchLabels:
        app: todo-compute
  EOF
  -</pre>
</div>
</div>
<div class="paragraph">
<p>===== Fluentd</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://github.com/kiwigrid/helm-charts/tree/master/charts/fluentd-elasticsearch" class="bare">https://github.com/kiwigrid/helm-charts/tree/master/charts/fluentd-elasticsearch</a><br>
     <a href="https://kiwigrid.github.io/" class="bare">https://kiwigrid.github.io/</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">helm repo add kiwigrid https://kiwigrid.github.io

# 安装
# · 不使用代理要加上 --set image.tag=v2.4.0 --set image.repository=registry.cn-hangzhou.aliyuncs.com/google_containers/fluentd-elasticsearch
#    如需使用最新版本镜像，可自行下载镜像源文件制作镜像
#    地址：https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-elasticsearch/fluentd-es-image
# · 镜像版本建议使用v2.5.2以上，避免一些bug。
# · 请根据需要进行节点亲和性相关设置，但请保证需要收集日志的节点有Fluentd部署。
#    e.g. 若只需收集部署了应用的节点的日志，设置 --set nodeSelector.group=app
# · 通过启用configMaps.useDefaults各类型的日志配置文件，来实现各类日志的收集，默认为全部启用。
#    更多的日志收集配置，请见：https://docs.fluentd.org
# · 若要启用Prometheus进行监控Fluentd，
#    需要先将Fluentd通过设置service暴露出来，然后设置prometheusRule和serviceMonitor。
#    此配置需结合Prometheus-operator使用。
helm install kiwigrid/fluentd-elasticsearch --name dew-fluentd-es --namespace devops --version=3.0.0 \
    --set elasticsearch.host=dew-elasticsearch-master \
    --set elasticsearch.port=9200 \
    --set elasticsearch.logstash_prefix=logstash \
    --set service.type=ClusterIP \
    --set service.ports[0].name="monitor-agent" \
    --set service.ports[0].port=24231 \
    --set prometheusRule.enabled=true \
    --set prometheusRule.prometheusNamespace=devops \
    --set prometheusRule.labels.app=prometheus-operator \
    --set prometheusRule.labels.release=dew-prometheus-operator \
    --set serviceMonitor.enabled=true \
    --set serviceMonitor.labels.release=dew-prometheus-operator \
    --set configMaps.useDefaults.outputConf=true \
    --set configMaps.useDefaults.containersInputConf=true \
    --set configMaps.useDefaults.systemConf=false \
    --set configMaps.useDefaults.systemInputConf=false \
    --set configMaps.useDefaults.forwardInputConf=false \
    --set configMaps.useDefaults.monitoringConf=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>===== Jaeger</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="https://github.com/jaegertracing/jaeger-operator" class="bare">https://github.com/jaegertracing/jaeger-operator</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl create -f https://raw.githubusercontent.com/jaegertracing/jaeger-operator/master/deploy/crds/jaegertracing_v1_jaeger_crd.yaml
curl https://raw.githubusercontent.com/jaegertracing/jaeger-operator/master/deploy/service_account.yaml \
    | sed "s/namespace: observability/namespace: devops/g" \
    | kubectl create -f -
curl https://raw.githubusercontent.com/jaegertracing/jaeger-operator/master/deploy/service_account.yaml \
    | sed "s/namespace: observability/namespace: devops/g" \
    | kubectl create -f -
curl https://raw.githubusercontent.com/jaegertracing/jaeger-operator/master/deploy/role.yaml \
    | sed "s/namespace: observability/namespace: devops/g" \
    | kubectl create -f -
curl https://raw.githubusercontent.com/jaegertracing/jaeger-operator/master/deploy/role_binding.yaml \
    | sed "s/namespace: observability/namespace: devops/g" \
    | kubectl create -f -
curl https://raw.githubusercontent.com/jaegertracing/jaeger-operator/master/deploy/operator.yaml \
    | sed "s/namespace: observability/namespace: devops/g" \
    | kubectl create -f -

# 创建Jaeger实例
cat &lt;&lt;EOF | kubectl apply -n devops -f -
apiVersion: jaegertracing.io/v1
kind: Jaeger
metadata:
  name: jaeger
spec:
  strategy: production
  storage:
    type: elasticsearch
    options:
      es:
        server-urls: http://dew-elasticsearch-master:9200
  ingress:
    enabled: false # 用于使用下面自定义的Ingress
EOF

# Jaeger实例可在不同namespace下创建使用，使用中请注意namespace的问题。
# 使用sidecar的方式部署项目：https://github.com/jaegertracing/jaeger-operator#auto-injection-of-jaeger-agent-sidecars
# 使用daemonset的方式部署项目：https://github.com/jaegertracing/jaeger-operator#agent-as-daemonset

# 添加Host，为Jaeger实例创建Ingress
# 注意serviceName与Jaeger实例创建的service名称保持一致
cat &lt;&lt;EOF | kubectl -n devops apply -f -
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: nginx
  name: jaeger-query
spec:
  rules:
    - host: jaeger.dew.idealworld.group
      http:
        paths:
          - backend:
              serviceName: jaeger-query
              servicePort: 16686
            path: /
EOF

# Pod的调度
# 目前jaeger-operator暂不支持直接设置，请关注该项目的更新情况。
# 可以自行给需要调度的pod的deployment添加限制条件。
# e.g.
 kubectl patch deploy jaeger-operator jaeger-collector jaeger-query -n devops -p '{"spec": {"template": {"spec": {"nodeSelector": {"group": "devops"}}}}}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">使用</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 在Deployment 和 Service 中添加annotations : sidecar.jaegertracing.io/inject: "true" 即可。
# 使用Dew的 devops-maven-plugin 部署会自动添加此注解。

# 手工添加示例如下：
cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    # 添加 Jaeger的注解
    sidecar.jaegertracing.io/inject: "true"
  name: jaeger-demo
spec:
  template:
    metadata:
      labels:
        app: jaeger-demo
        version: v1
    spec:
      containers:
      - name: jaeger-demo
        image: jaegertracing/example-hotrod:1.10
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  annotations:
   # 添加 Jaeger的注解
    sidecar.jaegertracing.io/inject: "true"
  name: jaeger-demo
  labels:
    app: jaeger-demo
spec:
  ports:
   - name: jaeger-demo
     port: 8080
     targetPort: 8080
  selector:
   app: jaeger-demo
EOF</code></pre>
</div>
</div>
<div id="devops-configuration" class="paragraph">
<p>=== DevOps配置速查</p>
</div>
</div>
</div>
<div class="paragraph">
<p>DevOps的配置有两类， 一是通过项目目录下的 <code>.dew</code> 配置， 二是通过 <code>Maven</code> 配置，在 <code>pom.xml</code> 中的properties或是 <code>mvn -Dxxx</code> 作为参数传入。</p>
</div>
<div class="paragraph">
<p>推荐的做法是相对固定的、不敏感的信息配置到 <code>.dew</code> 中，而诸如Kubernetes配置、Harbor用户名/密码等信息用Maven在命令行中作为参数传入。</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="devops-configuration-dew" class="paragraph">
<p>==== .dew 配置</p>
</div>
<div class="listingblock">
<div class="title">配置说明</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml"># 默认环境配置
namespace: default                      # 命名空间，强烈建议修改为特定的命名空间
skip: false                             # 是否跳过，为true时表示
disableReuseVersion: false              # 是否禁用重用版本，默认为false。e.g. 生产环境重用预发环境的最后一个版本（不用重新打包Docker image)
                                        # 默认情况前端工程为true（node编译期会混入环境信息导致无法重用），其它工程为false
reuseLastVersionFromProfile:            # 重用版本的目标环境名称
                                        # 默认会尝试使用 pre-prod/pre-production/uat 为名称（找到当前项目第一个存在的环境）
                                        # 都不存在时需要显式指定
ignoreChangeFiles: []                   # 忽略变更文件列表，此列表指定的文件不用于是否有变更要部署的判断依据
                                        # 支持 glob , @see https://en.wikipedia.org/wiki/Glob_(programming)
app:                                    # 应用配置
  replicas: 1                           # 部署的副本数,推荐副本数设为2及以上，便于滚动更新时不中断服务
  revisionHistoryLimit: 3               # 保留的历史版本数
  port: 8080                            # 端口号，默认情况下前端应用为80(不可修改)，原生NodeJS项目的端口为3000，后端服务为8080
  extendedPorts: []                     # 扩展端口，仅用于后端服务
  debugPort: 9000                       # 远程调试服务端口号，仅用于后端服务，默认是9000
  healthCheckEnabled: true              # 是否启用健康检查，仅用于后端服务，默认启用
  healthCheckPort:                      # 用于健康检查的端口，仅用于后端服务，如不设置，默认使用app.port的端口
  livenessPath: /actuator/health        # 存活检测HTTP的路径，仅用于后端服务
  readinessPath: /actuator/health       # 可用检测HTTP的路径，仅用于后端服务
  livenessInitialDelaySeconds: 60       # 首次存活检测延迟时间，仅用于后端服务
  livenessPeriodSeconds: 30             # 存活检测周期，仅用于后端服务
  livenessFailureThreshold: 6           # 存活检测失败次数阈值，超过后销毁当前实例并重启另一个实例，仅用于后端服务
  readinessInitialDelaySeconds: 10      # 首次可用检测延迟时间，仅用于后端服务
  readinessPeriodSeconds: 60            # 可用检测周期，仅用于后端服务
  readinessFailureThreshold: 3          # 可用检测失败次数阈值，超过后当前实例不可用，仅用于后端服务
  traceLogEnabled: true                 # 是否启用追踪日志，仅用于后端服务
  traceLogSpans: false                  # 是否在控制台输出spans日志，仅用于后端服务
  traceWebSkipPattern: ""               # 设置跳过追踪的接口，为空则使用官方默认值，仅用于后端服务
  traceProbabilisticSamplingRate: 0.1   # 追踪日志概率采样比率，为1.0则使用全量采样，仅用于后端服务
  metricsEnabled: true                  # 是否启用Prometheus的metrics，仅用于后端服务
  nodeSelector:                         # 节点亲和性配置
    group: app                          # 默认选择标签为 group=app 的节点
  preparePackageCmd:                    # 预打包命令
                                        # 前端应用默认为 cd &lt;应用目录&gt; &amp;&amp; set NODE_ENV=&lt;环境名称&gt; &amp;&amp; npm install，
                                        # 发现不存在 node_modules 或 发现前端项目下 package.json 文件变更 时执行
                                        # 后端服务默认为空
  packageCmd:                           # 打包命令
                                        # 前端应用默认为 cd &lt;应用目录&gt; &amp;&amp; set NODE_ENV=&lt;环境名称&gt; npm run build:&lt;环境名称&gt;
                                        # 后端服务默认为空
  runOptions:                           # 运行参数，可指定诸如 JVM 配置等信息
  serverConfig: |-                      # 服务配置，多为Nginx配置
  containerCmd: []                      # 容器command命令
  containerResourcesLimits: {}          # 容器资源上限，同Kubernetes配置，值应大于等于containerResourcesRequests
                                        # @see  https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/
  containerResourcesRequests: {}        # 容器资源下限，同Kubernetes配置，值应小于等于containerResourcesLimits
                                        # @see  https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/
  volumeMounts: []                      # 卷安装配置
  volumes: []                           # 卷配置，如果使用公用卷配置，请自行在项目对应的namespace下安装pv，pvc及endpoints
  annotations: {}                       # 自定义annotations
  labels: {}                            # 自定义labels
  env: {}                               # 自定义env，key对应一个env的name，value对应一个env的value
docker:                                 # Docker配置
  host:                                 # Dockerd的Host e.g. tcp://dockerd.dew.idealworld.group:2375
  registryUrl:                          # Docker Registry Url  e.g. https://harbor.dew.idealworld.group/v2
  registryUserName:                     # Docker Registry 用户名，此项建议使用Maven方式配置
  registryPassword:                     # Docker Registry 密码，此项建议使用Maven方式配置
  image:                                # Docker 镜像
                                        # 前端应用默认使用 nginx:alpine
                                        # 后端服务应用默认使用 openjdk:8-alpine
kube:                                   # Kubernetes配置
  base64Config:                         # Kubernetes Base64 后的配置，此项建议使用Maven方式配置
                                        # 使用 ``echo $(cat ~/.kube/config | base64) | tr -d " "`` 获取
notifies:                               # 通知配置
  - type: DD                            # 通知的类型，DD=钉钉 MAIL=邮件，邮件方式需要有配置spring.mail下相关的smtp信息 HTTP=自定义HTTP Hook
    defaultReceivers: []                # 默认接收人列表，钉钉为手机号，邮件为邮箱
    dndTimeReceivers: []                # 免扰时间内的接收人列表，只有该列表中的接收人才能在免扰时间内接收通知
    args:                               # 不同类型的参数，邮件不需要设置
        url:                            # type=DD表示钉钉的推送地址
                                        # 说明详见：https://open-doc.dingtalk.com/microapp/serverapi2/qf2nxq
                                        # type=HTTP表示HTTP Hook的地址
        msgType:                        # 仅用于type=DD，支持 text/markdown
    strategy:                           # 通知策略
        minIntervalSec: 0               # 最小间隔的通知时间，0表示不设置，如为10则表示10s内只会发送一次
        dndTime:                        # 免扰时间，HH:mm-HH:mm 如，18:00-06:00
                                        # HH:mm-HH:mm，如果两个时间相等表示全天免扰，如果后者大于前者表示跨天免扰
        forceSendTimes: 3               # 同一免扰周期间通知调用达到几次后强制发送
# 其它环境配置
profiles:
    &lt;name&gt;: # 环境名称，e.g. test uat prod
        # 此处配置项同默认环境的配置项，用于覆写默认配置</code></pre>
</div>
</div>
<div id="devops-configuration-dew-inheritance-rules" class="ulist">
<div class="title">继承规则</div>
<ul>
<li>
<p><code>.dew</code> 可放在任意应用（模块）的根目录（与pom.xml同级）下，应用会继承项目的配置</p>
</li>
<li>
<p><code>.dew</code> 支持多环境(profiles)，各环境继承默认环境的配置</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">继承示例</div>
<div class="content">
<pre># 项目结构
|- moduleA
|-  |- pom.xml
|-  |- .dew         # 应用A配置
|- pom.xml
|- .dew             # 全局配置

# 全局配置的.dew 内容:
-
app:
  replicas: 1
profiles:
  test:
    namespace: todo-test
  uat:
    namespace: todo-uat
-
# 应用A配置的.dew 内容:
-
profiles:
  uat:
    app:
      replicas: 2
-

# 对于应用A最终的配置为:
-
app:
  replicas: 1               # 继承全局配置
profiles:
  test:
    namespace: todo-test    # 继承全局配置
    app:
      replicas: 1           # 继承全局配置的默认环境配置
  uat:
    namespace: todo-uat
    app:
      replicas: 2           # 使用应用A的覆写配置
-</pre>
</div>
</div>
<div class="ulist">
<div class="title">profiles 继承规则</div>
<ul>
<li>
<p>若全局配置的<code>.dew</code>中配置了某一profile的参数，若想在应用B覆写全局配置的profile，则需要在应用B中设定此配置以实现覆写。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre># 项目结构
|- moduleA
|-  |- pom.xml
|-  |- .dew         # 应用A配置
|- moduleB
|-  |- pom.xml
|-  |- .dew         # 应用A配置
|- pom.xml
|- .dew             # 全局配置

# 全局配置的.dew 内容:
-
app:
  replicas: 1 # 全局默认配置
profiles:
  test:
    namespace: todo-test
  uat:
    namespace: todo-uat
    app:
      replicas: 2 # 全局profile配置
-
# 应用A配置的.dew 内容:
-
profiles:
  uat:
    app:
      replicas: 3 # 应用A的profile配置
-
# 应用B配置的.dew 内容:
-
app:
  replicas: 4     # 应用B的默认配置
profiles:
  uat:
    app:
      replicas: 5 # 应用B的profile配置
-

# 对于应用A最终的配置为:
-
app:
  replicas: 1               # 继承全局配置
profiles:
  test:
    namespace: todo-test    # 继承全局配置
    app:
      replicas: 1           # 继承全局配置的默认环境配置
  uat:
    namespace: todo-uat
    app:
      replicas: 3           # 使用应用A的profile覆写配置
-

# 对于应用B最终的配置为:
-
app:
  replicas: 4               # 使用应用B的默认配置
profiles:
  test:
    namespace: todo-test    # 继承全局配置
    app:
      replicas: 4           # 使用应用B的默认配置
  uat:
    namespace: todo-uat
    app:
      replicas: 5           # 使用应用B的profile覆写配置
-</pre>
</div>
</div>
<div class="paragraph">
<p>==== Maven 配置</p>
</div>
<div class="listingblock">
<div class="title">配置说明</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># ============= 公共场景使用 =============
dew_devops_profile                           # 指定的环境
dew_devops_kube_config                       # Kubernetes Base64 后的配置，使用 ``echo $(cat ~/.kube/config | base64) | tr -d " "`` 获取
# ============= 发布与回滚使用 =============
dew_devops_docker_host                       # Dockerd的Host e.g. tcp://dockerd.dew.idealworld.group:2375
dew_devops_docker_registry_url               # Docker Registry Url  e.g. https://harbor.dew.idealworld.group/v2
dew_devops_docker_registry_username          # Docker Registry 用户名
dew_devops_docker_registry_password          # Docker Registry 密码
dew_devops_assignation_projects              # 指定部署应用artifactId  多个以逗号分隔
dew_devops_quiet                             # 是否静默处理
# ============= 日志及调试场景使用 =============
dew_devops_podName                           # 要使用的Pod名称，如不填写当存在多个Pod时会要求用户选择
# ============= 日志场景使用 =============
dew_devops_log_follow                        # 是否滚动查看日志
# ============= 调试场景使用 =============
dew_devops_debug_forward_port                # 转发端口标识
# ============= 伸缩场景使用 =============
dew_devops_scale_replicas                    # 伸缩Pod数量
dew_devops_scale_auto                        # 是否启用自动伸缩
dew_devops_scale_auto_minReplicas            # 自动伸缩Pod数下限
dew_devops_scale_auto_maxReplicas            # 自动伸缩Pod数上限
dew_devops_scale_auto_cpu_averageUtilization # 自动伸缩条件：CPU平均使用率标识</code></pre>
</div>
</div>
<div id="devops-best-practices" class="paragraph">
<p>=== DevOps最佳实践</p>
</div>
<div class="paragraph">
<p>==== 为什么不用 fabric8</p>
</div>
<div class="paragraph">
<p>Fabric8的maven插件( <a href="https://github.com/fabric8io/docker-maven-plugin" class="bare">https://github.com/fabric8io/docker-maven-plugin</a> )比较成熟，并且被 Spring Cloud Kubernetes 官方推荐( <a href="https://github.com/fabric8-quickstarts/spring-boot-ribbon" class="bare">https://github.com/fabric8-quickstarts/spring-boot-ribbon</a> )。</p>
</div>
<div class="paragraph">
<p><code>dew</code> 之所以没有使用fabric8是因为设计理念有一定差异，<code>dew</code> 追求 <code>轻量化、在一定规范下的可定制化、集成化</code> ，
比如实现了基于环境的部署流程，自动判断应用是否需要发布、版本管理、版本重用模式、钉钉通知等，这些差异是导致自研的原因。
当然在实现上也借鉴了fabric8比较好的做法，比如JVM参数的自动化处理。</p>
</div>
<div id="devops-best-practices-auth" class="paragraph">
<p>==== 鉴权处理</p>
</div>
<div class="paragraph">
<p>在传统的Spring Cloud工程中多使用网关（如 Zuul、Spring Cloud Gateway）做统一的认证处理，但在Kubernetes下使用了 <code>ingress</code> ，如果再加上网关会导致多了一层转发。
并且Kubernetes使用自身的Service已经实现了网关的服务发现，所以再引入网关就显得累赘了。</p>
</div>
<div class="paragraph">
<p>去掉网关后鉴权处理会下沉到各业务组件， <code>dew</code> 提供了基础的鉴权支持 <a href="#framework-user-manual-auth">权限认证</a> 也可使用 Spring Cloud Security 方案实现。</p>
</div>
<div class="paragraph">
<p>==== 统一配置处理</p>
</div>
<div class="paragraph">
<p>Spring Cloud Kubernetes 实现了基于ConfigMap/Secrets的统一配置管理，但由于后者暂未解决版本化管理、自定义密钥的加解密及友好的配置编辑能力，
故推荐使用Spring Cloud Config， <code>dew</code> 基于Spring Cloud Config封装了Chart，详见 <a href="#helm-chart-spring-cloud-config">[helm-chart-spring-cloud-config]</a> 。</p>
</div>
<div class="paragraph">
<p>统一配置服务建议多个项目共享一套，为方便开发调试，故此服务建议使用URL调用而非ServiceId，e.g:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">原配置</th>
<th class="tableblock halign-left valign-top">现配置</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>spring:
   cloud:
     config:
       discovery:
         service-id: config
         enabled: true</pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre>spring:
   cloud:
     config:
       uri: http://config.dew.idealworld.group</pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>==== JVM设置</p>
</div>
<div class="paragraph">
<p>在 <code>app.runOptions</code> 配置中可以指定 JVM 的参数（比如 <code>-Xms -Xmx</code>），但同时也可以通过 <code>app.containerResourcesLimits</code> 和 <code>app.containerResourcesRequests</code> 指定容器资源的上下限，两者如何配合？</p>
</div>
<div class="paragraph">
<p><code>dew</code> 推荐用户设置容器的资源限定，部署时 <code>dew</code> 会根据容器环境自行设置JVM参数，规则如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-Xmx</code> 或 <code>-Xms</code> 设置</p>
<div class="ulist">
<ul>
<li>
<p>如果传入的 <code>JAVA_OPTIONS</code> 带有 <code>-Xmx</code> 或 <code>-Xms</code> 则优先使用传入设置</p>
</li>
<li>
<p>如果传入了 <code>JAVA_MAX_MEM_RATIO</code> 则设置 <code>-Xmx</code> 为 <code>最大可用内存</code>/<code>JAVA_MAX_MEM_RATIO</code>， 当 <code>JAVA_MAX_MEM_RATIO</code>=50 时表示 <code>-Xmx</code> 为最大可用内存的50%</p>
</li>
<li>
<p>如果没有指定 <code>JAVA_MAX_MEM_RATIO</code> 且 <code>系统内存资源</code> &#8656; 300M 则 设置 <code>-Xmx</code> 为其25%</p>
</li>
<li>
<p>如果没有指定 <code>JAVA_MAX_MEM_RATIO</code> 且 <code>系统内存资源</code> &gt; 300M 则 设置 <code>-Xmx</code> 为其50%</p>
</li>
<li>
<p>如果传入了 <code>JAVA_INIT_MEM_RATIO</code> 并且 <code>JAVA_INIT_MEM_RATIO</code>=0 则不设置 <code>-Xms</code></p>
</li>
<li>
<p>如果传入了 <code>JAVA_INIT_MEM_RATIO</code> 并且 <code>JAVA_INIT_MEM_RATIO</code>!=0 &amp; <code>-Xmx</code> 不为空 则 设置 <code>-Xms</code> 为 <code>-Xmx</code>/<code>JAVA_INIT_MEM_RATIO</code>，当 <code>JAVA_INIT_MEM_RATIO</code>=50 时表示 <code>-Xms</code> 为 <code>-Xmx</code>的50%</p>
</li>
<li>
<p>如果没有传入 <code>JAVA_INIT_MEM_RATIO</code> 则 设置 <code>JAVA_INIT_MEM_RATIO</code>=100，执行同上一步的 <code>-Xms</code> 设置规则</p>
</li>
</ul>
</div>
</li>
<li>
<p>如果JDK版本 &lt; 10 设置 <code>-XX:ParallelGCThreads</code>=&lt;可用CPU核数&gt; <code>-XX:ConcGCThreads</code>=&lt;可用CPU核数&gt; <code>-Djava.util.concurrent.ForkJoinPool.common.parallelism</code>=&lt;可用CPU核数&gt;</p>
</li>
<li>
<p>如果JDK版本 &lt; 10 设置 <code>-XX:+UseParallelGC</code> <code>-XX:GCTimeRatio</code>=4 <code>-XX:AdaptiveSizePolicyWeight</code>=90 <code>-XX:MinHeapFreeRatio</code>=40 <code>-XX:MaxHeapFreeRatio</code>=70</p>
</li>
<li>
<p>如果JDK版本 !=7 设置 <code>-XX:+ExitOnOutOfMemoryError</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>以上规则参考于： <a href="https://github.com/fabric8io-images/run-java-sh" class="bare">https://github.com/fabric8io-images/run-java-sh</a></p>
</div>
<div class="paragraph">
<p>==== 配置中心选择</p>
</div>
<div class="paragraph">
<p>由于 <code>spring-cloud-kubernetes</code> 使用的配置方案并不直观、无法实现版本留存、修改审计、配置加密（非摘要），
所以 <code>dew</code> 建议使用 <code>Spring Cloud Config</code> ，<code>dew</code> 提供了其 helm 版本，详见 <a href="#helm-chart-spring-cloud-config">[helm-chart-spring-cloud-config]</a> 。</p>
</div>
<div class="paragraph">
<p>==== Spring Cloud 项目的 Dew &amp; Gitlab CI/CD 实践</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>部署 Spring Cloud 配置中心，详见 <a href="#helm-chart-spring-cloud-config">Dew Spring Cloud 配置中心部署</a>，<a href="#dew-spring-cloud-config">Dew Spring Cloud 配置中心实例</a></p>
</li>
<li>
<p>在 Kubernetes 集群中执行<code>dew-devops.sh</code>脚本部署环境、创建项目，详见：<a href="#dew-devops-deploy">Dew DevOps 脚本部署</a></p>
</li>
<li>
<p>在 Gitlab上 创建项目</p>
</li>
<li>
<p>在项目中引入 Dew 的<code>parent-starter</code>依赖，详细请参考: <a href="#framework-quick-start-core-code-instructions">框架快速入门</a></p>
</li>
<li>
<p>添加用于触发 Gitlab Runner 的<code>.gitlab-ci.yml</code>配置文件，详见：<a href="#dew-gitlab-ci">Dew Gitlab CI 实现</a></p>
</li>
<li>
<p>添加 Dew Maven Plugin 支持的 Kubernetes 部署配置文件<code>.dew</code>，详见：<a href="#devops-configuration-dew">.dew 文件配置</a></p>
</li>
<li>
<p><code>合并代码</code>到需要部署的分支，触发 Gitlab Runner 进行项目部署</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>=== DevOps示例</p>
</div>
<div class="paragraph">
<p>==== DevOps示例 : Helloworld后端服务</p>
</div>
<div class="paragraph">
<p>本示例为Dew微服务体系的组成部分，使用说明参见：http://doc.dew.idealworld.group</p>
</div>
<div class="paragraph">
<div class="title">说明</div>
<p>此示例用于演示后端服务的自动化部署到Kubernetes，完成后推送钉钉通知。</p>
</div>
<div class="listingblock">
<div class="title">/.dew配置说明</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml"># 默认通知配置，详见 Dew的通知处理模块
notifies:
  - type: DD
    args:
      # 通知的URL，可自行修改，详见 https://open-doc.dingtalk.com/microapp/serverapi2/qf2nxq
      url: https://oapi.dingtalk.com/robot/send?access_token=8ff65c48001c1981df7d326b5cac497e5ca27190d5e7ab7fe9168ad69b103455
profiles:
  # 添加测试环境
  test:
    # 指定测试环境的namespace，此namespace需要在Kubernetes及harbor中已存在
    namespace: dew-test
  uat:
    # 指定测试环境的namespace，此namespace需要在Kubernetes及harbor中已存在
    namespace: dew-uat</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">前置准备</div>
<ol class="arabic">
<li>
<p>执行 <code>dew-devops.sh</code> 初始化项目对应的test环境（ 详见 <a href="http://doc.dew.idealworld.group/#devops-user-manual" class="bare">http://doc.dew.idealworld.group/#devops-user-manual</a> ）</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">手工执行</div>
<div class="content">
<pre># 参数设置 (win/unix)
SET/export dew_devops_kube_config=...
SET/export dew_devops_docker_host=...
SET/export dew_devops_docker_registry_url=...
SET/export dew_devops_docker_registry_username=...
SET/export dew_devops_docker_registry_password=...

# 执行如下maven命令(发布到test环境)
mvn -P devops deploy -Ddew_devops_profile=test</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Gitlab CI执行</div>
<div class="content">
<pre># Merge或Push代码到test分支</pre>
</div>
</div>
<div class="paragraph">
<p>==== DevOps示例 : Helloworld类库</p>
</div>
<div class="paragraph">
<p>本示例为Dew微服务体系的组成部分，使用说明参见：http://doc.dew.idealworld.group</p>
</div>
<div class="paragraph">
<div class="title">说明</div>
<p>此示例用于演示类库的自动化部署到Maven。</p>
</div>
<div class="listingblock">
<div class="title">/.dew配置说明</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">profiles:
  # 添加测试环境
  test:
    # 指定测试环境的namespace
    namespace: dew-test</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">手工执行</div>
<div class="content">
<pre># 参数设置 (win/unix)
SET/export dew_devops_kube_config=...
SET/export dew_devops_it_snapshotRepository_id=&lt;私库Id，如私库需要认证则此Id对应的认证信息要添加到 settings.xml中&gt;
SET/export dew_devops_it_snapshotRepository_url=&lt;私库Url&gt;

# 执行如下maven命令(发布到test环境)
mvn -P devops deploy -Ddew_devops_profile=test</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Gitlab CI执行</div>
<div class="content">
<pre># Merge或Push代码到test分支</pre>
</div>
</div>
<div class="paragraph">
<p>==== DevOps示例 : Helloworld前端</p>
</div>
<div class="paragraph">
<p>本示例为Dew微服务体系的组成部分，使用说明参见：http://doc.dew.idealworld.group</p>
</div>
<div class="paragraph">
<div class="title">说明</div>
<p>此示例用于演示前端服务的自动化部署到Kubernetes。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>前端需要添加一个pom.xml，指定为pom类型 <code>&lt;packaging&gt;pom&lt;/packaging&gt;</code> 即可。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">/.dew配置说明</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">profiles:
  # 添加测试环境
  test:
    # 指定测试环境的namespace
    namespace: dew-test</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">前置准备</div>
<ol class="arabic">
<li>
<p>执行 <code>dew-devops.sh</code> 初始化项目对应的test环境（详见 <a href="http://doc.dew.idealworld.group/#devops-user-manual" class="bare">http://doc.dew.idealworld.group/#devops-user-manual</a> ）</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">手工执行</div>
<div class="content">
<pre># 参数设置 (win/unix)
SET/export dew_devops_kube_config=...
SET/export dew_devops_docker_host=...
SET/export dew_devops_docker_registry_url=...
SET/export dew_devops_docker_registry_username=...
SET/export dew_devops_docker_registry_password=...

# 执行如下maven命令(发布到test环境)
mvn -P devops deploy -Ddew_devops_profile=test</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Gitlab CI执行</div>
<div class="content">
<pre># Merge或Push代码到test分支</pre>
</div>
</div>
<div class="paragraph">
<p>==== DevOps示例 : To-Do</p>
</div>
<div class="paragraph">
<p>本示例为Dew微服务体系的组成部分，使用说明参见：http://doc.dew.idealworld.group</p>
</div>
<div class="paragraph">
<div class="title">说明</div>
<p>此示例用于演示以下功能：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>包含modules</p>
</li>
<li>
<p>有类库、JVM服务、前端等多种类型</p>
</li>
<li>
<p>生产环境版本重用</p>
</li>
<li>
<p>自定义.dew文件</p>
</li>
<li>
<p>自定义Docker Image</p>
</li>
<li>
<p>自动化部署到Kubernetes</p>
</li>
<li>
<p>完成后推送钉钉通知</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>默认情况下Dew会视 <code>prod</code> 标识为生产环境，<code>uat</code> 为仿真环境，生产环境会重用（Docker Image重用）仿真或预发环境的最后一个版本。</p>
</div>
<div class="paragraph">
<p>本工程需要启用redis服务，配置见工程参数。</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="title">/.dew配置说明</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml"># 默认通知配置，详见 Dew的通知处理模块
notifies:
  - type: DD
    args:
      # 通知的URL，可自行修改，详见 https://open-doc.dingtalk.com/microapp/serverapi2/qf2nxq
      url: https://oapi.dingtalk.com/robot/send?access_token=8ff65c48001c1981df7d326b5cac497e5ca27190d5e7ab7fe9168ad69b103455
profiles:
  # 添加uat环境
  uat:
    # 指定仿真环境的namespace
    namespace: dew-uat
  # 添加prod环境
  prod:
    # 指定生产环境的namespace
    namespace: dew-prod</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/kernel/.dew配置说明</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">docker:
  # 使用自定义的Image
  image: openjdk:11
app:
    # 资源上限设定
    containerResourcesLimits:
      memory: "1024Mi"
      cpu: "800m"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">/notifier/.dew配置说明</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">skip: true
docker:
  # 使用自定义的Image
  image: openjdk:11</code></pre>
</div>
</div>
<div class="olist arabic">
<div class="title">前置准备</div>
<ol class="arabic">
<li>
<p>执行 <code>dew-devops.sh</code> 初始化项目对应的uat和prod环境（详见 <a href="http://doc.dew.idealworld.group/#devops-user-manual" class="bare">http://doc.dew.idealworld.group/#devops-user-manual</a> ）</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">手工执行</div>
<div class="content">
<pre># 参数设置 (win/unix)
SET/export dew_devops_kube_config=...
SET/export dew_devops_docker_host=...
SET/export dew_devops_docker_registry_url=...
SET/export dew_devops_docker_registry_username=...
SET/export dew_devops_docker_registry_password=...

# 执行如下maven命令(发布到uat环境)
mvn -P devops deploy -Ddew_devops_profile=uat -T 1C -Ddew_devops_quiet=true
# 执行如下maven命令(发布到prod环境)
mvn -P devops deploy -Ddew_devops_profile=prod -T 1C -Ddew_devops_quiet=true</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Gitlab CI执行</div>
<div class="content">
<pre># Merge或Push代码到uat分支
# Merge或Push代码到prod分支</pre>
</div>
</div>
<div class="paragraph">
<p>== Dew项目信息 Dew Project Info</p>
</div>
<div class="paragraph">
<p>=== 开发指南</p>
</div>
<div class="paragraph">
<p><code>Dew</code> 基于 Apache 2.0 license 分发，如果您要向 <code>Dew</code> 贡献代码或 Fork 为自己的分支项目请遵循许可证要求。</p>
</div>
<div class="paragraph">
<p>SCM： <a href="https://github.com/gudaoxuri/dew">https://github.com/gudaoxuri/dew</a></p>
</div>
<div class="paragraph">
<p>Issues： <a href="https://github.com/gudaoxuri/dew/issues" class="bare">https://github.com/gudaoxuri/dew/issues</a></p>
</div>
<div class="paragraph">
<p>==== 代码要求</p>
</div>
<div class="paragraph">
<p>本项目使用修改版的Google CheckStyle做为代码规范，规则文件见 <code>framework/checkstyle/checkstyle.xml</code>。</p>
</div>
<div class="paragraph">
<p>代码的变更需要有有对应的单元/集成测试。</p>
</div>
<div class="paragraph">
<p>目前项目中只有<code>DevOps</code>部分用到集成测试，对应的需要修改 <code>devops/devops-test.properties</code> 为自己的支撑环境，但请不要提交此文件。</p>
</div>
<div class="listingblock">
<div class="title">/devops/devops-test.properties示例</div>
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">#
# Copyright 2021. the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
dew_devops_docker_host=tcp://10.200.131.215:2375
# Docker registry url, nullable
dew_devops_docker_registry_url=https://harbor.dew.idealworld.group/v2
# Docker registry user name, nullable
dew_devops_docker_registry_username=dew
# Docker registry password, nullable
dew_devops_docker_registry_password=Dew123456
# Kubernetes base64 configuration
dew_devops_kube_config=YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VONVJFTkRRV0pEWjBGM1NVSkJaMGxDUVVSQlRrSm5hM0ZvYTJsSE9YY3dRa0ZSYzBaQlJFRldUVkpOZDBWUldVUldVVkZFUlhkd2NtUlhTbXdLWTIwMWJHUkhWbnBOUWpSWVJGUkZOVTFFVVhoTlZFRXpUVlJCZUU0eGIxaEVWRWsxVFVSUmQwOUVRVE5OVkVGNFRqRnZkMFpVUlZSTlFrVkhRVEZWUlFwQmVFMUxZVE5XYVZwWVNuVmFXRkpzWTNwRFEwRlRTWGRFVVZsS1MyOWFTV2gyWTA1QlVVVkNRbEZCUkdkblJWQkJSRU5EUVZGdlEyZG5SVUpCU3pWbENqUkpLekJrVG5RNVFsWm1OMWhOZWxWM2FIZGtTRlZ0WmsxWGFHdGlkelU1YVVGbmFVY3lSRGcyTTNkamNWWXhhRGswTjJ4c01rVlNRM0puWlRkM1prVUtWRklyY0ZOcVJUZGlPRWhNUlRaNE5VZEhXbkkyUkhKa1kwVnhhRFZSYzNoeUwyODVOVGxrYVNzeldYTmFNR3AwYVRSalFVNURjMGR2T0RkaFZpOUNOQXAzUmpBMmEyOXJVVU5yYlZSYVNXbG1kRWQwYW5CWlJWUkljV0phVlhwMlpYTnNRamRhY0daeWVXY3ZhWHBWVjI0M0x6VXhkVTVhZEdaclZtSkRhR0pCQ2psS1ozSnlXVFJqYTBZck1XdG5VVmxrTjFKMlRsRnVkMDQwTm5WbGJsUklhVlJaYWpONGVYVnVkbU5GYTNZd1RVNU1WV2haUXpOQ2JWcDNlVmxtTWxZS1IwaHJZbWt4VEZWa01WSlNSWFJVUTNKdWIydExPRUZ3UVV0NE4yaGpaVFpETm5OYVEwWTNWVEpvYXpWSk1qTlVUa2xJUkZGb1dGUkZka3BhTlZCbFpncFNNMDlWY0Zaak0wVkliREJPVDFGMFZ6Tk5RMEYzUlVGQllVMXFUVU5GZDBSbldVUldVakJRUVZGSUwwSkJVVVJCWjB0clRVRTRSMEV4VldSRmQwVkNDaTkzVVVaTlFVMUNRV1k0ZDBSUldVcExiMXBKYUhaalRrRlJSVXhDVVVGRVoyZEZRa0ZKZVdab1JqTmljMkZIWlRSeGQwMVdhRE14VjNCT1NTOU9URUVLZEZCc01VWkllbWxNYW5BcldVMW9MMjlyZDFKcmQzaERUbU5QWVhwRGVVUnlSbkozYVhkbE0ydG9USEExYVZwak5WTnVRMlJWUjBobVNsTjZPVEJwZWdwamNDdEViRXhQWnpKWGNUbFFObk5qTkZCV2JsaEhNRTVZUjBZMU1sSmtkRWw2Y205UE5ESkVVVWRDVTBSUGFVbHlTM2RpY25Bdk1HUTRLMWs1ZHl0WkNrSnVXVGxZZEVWNlNtOVdRMkp0YTFock5UTXlTa04xU0ZaSlVtOWpURGxUYjI1UVpIVjRNWFo0YjFJcmNuQTJRWE5VTkN0cloxRTFXbkJaVVZreVQzVUthVVJMTnpGWlFrbzBjbWxSZDBNNWJWRnJaV2RSYXpsdWFFUk9ORWhxYzIxMWJIQmFiemRJU0ZCTVZtVXZNa3BEZEhaRFUzUnVkVTFFYjNOQ1ZWRnJNZ292Ykd0b05uZzNkRlF2YWpKSU4wRldXalZMTlc5NE5FMHhPVFZ4ZEhrMFlsTmFjbmhoTWpVek5FTnpSblpJTTA1M1REZE1hMGhTYW5Sc2N6MEtMUzB0TFMxRlRrUWdRMFZTVkVsR1NVTkJWRVV0TFMwdExRbz0KICAgIHNlcnZlcjogaHR0cHM6Ly8xMC4yMDAuMTMxLjE4OjY0NDMKICBuYW1lOiBrdWJlcm5ldGVzCmNvbnRleHRzOgotIGNvbnRleHQ6CiAgICBjbHVzdGVyOiBrdWJlcm5ldGVzCiAgICB1c2VyOiBrdWJlcm5ldGVzLWFkbWluCiAgbmFtZToga3ViZXJuZXRlcy1hZG1pbkBrdWJlcm5ldGVzCmN1cnJlbnQtY29udGV4dDoga3ViZXJuZXRlcy1hZG1pbkBrdWJlcm5ldGVzCmtpbmQ6IENvbmZpZwpwcmVmZXJlbmNlczoge30KdXNlcnM6Ci0gbmFtZToga3ViZXJuZXRlcy1hZG1pbgogIHVzZXI6CiAgICBjbGllbnQtY2VydGlmaWNhdGUtZGF0YTogTFMwdExTMUNSVWRKVGlCRFJWSlVTVVpKUTBGVVJTMHRMUzB0Q2sxSlNVTTRha05EUVdSeFowRjNTVUpCWjBsSlJWUlZjbE5SV21kblowRjNSRkZaU2t0dldrbG9kbU5PUVZGRlRFSlJRWGRHVkVWVVRVSkZSMEV4VlVVS1FYaE5TMkV6Vm1sYVdFcDFXbGhTYkdONlFXVkdkekI0VDFSQk1FMVVSWGRPZWtWM1RWUmtZVVozTUhsTlJFRXdUVlJCZDA1NlJYZE5ha1poVFVSUmVBcEdla0ZXUW1kT1ZrSkJiMVJFYms0MVl6TlNiR0pVY0hSWldFNHdXbGhLZWsxU2EzZEdkMWxFVmxGUlJFVjRRbkprVjBwc1kyMDFiR1JIVm5wTVYwWnJDbUpYYkhWTlNVbENTV3BCVGtKbmEzRm9hMmxIT1hjd1FrRlJSVVpCUVU5RFFWRTRRVTFKU1VKRFowdERRVkZGUVhSdmFXOHdjbWxTU2k5QlkzQXhlVE1LUjBKbVkxaGhRbWhMTlRWek1EWk1ibEI2TmpCWGVEQnlkalZ6SzNWeVdVaFliWFYyU2pWVGNrVlpRbEpIWWtWdlRIcDVVemhYVW1KU01HdDFjbEJOUlFvMVpWUlpUR012UnpaeGNuVnVka1p4UjNSak4xaFJSMGN6VkVzdlJUSnNLMkkxZVdJeGEwTnliM2htTTNOelVFeFVVbVZDT0hFd1NrWm5iRmRpZEdjeUNsZElWVFJhUlZrNE1sbzVObkVyWkV4clZHaFJNRUV4YlZWMlUxRjZWMFlyU2xOaVNYbHNkVTV4VWxBMGExaHdZME16U1hKQlozcEdPWEZITkV0R1V6Z0tkM2xuUm5sRU9VUlJja3cyWkRGcE5qaDFVazR6YW10bFZYTTBNMHRDTlc4cldGcEhka05KY2tsR1owaDNXRUZhVkRkVE1ub3ZaRVJRZG5vcmFVaFdVQXBZYzFaUlIweEVkRGx4YWtwR2JYRk1WazlRZVVGelFuWlhWM0Z6VFZaTFpWSXJWbGhYYkRoSll6bG9iMFZWVkdOcmEyMXhRV0YzWkdNMlEzcEplbFJ5Q21FelNqRTRVVWxFUVZGQlFtOTVZM2RLVkVGUFFtZE9Wa2hST0VKQlpqaEZRa0ZOUTBKaFFYZEZkMWxFVmxJd2JFSkJkM2REWjFsSlMzZFpRa0pSVlVnS1FYZEpkMFJSV1VwTGIxcEphSFpqVGtGUlJVeENVVUZFWjJkRlFrRkRSVmRUYTB3MFkwRmFhekJsVnpScVMzTlhhVEV6YTAxSmJ5ODNMM3BZZG1aRWFBcGpTR05YYVdONlRqUndNRGs1T0RoVmVtbHdVak54YUZCMmVHaHhXR0pwTlRKS09WVlJOVkFyVUUxS05IRjJOamRSU1VGM1pHMXhlRXRzZFVORldqWk1DazVoYmtWRGNtZDVaek5QZW1kQ1dtaElUa3N4YUhob2VtdzBMME54YTBKTmNGbEJNSEprWWpKVlpUTlhiV05wV1hkc1EyUk9Ramw2ZVhKV01VUXZVa2tLZW5aTFYwUnJUMU5xV2pjMFVGWlpXbWh5VVdkWFJWVllPVWRGYlVsSlZXcFFZbXhsYTNKV1kyOXVTbmxpT1ZwV2VqZDNNbFZNVUVkTFkxcG1iMHBMYkFwWUt5OWhhVk5SYWs0NWRFazRRelEyYUd0aWFtTlFkalJwVHpJMmNtcFZSRTB2VDJsRWFuVlBLMnRFTjFaTlFqZHpWMjFTVFZkUWVGbFhTWE5rZG5wNUNtRk5Semd3VnpsMk9FMUpSbFJ4TjBsVVNVTTJjelowVld0aWFsUjVNMlZwVUhSM1ozUlFLMU5aZG1GRFVWRndiVFl6WnowS0xTMHRMUzFGVGtRZ1EwVlNWRWxHU1VOQlZFVXRMUzB0TFFvPQogICAgY2xpZW50LWtleS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJTVTBFZ1VGSkpWa0ZVUlNCTFJWa3RMUzB0TFFwTlNVbEZiMmRKUWtGQlMwTkJVVVZCZEc5cGJ6QnlhVkpLTDBGamNERjVNMGRDWm1OWVlVSm9TelUxY3pBMlRHNVFlall3VjNnd2NuWTFjeXQxY2xsSUNsaHRkWFpLTlZOeVJWbENVa2RpUlc5TWVubFRPRmRTWWxJd2EzVnlVRTFGTldWVVdVeGpMMGMyY1hKMWJuWkdjVWQwWXpkWVVVZEhNMVJMTDBVeWJDc0tZalY1WWpGclEzSnZlR1l6YzNOUVRGUlNaVUk0Y1RCS1JtZHNWMkowWnpKWFNGVTBXa1ZaT0RKYU9UWnhLMlJNYTFSb1VUQkJNVzFWZGxOUmVsZEdLd3BLVTJKSmVXeDFUbkZTVURScldIQmpRek5KY2tGbmVrWTVjVWMwUzBaVE9IZDVaMFo1UkRsRVVYSk1ObVF4YVRZNGRWSk9NMnByWlZWek5ETkxRalZ2Q2l0WVdrZDJRMGx5U1VablNIZFlRVnBVTjFNeWVpOWtSRkIyZWl0cFNGWlFXSE5XVVVkTVJIUTVjV3BLUm0xeFRGWlBVSGxCYzBKMlYxZHhjMDFXUzJVS1VpdFdXRmRzT0Vsak9XaHZSVlZVWTJ0cmJYRkJZWGRrWXpaRGVrbDZWSEpoTTBveE9GRkpSRUZSUVVKQmIwbENRVVV2SzJGbldWaEVjalI1T0RCMlFncFVVbWhKT1V4RmRscFJXa3B2Y1ZoS1NWcEVUU3RTZEhCSFJrRmlVMEV4Y0ZWeFpHeG9PV2hRZUdaNVoyZEhjRVJCYW5CYVZVbG9jbXMzYTFVNFJtbHdDa1V2T1hkSUwwWk1kVzlCUkUxNGIwTTRTalJqY25jMVpXRmxNSE51VTBwNmRrRTFUREIwZFRsalluSkRLMVJIYkhKeldERlNSMVJIZDJ4SFpTc3ZjMDRLTVVKMFIwYzVWMDlHYjB4Rk5tMTZSbkUwT1ZRek9EWmtORXhpTDJFMmRIbGFRV1pOZEVGYWNFaGhjRnBHZEVwYVZXOTJlRXRFZVVkWE56Rk9UMElyWWdwdWN6WlRaV2hRV1VZMU0wbGFXRGswYWk5NVJFeDNXRTVYT0ZNMmFGbEdORVpwY1RReVMyRkxlU3RFZVhKNVFrMTRVVzV4UzJaU1RsaDRRMlE0ZEhkeENuSjZWRGQwUldaQk1qVlljRllyU0hOemNVWjJVMVZEZDA1eFptbGxZbFprV25oSFdVc3dlbU5ZYnl0WWFuWlVVRlp3VTBkMlVrbHFaRlpOZFN0elNEQUtSak55VkZKNlZVTm5XVVZCTWpZeE5sTnRjbXhGWW1OTFIzbFFWRFJOUVVOVldFNVRabFJHU1RBMWJGWnRiVmRXU1RaTlRXRXlVSHBoWVRNeU4xcDFPUXBESzBwQlFYcFhTQ3RYVmpaaVZEQjVXbnBCU1Vwa05rY3JZbUZCZVhGMFVHaEdka1p6Y20xNWRXTk9lV2xzZURobVl6UkpVMHRLU3l0a2FrcHFOR0ZLQ2xKUlJsRk5UbkZ2VlhSblZXZHFVbE54WkRKNVkzcGFWRGcyTlM5VGJtWktRVVZ6U213dk9VdDBhSFpCZGpWWWIwdHBPWFJ1Tm5ORFoxbEZRVEZNWWpBS0syeE1kbWgwZVRWQmMwTkZZMGRNWTNKSlZTOWxTMUYyVHk5alJWbDNZMllyTjJ0aFZHZDJVMHN6Y0ZaVFUzcDZXWGhSUVVwa1NEYzNRWHBsWlVOT1RBcEphVlJoY1M5U2QweHlTalJrYlVkeVRYWmFhVVJZZVVWNFlUZDRjR1U0VldkQlpEQjFUV1pIYlRGbFIwdHBUelp6VmpKWFlrTkljME5EVm5sdmQyaHZDbUpLVGxwbVMwOUxObHBvVkZwaVUwZE9kSFJqVVdkaVRDdG1SM2t3U2s5amJqVmFZbXhPVFVObldVRTRaMjVvWnpkNmFsSjJSakZ2VWtkSmExVnFPVklLVDBSaVRXcFVja2RNYTBwTFIxSnJVR2tyV0hJemMyYzFiamxYV1dSWlIwcFBTRlI0WWxac1lUbFFlbGxCYW1SVUwxRk5RbWt4TkdGbmJ6ZFFVa2xxVHdweFNXazBVbXBhV1haUFJtTkJNRmN6VlZnd2RYQkxWMHRXU2tOUmJrUndUR0UyVlhaRU9IVXhjR2hrWjBab1JpOUJURmxoZW1sbmNIZDZUVVY2UTBoMENteHlNalY0U0ZKTU0xUkZiV3hMUVhsdWIxaFFjVkZMUW1kQ2JsWXZkblJKYURNNVFqTTVZazUxTUdoTVQySktZVzVPVEhsWWFYQlRXR3cwU1hnMFIzb0taMlJhYnpaVFdVOTJZakJrYTBwS1FVazJVakJXVEhwbE9EQmFNRkYyVUhGMFoxTmpjeXRPTkVka2JVaEZNWGRzVVU1UFUyaERNMlZwWTNNeGRIRXJNZ3BQUWpoYVdrczBTbVV5YjNrelRVbGxUVGszSzFnNFV6bG9ObUl4Y0c1c1NtcEdlblpKUkdkMlNVUkpRMDE1YzBkcFlsbGlWRlJ6VjJWRWJVNU9SVVJPQ2padFIzaEJiMGRCUVc5TVZEUmpOMGRJYkRaWlV6SjVRazlJWTJ4UU9FTTNZMnMwVDBFNE0xcFFRbmhGVkVzeGVua3hSblphVlcxb1ZGcDNlbmRJUlVFS1JEWTFUbWhVTW1SWlUwcFNXV3hKZFd0S1ptcEpTV0ZXWjNobVZHdGtTa0lyWlhOYWVtcHNXVkJFYTNWbVEzRmphWEY2UkZSNlptSlZSa29yYWpGMVpBcGhNbU00UlZCV2QyWTJRMWxLV2taYU1FZEpMMkp6VVN0Vk5XVnZZemN3ZW1FeVNtMUlhRVl5YTNocmRIUjZSME0zVTNNOUNpMHRMUzB0UlU1RUlGSlRRU0JRVWtsV1FWUkZJRXRGV1MwdExTMHRDZz09Cg==
# Repository id, must be filled out in version replacement mode
# If the repository needs authentication, the authentication information corresponding to this Id should be added to settings.xml
dew_devops_it_repository_id=dew-releases
# Snapshot  repository url, must be filled out in version replacement mode
dew_devops_it_repository_url=http://xx.xx.xx/nexus/content/repositories/releases/
# Snapshot repository id, must be filled out in version replacement mode
# If the repository needs authentication, the authentication information corresponding to this Id should be added to settings.xml
dew_devops_it_snapshotRepository_id=dew-snapshots
# Snapshot  repository url, must be filled out in version replacement mode
dew_devops_it_snapshotRepository_url=http://xx.xx.xx/nexus/content/repositories/snapshots/</code></pre>
</div>
</div>
<div class="paragraph">
<p>提交前请运行 <code>mvn clean test -P qa</code>，确认代码通过CheckStyle检查和测试。</p>
</div>
<div class="paragraph">
<p>发起 <code>Pull Request</code> 后会调用 <code>travis-ci</code> 和 <code>codacy</code> 进行自动化代码检查，如有问题不会执行 <code>Merge</code> 。</p>
</div>
<div class="paragraph">
<p>==== 环境要求</p>
</div>
<div class="paragraph">
<p><code>开发</code> 环境没有特别要求，如果需要服务间调用可使用 <code>&lt;服务名&gt;.ribbon.listOfServers=&lt;host:port&gt;</code> 的方式，详见 <code>examples/tracing-invokeX-example</code> 。</p>
</div>
<div class="paragraph">
<p><code>调试</code> 环境部分模块需要Kubernetes、Docker等服务的支持。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">环境</th>
<th class="tableblock halign-left valign-top">模块</th>
<th class="tableblock halign-left valign-top">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RabbitMQ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">cluster-rabbit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">测试RabbitMQ</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes Docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tracing-invokeX-example</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">测试服务间调用</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes Docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dew-maven-plugin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DevOps插件</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes Docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">helloworld-backend helloworld-frontend helloworld-library todo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">测试自动化部署</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Opentracing Jaeger</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">todo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">测试追踪日志</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fluentd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">todo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">测试日志采集</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prometheus Grafana</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">todo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">测试Metrics</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>如果已按 <a href="#devops-env-install">开发/测试环境安装配置</a> 完成了测试环境的安装配置， 那么可部分使用这一环境进行调试， 否则请按以下流程完成调试环境的安装配置。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>==== 调试环境安装配置（TBD）</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Kubernetes、Docker环境要求使用代理。</p>
</div>
<div class="paragraph">
<p>详见 <a href="#proxies">[proxies]</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Kubernetes安装</div>
<div class="content">
<pre># 使用minikube

# 各版本的安装见此
# https://kubernetes.io/docs/tasks/tools/install-minikube/

# 代理设置见此
# https://github.com/kubernetes/minikube/blob/master/docs/http_proxy.md
# !!!特别说明!!!

# 以上说明有问题，export HTTP_PROXY或set HTTP_PROXY只会设置到宿主环境，但在vm环境不会带入，
# 故代理的地址要直接写到 minikube start 的启动参数中
# 代理地址不能写成127.0.0.1，vm中无法解析

# windows 10 示例
minikube start \
    --registry-mirror=https://registry.docker-cn.com \

    --vm-driver=hyperv --hyperv-virtual-switch=public --memory=4096 \
    --docker-env=HTTP_PROXY=http://10.200.20.147:1080 \
    --docker-env=HTTPS_PROXY=http://10.200.20.147:1080 \
    --docker-env=NO_PROXY=localhost,127.0.0.1,10.96.0.0/12,192.168.99.1/24
# 查询kubernetes IP
minikube ip
# 安装 dashboard
minikube dashboard</pre>
</div>
</div>
<div class="listingblock">
<div class="title">RabbitMQ安装</div>
<div class="content">
<pre>minikube ssh
docker run -d --hostname rabbit --name rabbit \
    --restart=always \
    -e RABBITMQ_DEFAULT_USER=dew \
    -e RABBITMQ_DEFAULT_PASS=dew123456 \
    -p 15672:15672 \
    -p 25672:25672\
    -p 5671:5671 \
    -p 5672:5672 \
    -p 4369:4369 \
    rabbitmq:management

# 访问页面
# Visit: http://&lt;minikube ip&gt;:15672</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Opentracing Jaeger安装</div>
<div class="content">
<pre>minikube ssh
docker run -d --name jaegertracing \
    --restart=always \
    -p 5775:5775/udp \
    -p 6831:6831/udp \
    -p 6832:6832/udp \
    -p 5778:5778 \
    -p 16686:16686 \
    -p 14268:14268 \
    -p 9411:9411 \
    jaegertracing/all-in-one:latest

# 访问页面
# Visit: http://&lt;minikube ip&gt;:16686</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Prometheus、Grafana安装</div>
<div class="content">
<pre>minikube ssh

# 参考 https://prometheus.io/docs/prometheus/latest/getting_started/#configuring-prometheus-to-monitor-itself
# 示例监控的是 web-example 工程，对应的配置: framework/examples/web-example/src/main/resources/application.yml
# prometheus使用pull的方式，需要配置应用运行服务器的IP
cat &gt;&gt;./prometheus.yml &lt;&lt;EOF
scrape_configs:
  - job_name: 'dew-web-example-actuator'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
    static_configs:
    - targets: ['10.200.20.147:80']
EOF
docker run -d --name prometheus \
    --restart=always \
    -p 9090:9090 \
    -v $PWD/prometheus.yml:/etc/prometheus/prometheus.yml \
    prom/prometheus

# 访问页面
# Visit: http://&lt;minikube ip&gt;:9090

docker run -d --name=grafana \
    --restart=always \
    -p 3000:3000 \
    -e GF_SECURITY_ADMIN_USER=dew \
    -e GF_SECURITY_ADMIN_PASSWORD=dew123456 \
    grafana/grafana

# 访问页面
# Visit: http://&lt;minikube ip&gt;:3000</pre>
</div>
</div>
<div class="paragraph">
<p>==== 扩展尝试（可选）</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Windows10请开启 <code>WSL</code>，不支持WSL的Windows请安装 <code>cygwin</code>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Windows10 WSL设置</div>
<div class="content">
<pre># 开启WSL，使用linux环境操作kubernetes，以WSL ubuntu为例

# windows下的用户名
export WIN_USERNAME=i
# 为kubernetes IP，使用 ``minikube ip`` 查询
export KUBE_IP=10.200.20.220
# 为linux添加代理
export HTTP_PROXY=http://127.0.0.1:1080
export HTTPS_PROXY=http://127.0.0.1:1080
export NO_PROXY=localhost,127.0.0.1,10.96.0.0/12,192.168.99.1/24,$KUBE_IP

# 安装kubectl
curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl \
&amp;&amp; chmod +x ./kubectl \
&amp;&amp; sudo mv ./kubectl /usr/local/bin/kubectl

# 配置kubernetes集群信息
kubectl config set-cluster minikube \
    --server=https://$KUBE_IP:8443 \
    --certificate-authority=/mnt/c/Users/$WIN_USERNAME/.minikube/ca.crt
kubectl config set-credentials minikube \
    --client-certificate=/mnt/c/Users/$WIN_USERNAME/.minikube/client.crt \
    --client-key=/mnt/c/Users/$WIN_USERNAME/.minikube/client.key
kubectl config set-context minikube \
    --cluster=minikube \
    --user=minikube

kubectl config use-context minikube
kubectl get node</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Helm安装</div>
<div class="content">
<pre>curl https://raw.githubusercontent.com/helm/helm/master/scripts/get | bash
helm init
# 查询tiller是否部署完成
kubectl -n kube-system get po | grep tiller
helm list</pre>
</div>
</div>
<div class="paragraph">
<p>=== 版本</p>
</div>
<div class="paragraph">
<p>==== 通道说明</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>Dew</code>有多个版本通道，使用时请谨慎选择：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>GA</code> General Availability，正式版本，通过内部测试没有已知错误并且经过生产验证，生产环境首选！</p>
</li>
<li>
<p><code>RC</code> Release Candidate，发行候选版本，通过内部测试没有已知错误，可用于生产环境。</p>
</li>
<li>
<p><code>Beta</code> 公开测试版本，没有已知的Major类型Bug，但允许存在个别minor类型Bugs，生产环境使用需要谨慎评估！</p>
</li>
<li>
<p><code>Alpha</code> 内部测试版本，很早期的测试版本，未经过内部测试，可能存在较多Bugs，此版本类似技术预览版（Technical Preview），切 <strong>不可</strong> 用于生产环境！</p>
</li>
<li>
<p><code>SNAPSHOT</code> 快照版本，类似Nightly版本，更新频繁此不保证质量，切 <strong>不可</strong> 用于生产环境！</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>Dew</code> 版本号遵循 <a href="https://semver.org/"><code>semver</code></a> 规范。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>==== 发行记录</p>
</div>
<div class="paragraph">
<p>===== 3.0.0-RC（开发中）</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>支持 <code>Istio</code></p>
</li>
<li>
<p>支持 <code>K3s</code></p>
</li>
<li>
<p>支持 <code>GraalVM</code></p>
</li>
<li>
<p>删除 <code>Spring Cloud`支持，由 `Kubernetes/K3s + Istio</code> 替代</p>
</li>
<li>
<p>支持根据Swagger文档自动生成并上传SDk到maven仓库（By sdkgen-maven-plugin 插件）</p>
</li>
<li>
<p>支持 OpenAPI V3</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>依赖包升级 Spring Boot:2.3.0.RELEASE</p>
</li>
<li>
<p>使用 <code>block list</code> 代替 <code>black list</code></p>
</li>
<li>
<p>使用 <code>springdoc-openapi</code> 替换 <code>springfox-swagger</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 2.1.0-RC</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>支持自定义annotations/labels/env</p>
</li>
<li>
<p>JDK升级到11</p>
</li>
<li>
<p>依赖包升级 Spring Boot:2.2.4.RELEASE，Spring Cloud:2.2.1.RELEASE，……</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>优化Docker镜像打包流程</p>
</li>
<li>
<p>优化项目镜像复用发布流程</p>
</li>
<li>
<p><code>swagger-bootstrap-ui</code> 替换回 <code>springfox-swagger-ui</code></p>
</li>
<li>
<p>包名由 <code>ms.dew</code> 更改为 ``group.idealworld.dew</p>
</li>
<li>
<p>移除 <code>auth</code> 组件，该组件由功能更丰富的 <a href="https://github.com/ideal-world/dew-saas/tree/master/apps/ident" class="bare">https://github.com/ideal-world/dew-saas/tree/master/apps/ident</a> 取代</p>
</li>
<li>
<p>多项细节优化</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 2.0.0-RC</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>升级到Spring Boot 2.x</p>
</li>
<li>
<p>全面支持Kubernetes容器化微服务架构</p>
</li>
<li>
<p>引入DevOps流程</p>
</li>
<li>
<p>独立通知功能到<code>notification</code></p>
</li>
<li>
<p>支持MQTT的MQ实现</p>
</li>
<li>
<p>支持多个Redis连接 <a href="#framework-user-manual-cluster-redis-mutli-connection">多实例支持</a></p>
</li>
<li>
<p>支持简单的基于角色的URL拦截功能</p>
</li>
<li>
<p>支持全局请求内容中字符串自动去前后空格（ <code>dew.basic.format.auto-trim-from-req = true</code> ）</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>核心模块通过<code>checkstyle</code>检查</p>
</li>
<li>
<p><code>dew-jdbc</code> 被移除，请直接使用其它数据库管理工具</p>
</li>
<li>
<p><code>cluster-spi-eureka</code> 被移除，请用 <code>cluster-spi-redis</code> 代替其集群选举功能</p>
</li>
<li>
<p>权限认证Token处理优化 <a href="#framework-user-manual-auth">权限认证</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">迁移指南见 <a href="#dew-2-migration-guide">[dew-2-migration-guide]</a></div>
<p>===== 1.5.1-RC</p>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>升级 <code>dew-common</code> 允许请求与响应编码不同</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>修复 <code>Dew.Util.getRealIP</code> 错误</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.5.0-RC</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>使用小泰科技Fork版本做为开源版本</p>
</li>
<li>
<p>添加领导者选举的Redis实现</p>
</li>
<li>
<p>添加消息通知（钉钉或邮件）</p>
</li>
<li>
<p>添加生成系统级（多服务）统一离线文档功能</p>
</li>
<li>
<p>添加MQ消费的HA功能</p>
</li>
<li>
<p>默认使用micrometer做为指标采集工具</p>
</li>
<li>
<p>添加对Scala的支持</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>分布式锁中删除lock、lockWithFun操作</p>
</li>
<li>
<p>分布式锁由可重入改为不可重入</p>
</li>
<li>
<p>redis增加hash incr操作 和 hash decr操作</p>
</li>
<li>
<p>增加swagger-bootstrap-ui，优化swaggerUI的显示</p>
</li>
<li>
<p>spring-boot升级至1.5.13.RELEASE版本</p>
</li>
<li>
<p>spring-cloud升级到Edgware.SR4版本</p>
</li>
<li>
<p>dew-common升级到1.4.7版本</p>
</li>
<li>
<p>boot-starter默认启用HTTP服务</p>
</li>
<li>
<p>移除ShardingJDBC的内容</p>
</li>
<li>
<p>移除服务脚手架功能</p>
</li>
<li>
<p>移除mybatis-starter模块</p>
</li>
<li>
<p>暂时移除Dew JDBC模块</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>修复指标采集内存溢出问题</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">迁移指南（从1.3.4-RC到此版本）</div>
<ul>
<li>
<p>配置变更： 拆分<code>dew.cluster.dist</code> 为 <code>dew.cluster.lock</code>和<code>dew.cluster.map</code></p>
</li>
<li>
<p>配置变更： <code>dew.cluster.election.config.election-period-sec</code> to <code>dew.cluster.config.election-period-sec</code></p>
</li>
<li>
<p>功能变更： 领导者选举、分布式锁、分布式Map的实例化方式由 <code>dew.cluster.election/lock/map</code> 修改成 <code>dew.cluster.election/lock/map.instance(&#8230;&#8203;)</code></p>
</li>
<li>
<p>功能变更： 领导者选举<code>isLeader</code>接口需要等待选举产生后再返回（之前逻辑是每次启动时会设置成false再执行选举）</p>
</li>
<li>
<p>功能变更： 相同<code>Dew.Info.instance</code>的实例在选举过期周期内重启任能保持原先状态</p>
</li>
<li>
<p>功能变更： 移除服务脚手架，需要手工添加需要的接口服务</p>
</li>
<li>
<p>功能变更： 移除mybatis-starter模块，请使用mybatis官方方案</p>
</li>
<li>
<p>功能变更： swagger-ui.html 变更成 doc.html</p>
</li>
<li>
<p>功能变更： <code>Dew.Info.instance</code>由<code>UUID</code>修改成<code>服务名@Profile@IP:端口</code></p>
</li>
<li>
<p>功能变更： 升级后的Tomcat版本不支持Host中带有'_'这种非规范符号</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.3.4-RC</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>rabbitmq 增加topic exchange</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.3.2-RC</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>去掉logback-es依赖，使用logstash从日志文件进行采集</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.3.1-RC</p>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>#93 修复mybatis-starter对于sharding-jdbc数据源的强制加载</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.3.0-RC</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>#87 局部使用sharding-jdbc，mybatis实现，增加mybatis-starter模块</p>
</li>
<li>
<p>#89 支持配置提示</p>
</li>
<li>
<p>#91 Dew实例加载机制优化</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>#82 metrics指标增加线程、内存、cpu、磁盘等统计</p>
</li>
<li>
<p>#86 ErrorController增加zuul日志追踪支持</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>#92 修复logback-elasticsearch日志压力过大时导致的内存泄漏</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">升级指南</div>
<ol class="arabic">
<li>
<p>修改pom.xml中dew版本号为1.3.0-RC</p>
</li>
<li>
<p>1.3.0-RC版本中已移除启动类配置，直接用<code>@SpringBootApplication</code>或<code>@SpringCloudApplication</code></p>
</li>
<li>
<p>启动类需要的注解不要忘记自行添加，如<code>@EnableTransactionManagement</code>、<code>@EnableScheduling</code></p>
</li>
<li>
<p>新增的mybatis-starter模块，详见使用说明</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>===== 1.2.2-RC</p>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>#45 邮件通知修正</p>
</li>
<li>
<p>#85 日志配置优化</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.2.1-RC</p>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>#38 RabbitMQ消息未设置持久化</p>
</li>
<li>
<p>使用 统一响应——协议无关 类型时，降级HTTP状态码改为500</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.2.0-RC</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>#75 添加幂等处理功能， #77 可选策略类型Bloom Filter尚在开发中</p>
</li>
<li>
<p>#72 实现针对服务整体及每个接口的TPS、最大/平均/90%响应时间Metrics统计</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>#68 支持自定义离线文档文件名</p>
</li>
<li>
<p>#70 更友好地获取本机Host</p>
</li>
<li>
<p>#76 cluster.cache 支持更多类型的操作</p>
</li>
<li>
<p>#53 统一响应——协议无关 降级由 <code>1000</code> 改成 <code>555</code> 以提升兼容性</p>
</li>
<li>
<p>#79 增加是否启用默认文档配置</p>
</li>
<li>
<p>#80 增加注解启用Dew功能</p>
</li>
<li>
<p>Swagger文档去除全局token参数</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>#43 swagger2markup-maven-plugin 在使用 spring.content-path 无效</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">从 <code>1.1.0-RC</code> 迁移到 <code>1.2.0-RC</code></div>
<ol class="arabic">
<li>
<p>使用 <code>统一响应——协议无关</code> 类型时，UI端由原来只需要获取200状态下的数据改成需要获取 200 和 555 状态下的数据，两者对UI端没有区别。( @See <a href="https://rep.360taihe.com/csp/dew-framework/issues/53" class="bare">https://rep.360taihe.com/csp/dew-framework/issues/53</a> )</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>===== 1.1.0-RC</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>[功能] #45 支持服务调用（ <code>Hystrix</code> ）异常邮件通知</p>
</li>
<li>
<p>[功能] #51 适配新版 <code>用户权限中心</code> SDK</p>
</li>
<li>
<p>[功能] #59 #49 #15 统一日志规范，适配 <code>sleuth</code> 日志到 <code>ES</code></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>[优化] #53 统一响应——协议无关 类型的http返回码由统一的200改成 <code>200</code> 或 <code>1000</code> ，前者表示操作成功或不需要降级的错误，后者表示需要做降级（Hystrix fallback）的错误</p>
</li>
<li>
<p>[优化] #50 <code>Dew JDBC</code> 更好地支持没有 <code>Entity</code> 注解的对象</p>
</li>
<li>
<p>[优化] #52 对于java8时间，url参数转换支持String转LocalDateTime,LocalDate、LocalTime,long转LocalDateTime(但json数据不支持)，long转Instant</p>
</li>
<li>
<p>[优化] #55 #58 其它一些优化</p>
</li>
</ul>
</div>
<div class="olist arabic">
<div class="title">从 <code>1.1.0-beta1</code> 迁移到 <code>1.1.0-RC</code></div>
<ol class="arabic">
<li>
<p>使用 <code>统一响应——协议无关</code> 类型时，UI端由原来只需要获取200状态下的数据改成需要获取 200 和 1000 状态下的数据，两者对UI端没有区别。( @See <a href="https://rep.360taihe.com/csp/dew-framework/issues/53" class="bare">https://rep.360taihe.com/csp/dew-framework/issues/53</a> )</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>===== 1.1.0-beta1</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>[功能] #19 支持局部 <code>ShardingJDBC</code>(由于ShardingJDBC 2.0还未RC，测试发现存在较多问题，此功能需要等待官方RC)</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>[优化] 支持Java8时间处理</p>
</li>
<li>
<p>[优化] #34 模块Spring化，<code>boot-core</code> 更名为 <code>boot-starter</code> , <code>cloud-core</code> 更名为 <code>cloud-starter</code></p>
</li>
<li>
<p>[优化] #40 <code>Dew JDBC</code> 独立成 <code>jdbc-starter</code> , 确保核心模块 <code>boot-starter</code> 更轻量</p>
</li>
<li>
<p>[优化] <code>Dew JDBC</code> 性能优化</p>
</li>
<li>
<p>[文档] #47 添加性能调优章节</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>[修正] 统一错误拦截返回指定为 <code>MediaType=APPLICATION_JSON_UTF8</code> 以解决 <code>Feign</code> 调用解码错误</p>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">从 <code>1.0.0-RC/betaX</code> 迁移到 <code>1.1.0</code></div>
<p><code>1.1.0</code> 修正了 <code>1.0.0</code> 版本的几个设计缺陷，需要做如下的迁移操作：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maven: <code>Dew</code> 框架的版本修正成 <code>1.1.0-X</code>，目前是 <code>1.1.0-beta1</code></p>
</li>
<li>
<p>Maven: <code>boot-core</code> 更名为 <code>boot-starter</code> , <code>cloud-core</code> 更名为 <code>cloud-starter</code></p>
</li>
<li>
<p>核心代码: <code>com.tairanchina.csp.dew.Dew</code> 包路径改成 <code>com.tairanchina.csp.dew.Dew</code></p>
</li>
<li>
<p><code>Dew JDBC</code> 模块（使用MyBatis等其它持久化框架的项目可以忽略）</p>
<div class="ulist">
<ul>
<li>
<p><code>SafeEntity</code> 的创建/更新时间 由 <code>Date</code> 换成了 <code>LocalDateTime</code></p>
</li>
<li>
<p>所有 <code>entity</code> 包 迁移到 <code>com.tairanchina.csp.dew.jdbc.entity</code></p>
</li>
<li>
<p>使用 <code>JdbcTemplate</code> 原生方法时 原来是： <code>Dew.ds().jdbc.xx</code> ，需要修改成 <code>((DewDS)Dew.ds).jdbc.xx</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.0.0-RC</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>[功能]支持新版用户权限中心认证适配(* 新版用户权限中心Release后，此功能代码会有一定变更)</p>
</li>
<li>
<p>[功能]新增SqlBuilder用于快速构建SQL语句</p>
</li>
<li>
<p>[移除]由于 Spring Cloud Thrift RPC 测试不够充分，此版本中暂时移除</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>[功能]支持rabbit confirm(单条)模式</p>
<div class="literalblock">
<div class="content">
<pre>((RabbitClusterMQ)Dew.cluster.mq).publish(String topic, String message, boolean confirm)
((RabbitClusterMQ)Dew.cluster.mq).request(String address, String message, boolean confirm)</pre>
</div>
</div>
</li>
<li>
<p>[功能]支持 <code>EnabledColumn</code> 结果反转，EnabledColumn用于标识是否启用状态的注解，默认是true是否用，false是禁用，但有些情况下状态字段会使用`del_flag`表示是否删除，这时需要设置结果反转</p>
</li>
<li>
<p>[功能]统一Body及Url Path/Query的异常捕获</p>
</li>
<li>
<p>[功能] <code>tryLock</code> 支持重入</p>
</li>
<li>
<p>[测试]引入 <code>embedded redis</code> 以支持单元测试</p>
</li>
<li>
<p>[文档]添加 以宠物商店为例的 <code>新手入门</code> 章节</p>
</li>
<li>
<p>[修改]原 <code>dew.dao.base-package</code> 改成 <code>dew.jdbc.base-packages</code> 支持多个路径</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>修正Redis锁 <code>Unlock</code> 处理的线程问题</p>
</li>
<li>
<p>修正jacoco单元测试覆盖率偏少的问题</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.0.0-beta5</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>添加服务调用限制（可定义A服务不允许B服务调用，防止服务双向依赖） e.g.</p>
<div class="literalblock">
<div class="content">
<pre>dew.security.exclude-services:
 - serviceB
 - serviceC</pre>
</div>
</div>
</li>
<li>
<p>添加对Thrift的支持</p>
</li>
<li>
<p>支持集群Leader Election（非严格模式）</p>
</li>
<li>
<p>整合Spring Boot Cache</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>优化CURD脚手架</p>
</li>
<li>
<p>支持UUID形式的主键</p>
</li>
<li>
<p>优化注解自定义查询（ <code>@Select</code> ），通过测试</p>
</li>
<li>
<p>支持自定义异常配置，见 <code>异常处理</code> 章节</p>
</li>
<li>
<p>添加Bean分组校验说明，见 <code>异常处理</code> 章节</p>
</li>
<li>
<p>添加 <code>Sonar</code> 代码质量检查，配置 <code>sonar.host.url</code> 执行 <code>mvn clean verify sonar:sonar</code></p>
</li>
<li>
<p>【需要迁移】使用Druid数据库连接池（注意数据库连接配置变更）</p>
</li>
<li>
<p>【需要迁移】删除 <code>DaoImpl</code> 兼容性类</p>
</li>
<li>
<p>【需要迁移】将 <code>Dew.e</code> 移到 <code>Dew.E.e</code>，添加 <code>Dew.E.checkXX`异常检查方法，见 `异常处理</code> 章节</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Fixed</div>
<ul>
<li>
<p>修正事务失败，重试成功后还是被回滚的问题</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>===== 1.0.0-beta4</p>
</div>
<div class="ulist">
<div class="title">Features</div>
<ul>
<li>
<p>整合 <code>Spring boot admin</code> 与 <code>Turbine</code>，可直观的监控各个性能及访问指标</p>
</li>
<li>
<p>添加实验功能：使用注解自定义查询（ <code>@Select</code> ）</p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">Improvement</div>
<ul>
<li>
<p>添加了几个自定义验证方式</p>
</li>
<li>
<p>添加性能测试报告</p>
</li>
<li>
<p>移除 <code>DaoImpl</code> ，改用接口 <code>DewDao</code></p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
为确保兼容， <code>DaoImpl</code> 在这一版本中未物理移除，如有条件请迁移至 <code>DewDao</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Fixed</div>
<p>===== 1.0.0-beta3</p>
</div>
<div class="olist arabic">
<div class="title">Features</div>
<ol class="arabic">
<li>
<p>Cluster的MQ添加RabbitMQ SPI</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Improvement</div>
<ol class="arabic">
<li>
<p>支持自定义http错误码( <code>Dew.e(String code, E ex, StandardCode customHttpCode)</code> )</p>
</li>
<li>
<p>对加了字段校验(@Valid)的对象，如果检验失败会返回错误详细</p>
</li>
<li>
<p>开放将ResultSet转成对象的方法( <code>ds.convertRsToObj(Map&lt;String, Object&gt; rs, Class&lt;E&gt; entityClazz)</code> )</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Fixed</div>
<p>===== 1.0.0-Beta2</p>
</div>
<div class="olist arabic">
<div class="title">Features</div>
<ol class="arabic">
<li>
<p>支持生成Html及PDF版本的离线文档</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Improvement</div>
<ol class="arabic">
<li>
<p>添加Dubbo整合示例，提供Dubbo服务提供无法处理`声明式事务`的方案</p>
</li>
<li>
<p>完善文档并改用asciidoc格式</p>
</li>
<li>
<p>统一依赖管理</p>
</li>
<li>
<p><code>parent</code> 中添加公司maven库</p>
</li>
<li>
<p>Hazelcast Client升级到3.8.2</p>
</li>
<li>
<p>Dew-Common升级到1.3.7</p>
</li>
</ol>
</div>
<div class="paragraph">
<div class="title">Fixed</div>
<p>===== 1.0.0-beta1</p>
</div>
<div class="olist arabic">
<div class="title">Features</div>
<ol class="arabic">
<li>
<p>多数据源支持，详见说明文档`多数据源支持`章节</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
原`Dew.ds.xx`接口弃用，改为`Dew.ds().xx`，如需要使用其它数据源请使用`Dew.ds(&lt;DS Name&gt;).xx`
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Improvement</div>
<ol class="arabic">
<li>
<p>新增`mybatisplus-example`</p>
</li>
<li>
<p>改善`Swagger`文档支持</p>
</li>
<li>
<p>新增销毁时间支持：<code>boolean tryLock(long waitMillSec, long leaseMillSec)</code></p>
</li>
<li>
<p>锁的等待、销毁时间单位由原来的`秒`改成`毫秒`</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">Fixed</div>
<ol class="arabic">
<li>
<p>修正`tryLock`锁（`Redis`实现），锁被其它线程或JVM占用时等待时间的计算错误</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>=== 路线图</p>
</div>
<div class="ulist">
<ul>
<li>
<p>3.0.0</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>支持GraalVM</p>
</li>
<li>
<p>支持Service Mesh</p>
</li>
<li>
<p>支持K3s</p>
</li>
<li>
<p>支持Swagger转SDK</p>
</li>
<li>
<p>去除Spring Cloud依赖</p>
</li>
</ol>
</div>
</li>
<li>
<p>2.1.0</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>支持Java 11</p>
</li>
</ol>
</div>
</li>
<li>
<p>2.0.0</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>升级到Spring Boot 2.x</p>
</li>
<li>
<p>实现兼容Spring Cloud与Istio的部署、监控架构</p>
</li>
<li>
<p>引入DevOps流程</p>
</li>
</ol>
</div>
</li>
<li>
<p>1.5.0</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>迁移小泰科技Fork版本到开源版本</p>
</li>
<li>
<p>Review及优化代码去除不常用功能</p>
</li>
</ol>
</div>
</li>
<li>
<p>1.x</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>实现核心功能，为公司各项目的研发提供能力支撑</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>== 附录 Appendix</p>
</div>
<div id="middleware" class="paragraph">
<p>=== 常用中间件安装配置</p>
</div>
<div class="paragraph">
<p>==== PostgreSql</p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">wget https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-7-x86_64/pgdg-redhat96-9.6-3.noarch.rpm

rpm -Uvh pgdg-redhat96-9.6-3.noarch.rpm
yum install -y postgresql96-server

/usr/pgsql-9.6/bin/postgresql96-setup initdb

vi /var/lib/pgsql/9.6/data/postgresql.conf
-
listen_addresses='*'
-

vi /var/lib/pgsql/9.6/data/pg_hba.conf
-
host  all  all 0.0.0.0/0 md5
-

systemctl enable postgresql-9.6.service
systemctl start postgresql-9.6.service

su - postgres
psql -U postgres
-
ALTER USER postgres WITH PASSWORD 'Dew!123456';
-</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">HA配置</div>
<div class="content">
<pre># @see https://www.postgresql.org/docs/9.6/high-availability.html</pre>
</div>
</div>
<div class="paragraph">
<p>==== Redis</p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">yum install -y epel-release
yum -y install redis
vi /etc/redis.conf
-
# 注释
# bind 127.0.0.1
# 开启密码
requirepass Dew!123456
-
systemctl start redis</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">HA配置</div>
<div class="content">
<pre># @see https://redislabs.com/redis-features/high-availability</pre>
</div>
</div>
<div class="paragraph">
<p>==== MySQL</p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">wget https://repo.mysql.com//mysql57-community-release-el7-11.noarch.rpm
rpm -Uvh mysql57-community-release-el7-11.noarch.rpm
yum install -y mysql-community-server

# 修改编码
vi /etc/my.cnf
-
[client]
default-character-set = utf8

[mysqld]
default-storage-engine = INNODB
character-set-server = utf8
collation-server = utf8_general_ci
-

systemctl start mysqld

# 获取初始密码
grep 'temporary password' /var/log/mysqld.log
mysql -uroot -p &lt;获取到的密码&gt;
-
# 修改密码
ALTER USER 'root'@'localhost' IDENTIFIED BY 'Dew!123456';
# 远程访问(仅测试用)
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'Dew!123456' WITH GRANT OPTION;
exit;
-</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">HA配置</div>
<div class="content">
<pre># @see https://dev.mysql.com/doc/mysql-ha-scalability/en/</pre>
</div>
</div>
<div class="paragraph">
<p>==== Mongo</p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat &gt;&gt;/etc/yum.repos.d/mongodb-org-4.0.repo &lt;&lt;EOF
[mongodb-org-4.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/\$releasever/mongodb-org/4.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc
EOF

yum install -y mongodb-org

mkdir -p /data/mongo
chown -R mongod:mongod  /data/mongo

mongod --port 27017 --dbpath /data/mongo

# 在另一个终端中执行
mongo --port 27017
-
use admin
# 修改密码
db.createUser(
  {
    user: "dew",
    pwd: "Dew!123456",
    roles: [ { role: "userAdminAnyDatabase", db: "admin" }, "readWriteAnyDatabase" ]
  }
)
-

# 支持远程访问
mongod --auth --port 27017 \
    --dbpath /data/mongo \
    --logpath /var/log/mongo \
    --bind_ip 0.0.0.0 \
    --fork</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">HA配置</div>
<div class="content">
<pre># @see https://docs.mongodb.com/manual/core/replica-set-high-availability/</pre>
</div>
</div>
<div class="paragraph">
<p>==== Dnsmasq</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
dnsmasq为轻量级的DNS解析工具，也可用类似的工具替代。
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">yum install -y dnsmasq
systemctl enable dnsmasq
systemctl start dnsmasq

# 编辑本机的 /etc/hosts 添加映射，E.g.
-
x.x.x.x gitlab.dew.idealworld.group
x.x.x.x config.dew.idealworld.group
x.x.x.x harbor.dew.idealworld.group
x.x.x.x maven.dew.idealworld.group
x.x.x.x minio.dew.idealworld.group
x.x.x.x nfs.dew.idealworld.group
x.x.x.x es.dew.idealworld.group # IP为 group=devops 的任意一台Kubernetes Node节点
x.x.x.x kibana.dew.idealworld.group # IP为 group=devops 的任意一台Kubernetes Node节点
x.x.x.x prometheus.dew.idealworld.group # IP为 group=devops 的任意一台Kubernetes Node节点
x.x.x.x alertmanager.dew.idealworld.group # IP为 group=devops 的任意一台Kubernetes Node节点
x.x.x.x grafana.dew.idealworld.group # IP为 group=devops 的任意一台Kubernetes Node节点
x.x.x.x jaeger.dew.idealworld.group # IP为 group=devops 的任意一台Kubernetes Node节点
...
-

# 编辑所有容器服务节点，加上dnsmasq节点的IP
vi /etc/resolv.conf
-
nameserver x.x.x.x # IP当前节点 应放在所有nameserver的最上面
-

# TIP: 以上设置在节点重启后可能被重置，更好的做法见：
# @see https://unix.stackexchange.com/questions/163831/nameservers-erased-after-systemctl-restart-network-service
# 方法一：
#   修改/etc/resolv.conf之后，执行
#   sudo chattr +i /etc/resolv.conf
#   可以通过重启网络查看是否被重置
#   service network restart
#   cat /etc/resolv.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>==== NTPDate
TIP: ntpdate用于服务器间时间同步。</p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 在各节点安装
yum install -y ntp
# 修改个节点/etc/crontab文件
echo '*/1 * * * * root ntpdate cn.pool.ntp.org' &gt;&gt; /etc/crontab</code></pre>
</div>
</div>
<div class="paragraph">
<p>==== Minio</p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mkdir -p /opt/minio &amp;&amp; cd /opt/minio
wget https://dl.minio.io/server/minio/release/linux-amd64/minio
chmod +x minio
./minio server /mnt/data

# 输出内容示例如下：
# AccessKey: F1HR1NUAPVQVX3UPV73P
# SecretKey: 0+vzU8IK+UjJTepBEiAt9x7QO5k+vYRW2KpISWVs
#
# Browser Access:
#    http://10.200.10.5:9000  http://172.17.0.1:9000 ...

# 再执行
nohup ./minio server /mnt/data &amp;

# 添加域名到客户机hosts并访问 http://minio.dew.idealworld.group:9000
# 修改访问AccessKey和SecretKey， e.g. dew / Dew123456
# 创建名为 app-cache 的bucket用于缓存gitlab ci runner(或其它CI/CD服务）的构建缓存</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">HA配置</div>
<div class="content">
<pre># @see https://docs.min.io/docs/distributed-minio-quickstart-guide.html</pre>
</div>
</div>
<div class="listingblock">
<div class="title">多用户配置</div>
<div class="content">
<pre># @see https://docs.min.io/docs/minio-multi-user-quickstart-guide.html</pre>
</div>
</div>
<div class="paragraph">
<p>==== NFS</p>
</div>
<div class="listingblock">
<div class="title">安装配置</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">yum install -y nfs-utils
mkdir -p /data/nfs
chmod 755 /data/nfs

mkdir -p /data/nfs/

vi /etc/exports
-
/data/nfs     *(rw,sync,no_root_squash,no_all_squash)
-

systemctl enable rpcbind
systemctl enable nfs-server
systemctl start rpcbind
systemctl start nfs-server

showmount -e localhost</code></pre>
</div>
</div>
<div class="quoteblock">
<div class="title">常见问题</div>
<blockquote>
<div class="paragraph">
<p>Kubernetes使用NFS做为PV时，报错 <code>kubernetes mount: wrong fs type, bad option, bad superblock</code></p>
</div>
</blockquote>
</div>
<div class="literalblock">
<div class="content">
<pre>各节点执行 yum install -y nfs-utils</pre>
</div>
</div>
<div class="paragraph">
<p>==== GlusterFS
TIP: 安装见：https://github.com/gluster/gluster-kubernetes/blob/master/docs/setup-guide.md
 <a href="https://github.com/gluster/gluster-kubernetes#quickstart" class="bare">https://github.com/gluster/gluster-kubernetes#quickstart</a></p>
</div>
<div class="listingblock">
<div class="title">使用StorageClass</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># 注意在各节点安装 glusterfs-fuse
yum install glusterfs-fuse

# 创建 StorageClass
# @See https://kubernetes.io/docs/concepts/storage/storage-classes/#glusterfs
cat &lt;&lt;EOF | kubectl apply -f -
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: gluster-2replicas-sc
provisioner: kubernetes.io/glusterfs
parameters:
  resturl: "http://gluster.dew.idealworld.group"
  restuser: "dew"
  restuserkey: "Dew123456"
  volumetype: "replicate:2"
allowVolumeExpansion: true
EOF
# 创建 PVC
cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
 name: dew-gluster-pvc
 annotations:
   volume.beta.kubernetes.io/storage-class: gluster-2replicas-sc
spec:
 accessModes:
  - ReadWriteOnce
 resources:
   requests:
     storage: 5Gi
EOF
# 查看创建结果，会发现PV已自动创建
kubectl get pv,pvc</code></pre>
</div>
</div>
<div id="dew-2-migration-guide" class="paragraph">
<p>=== Dew 2.x Migration guide</p>
</div>
<div class="paragraph">
<p>本手册适用于从原生 Spring Cloud 项目及 Dew 1.x 项目迁移到 Dew 2.x 的操作说明。</p>
</div>
<div class="paragraph">
<p>==== 初始准备</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><input type="checkbox" data-item-complete="0"> 使用 <code>dew-devops.sh</code> 初始化集群并创建项目</p>
<div class="literalblock">
<div class="content">
<pre>curl -O https://raw.githubusercontent.com/gudaoxuri/dew/master/devops/sh/dew-devops.sh
sh dew-devops.sh
# 选择对应操作，根据提示操作即可
# 选择 1 进行集群初始化
# 选择 2 安装 Gitlab runner
# 选择 3 创建项目：为项目创建namespace、ingress、拉取镜像的secret；对应的 Harbor 账户和镜像仓库等</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
如使用Jenkins进行部署，可跳过选项2，详见：<a href="#dew-jenkins-pipeline">Dew Jenkins Pipeline 部署</a>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>dew-devops.sh 2.0.x 到 Dew 2.1.X 的变更记录</p>
<div class="ulist">
<ul>
<li>
<p>支持不同 profile 使用相同的 harbor project<br>
namespace 由&lt;profile&gt;-&lt;project&gt;组成，如果 profile 为空，namespace 为&lt;project&gt;</p>
</li>
<li>
<p>支持更新已存在的 namespace 下的 secret/dew-registry</p>
</li>
<li>
<p>创建 harbor project的时候，可选是否把project进行公开</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
因 Dew DevOps 2.0.x 到 2.1.X 的变更，原有namespace下的 secret/dew-registry 需要手动更新，并在 harbor 上创建对应的project。
</td>
</tr>
</table>
</div>
<div id="dew-spring-cloud-config" class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-square-o"></i> 安装并设置Spring Cloud Config</p>
<div class="literalblock">
<div class="content">
<pre># 添加helm库
helm repo add helm-dew-spring-cloud-config https://raw.githubusercontent.com/gudaoxuri/dew/master/devops/chart/dew-spring-cloud-config/
# 安装，注意域名要能被Kubernetes Pod访问
helm install helm-dew-spring-cloud-config/dew-spring-cloud-config --name dew-spring-cloud-config --namespace devops \
    --set ingress.hosts={config.dew.idealworld.group}
# 修改配置，修改后需要删除Pod以实现重启获取最新配置
kubectl -n devops edit cm custom-config
# e.g.
# spring:
#   cloud:
#     config:
#       server:
#         git:
#           uri: https://gitlab.dew.idealworld.group/env/dew.git
#           username: cdman
#           password: cdman123
#   security:
#     user:
#       name: dew
#       password: dew!123456
#
# encrypt:
#   key: dsffjs%^skeSfS@#</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>==== 迁移步骤</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><input type="checkbox" data-item-complete="0"> [Spring Boot] Spring boot 1.x 迁移到 Spring boot 2.x</p>
<div class="literalblock">
<div class="content">
<pre># @see https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-2.0-Migration-Guide</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>######################### 特别注意 ########################</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># 关系型数据库连接池默认由Tomcat改为Hikari，对应的配置示例：
spring:
  datasource:
    url: jdbc:mysql://...
    username: ...
    password: "{cipher}..."
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      ...
# MySQL默认的client升级到8.x 注意时区设置及驱动名变更(com.mysql.cj.jdbc.Driver)</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># Hikari连接池 datetime类型有时间差问题，解决方案如下：
  1. 在URL配置中加上 useTimezone=true&amp;serverTimezone=GMT%2B8(推荐使用这种)
  2. 或者修改数据库time_zone</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># Redis的客户端默认由Jedis改为Lettuce，对应的配置示例：
redis:
  host: ...
  port: 6379
  password: "{cipher}..."
  database: 1
  lettuce:
    pool:
      max-active: 200
      max-wait: 300
      max-idle: 50
      min-idle: 10</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># tomcat容器配置由http变更为servelet，对应的配置示例如下：
spring:
  servlet:
    multipart:
      enabled: true
      max-file-size: 100MB
      max-request-size: 100MB</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># actuators被重构，修改见：https://www.baeldung.com/spring-boot-actuators</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># Cache不再支持Guava，替换为Caffeine，见： https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-caching.html#boot-features-caching-provider-caffeine</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># 配置值不能为空，e.g.
csp:
  sdk:
    basic:
      app-secret: "{cipher}..."
      token-expire-ms:  # 错误，值不能为空</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre># 使用Springboot定时任务需要在启动类上加上@EnableScheduling</pre>
</div>
</div>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew Framework] 修改 <code>dew-parent</code> 的版本号到最新版本</p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew Framework] 使用IDE全局查询替换 <code>com.tairanchina.csp.dew</code> 为 <code>group.idealworld.dew</code></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew Framework] 鉴权修改，详见 <a href="#devops-best-practices-auth">鉴权处理</a></p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew Framework] dew-common 升级到 1.5.x , 核心方法的异常均改为非受检异常，继承自RuntimeException以方便Stream下使用，业务中部分捕获异常需要修改</p>
<div class="literalblock">
<div class="content">
<pre>由于Dew 2.x 不推荐引入独立的服务网关，故需要对鉴权做一定的修改 。</pre>
</div>
</div>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew DevOps] 删除所有 <code>eureka</code> / <code>zuul</code> 相关的配置</p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew DevOps] 服务发现使用 spring-cloud-starter-kubernetes-ribbon ,各服务的服务名为spring.application.name的值。注意服务名为小写。</p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew DevOps] 修改项目中的 <code>Spring Cloud Config</code> 配置</p>
<div class="literalblock">
<div class="content">
<pre>spring:
  cloud:
    config:
      uri: # 配置中心的URL（见下文 DevOps实现 说明）, e.g. http://config.dew.idealworld.group
      username:  # 配置中心访问用户名
      password:  # 配置中心访问密码
      label:  # 加载的Git分支名</pre>
</div>
</div>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew DevOps] 删除或修改 <code>logback-spring.xml</code></p>
<div class="literalblock">
<div class="content">
<pre>日志会由fluentd自动收集，一般情况下无需配置 logback-spring.xml
更改日志级别使用 application-X.yml e.g.
logging:
  level:
    ROOT: INFO
    group.idealworld.dew: DEBUG                       # Dew目录日志配置
    org.springframework.jdbc.core: TRACE# Jdbc目录日志配置</pre>
</div>
</div>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew DevOps] 为前端工程添加 <code>pom.xml</code> ，e.g.</p>
<div class="literalblock">
<div class="content">
<pre>-----------------
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  &lt;parent&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;parent-starter&lt;/artifactId&gt;
    &lt;version&gt;2.0.0-rc&lt;/version&gt;
  &lt;/parent&gt;
  &lt;groupId&gt;group.idealworld.dew.devops.it&lt;/groupId&gt;
  &lt;artifactId&gt;todo-frontend&lt;/artifactId&gt;
  &lt;packaging&gt;pom&lt;/packaging&gt;
  &lt;!-- 如果前端工程是原生NodeJS启动方式，请在pom中添加一下配置，如果前端工程是打包成静态文件的方式则不需要添加 --&gt;
  &lt;!--  默认配置此项的NodeJS项目的端口为3000，如需修改端口，请为该前端模块添加.dew配置文件，并设置app.port为指定值。--&gt;
  &lt;properties&gt;
      &lt;frontend.package.type&gt;NATIVE&lt;/frontend.package.type&gt;
  &lt;/properties&gt;
  &lt;repositories&gt;
    &lt;repository&gt;
      &lt;id&gt;central&lt;/id&gt;
      &lt;url&gt;https://repo.maven.apache.org/maven2&lt;/url&gt;
    &lt;/repository&gt;
    &lt;repository&gt;
      &lt;id&gt;oss-public&lt;/id&gt;
      &lt;url&gt;https://oss.sonatype.org/content/groups/public&lt;/url&gt;
    &lt;/repository&gt;
    &lt;repository&gt;
      &lt;id&gt;oss-snapshot&lt;/id&gt;
      &lt;url&gt;https://oss.sonatype.org/content/repositories/snapshots&lt;/url&gt;
      &lt;snapshots&gt;
        &lt;enabled&gt;true&lt;/enabled&gt;
        &lt;checksumPolicy&gt;warn&lt;/checksumPolicy&gt;
      &lt;/snapshots&gt;
    &lt;/repository&gt;
  &lt;/repositories&gt;
&lt;/project&gt;
-----------------
将此工程加入到&lt;modules&gt;中，如果前端工程是原生Node启动方式，在pom的properties中添加属性frontend.package.type为NATIVE</pre>
</div>
</div>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew DevOps] 去掉前端编译时的进度条显示</p>
<div class="literalblock">
<div class="content">
<pre>由于进度条的显示调用了清屏子命令，Dew暂无法处理情况，故有诸如 ``webpack -p --progress --hide-modules`` 时应该去掉 ``-p --progress``</pre>
</div>
</div>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew DevOps] 为没有继承 <code>parent-starter</code> 的工程添加 <code>parent-starter</code> 模块，以实现DevOps功能，此模块没有任何依赖，故引入不会产生副作用</p>
<div class="literalblock">
<div class="content">
<pre>&lt;parent&gt;
    &lt;groupId&gt;group.idealworld.dew&lt;/groupId&gt;
    &lt;artifactId&gt;parent-starter&lt;/artifactId&gt;
    &lt;version&gt;&lt;最新的版本&gt;&lt;/version&gt;
&lt;/parent&gt;</pre>
</div>
</div>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew DevOps] 项目模块的pom.xml内去除 <code>spring-boot-maven-plugin</code> 插件</p>
</li>
<li>
<p><input type="checkbox" data-item-complete="0"> [Dew DevOps] 在项目中添加<code>.dew</code>配置，详见 <a href="#devops-configuration-dew">.dew 配置</a></p>
<div class="literalblock">
<div class="content">
<pre># 在根目录添加 .dew ，至少添加 使用到的 profile 及 namespace 信息
# e.g.
# -----------------
# 默认通知配置，详见 Dew的通知处理模块
# 默认为钉钉通知
notify:
  args:
    # 通知的URL，可自行修改，详见 https://open-doc.dingtalk.com/microapp/serverapi2/qf2nxq
    url: xxx
profiles:
  test:                 # 环境对应的 profile
    namespace: dew-test # 各环境对应的 namespace 为必填项
    app:
      replicas: 2       # 设置各服务的实例个数，推荐设为 2及2个以上，便于滚动更新时不中断服务
  uat:
    namespace: dew-uat
  prod:
    namespace: dew-prod
# -----------------
# （可选）根据实际情况为每个应用添加 .dew 文件以添加各应用的特殊配置</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
各环境 namespace 的值请配置为与 dew-devops.sh 脚本中创建的 project 相同的名称。
</td>
</tr>
</table>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><i class="fa fa-square-o"></i> [Dew DevOps] 若使用 Jenkins Pipeline 部署项目，可在 Jenkins 中创建 Pipeline Job。详细配置方法参见：<a href="#dew-jenkins-pipeline">Dew DevOps : Jenkins Pipeline 部署</a></p>
</li>
<li>
<p><i class="fa fa-square-o"></i> [Dew DevOps] 若使用 Gitlab Runner 部署项目，在项目中添加<code>.gitlab-ci.yml</code>配置，详见 <a href="#devops-cicd-gitlab-template">gitlab-ci-template.yml</a>， e.g.</p>
<div class="literalblock">
<div class="content">
<pre>stages:
  - deploy
cache:
  paths:
    - node_modules/
    - .m2/
# 测试环境部署
test deploy:
  stage: deploy
  only:
    - test
  tags:
    - test
  script:
    - mvn -P devops deploy
# 用户验收/预发环境部署
uat deploy:
  stage: deploy
  only:
    - uat
  tags:
    - uat
  script:
    - mvn -P devops deploy
prod deploy: # 生产环境部署
  stage: deploy
  only:
    - prod
  tags:
    - prod
  script:
    - mvn -P devops deploy</pre>
</div>
</div>
</li>
</ul>
</div>
<div id="dew-3-migration-guide" class="paragraph">
<p>=== Dew 3.x Migration guide</p>
</div>
<div class="paragraph">
<p>本手册适用于从原生 Spring Cloud 项目及 Dew 2.x 项目迁移到 Dew 3.x 的操作说明。</p>
</div>
<div class="paragraph">
<p>==== 迁移步骤</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p><input type="checkbox" data-item-complete="0"> [配置] <code>dew.security.router.black-uri</code> 更名为 <code>dew.security.router.block-uri</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>=== 内置Image与Chart</p>
</div>
<div class="paragraph">
<p>==== Dew Docker Image : 集成CI/CD能力</p>
</div>
<div class="paragraph">
<p>本镜像为Dew微服务体系的组成部分，集成说明参见： <a href="#Devops-chapter">Dew Devops 部署运维</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre># 直接使用docker hub镜像或手工打包：
docker build -t dewms/devops .
或
docker build -t dewms/devops --build-arg MAVEN_AGENT_URL=&lt;&gt; .


# 测试
docker run -it dewms/devops
-
# 正确显示Java版本
java -version
# 正确显示Maven版本
mvn -version
# 正确显示Node版本
node -v
# 正确显示NPM版本
npm version
-</pre>
</div>
</div>
<div class="paragraph">
<p>=== 支持的CI/CD服务</p>
</div>
<div id="dew-devops-maven-agent" class="paragraph">
<p>==== Dew DevOps Maven Agent</p>
</div>
<div class="paragraph">
<p>本插件为Dew微服务体系的组成部分，集成说明参见： <a href="#Devops-chapter">Dew Devops 部署运维</a></p>
</div>
<div class="paragraph">
<p>Dew会动态判定应用（子模块）是否需要部署，但Maven无法在启动后动态处理应用是否跳过，
Dew的maven插件为此做了一定要处理，但这一做法只是跳过了执行插件，并没有彻底跳过应用，详见 <a href="#devops-user-manual-release-skip">不需要部署的应用处理</a> 。</p>
</div>
<div class="paragraph">
<p>本插件使用 <code>javaagent</code> 可实现彻底的跳过不需要部署的应用。</p>
</div>
<div class="listingblock">
<div class="title">使用</div>
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">SET MAVEN_OPTS=-javaagent:&lt;本插件的jar&gt;
mvn -P devops deploy &lt;其它命令&gt;</code></pre>
</div>
</div>
<div id="dew-gitlab-ci" class="paragraph">
<p>==== Dew CI/CD : Gitlab CI 实现</p>
</div>
<div class="paragraph">
<p>此为Gitlab CI上的 CI/CD 处理，集成说明参见： <a href="#Devops-chapter">Dew Devops 部署运维</a></p>
</div>
<div class="olist arabic">
<div class="title">前置准备</div>
<ol class="arabic">
<li>
<p>创建Gitlab项目</p>
</li>
<li>
<p>执行 <code>dew-devops.sh</code> 初始化项目对应的各个环境（详见 <a href="#devops-user-manual">DevOps使用手册</a>）</p>
</li>
<li>
<p>在项目代码中添加并配置 <code>.dew</code> 文件（详见 <a href="#devops-user-manual">DevOps使用手册</a>）</p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">核心流程</div>
<ol class="arabic">
<li>
<p>配置 <code>.gitlab-ci.yml</code>，配置参见 <a href="https://github.com/gudaoxuri/dew/blob/master/devops/cicd/gitlabci/.gitlab-ci-template.yml">gitlab-ci-template.yml</a></p>
</li>
<li>
<p>添加 <code>.gitlab-ci.yml</code> 到项目代码根目录</p>
</li>
</ol>
</div>
<div id="devops-cicd-gitlab-template" class="listingblock">
<div class="title">gitlab-ci-template.yml</div>
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">#
# Copyright 2019. the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# ======================================================

# 此为 Gitlab CI的模板文件
# 各配置说明见 https://docs.gitlab.com/ee/ci/yaml/

# ======================================================

# 要执行的Stages
# Dew 推荐只创建一个名为deploy的Stages，因为Dew的 devops-maven-plugin 已高度集成了CI/CD流程
stages:
  - deploy

# 缓存目录，必须添加
cache:
  paths:
    # node项目必须添加，需要根据实际情况指定到对应的目录，e.g. frontend/node_modules/
    - node_modules/
    # 所有项目必须添加（因为dew将所有类型的工程都视为maven项目，包含前端工程），固定为此目录
    - .m2/

# 不同环境的部署配置，各环境执行的操作一致，但触发的 branch 及 调用的 Runner 不同

# 测试环境部署
test deploy:
  stage: deploy
  only:
    # 触发构建的 branch 名称
    - test
  tags:
    # 调用的 runner 名称，需要与 Gitlab CI Runner的Tag匹配
    - test
  script:
    # 执行的操作，可以扩展，但要保留以下代码
    - mvn -P devops deploy
    # 可在此处添加代理
    # e.g. -Dhttp.proxyHost=10.200.4.63 -Dhttp.proxyPort=1080 -Dhttps.proxyHost=10.200.4.63 -Dhttps.proxyPort=1080 -Dhttp.nonProxyHosts="localhost|127.0.0.1|*.dew.idealworld.group" -Dhttps.nonProxyHosts="localhost|127.0.0.1|*.dew.idealworld.group"

# 用户验收/预发环境部署
uat deploy:
  stage: deploy
  only:
    - uat
  tags:
    - uat
  script:
    - mvn -P devops deploy

prod deploy: # 生产环境部署
  stage: deploy
  only:
    # 触发构建的 branch 名称
    - prod
  tags:
    # 调用的 runner 名称，需要与 Gitlab CI Runner的Tag匹配
    - prod
  script:
    # 执行的操作，可以扩展，但要保留以下代码
    - mvn -P devops deploy
    # 可在此处添加代理
    # e.g. -Dhttp.proxyHost=10.200.4.63 -Dhttp.proxyPort=1080 -Dhttps.proxyHost=10.200.4.63 -Dhttps.proxyPort=1080 -Dhttp.nonProxyHosts="localhost|127.0.0.1|*.dew.idealworld.group" -Dhttps.nonProxyHosts="localhost|127.0.0.1|*.dew.idealworld.group"</code></pre>
</div>
</div>
<div id="dew-jenkins-pipeline" class="paragraph">
<p>==== Dew DevOps : Jenkins Pipeline 部署</p>
</div>
<div class="paragraph">
<p>此为 使用 Dew DevOps 进行部署项目的 Jenkins Pipeline 部署方式的说明。Dew DevOps 集成说明参见： <a href="#Devops-chapter">Dew Devops 部署运维</a></p>
</div>
<div class="olist arabic">
<div class="title">前置准备</div>
<ol class="arabic">
<li>
<p>创建项目</p>
</li>
<li>
<p>执行 <code>dew-devops.sh</code> 初始化项目对应的各个环境（详见 <a href="#devops-user-manual">DevOps使用手册</a>），不需要执行脚本中的步骤2</p>
</li>
<li>
<p>在项目代码中添加并配置 <code>.dew</code> 文件（详见 <a href="#devops-user-manual">DevOps使用手册</a>）</p>
</li>
<li>
<p>安装 Jenkins</p>
</li>
<li>
<p>安装 Jenkins 插件 <code>Mask Passwords Plugin</code>，用于隐藏 Pipeline 构建过程中的敏感参数值。如不安装，Pipeline 直接执行 dew-devops.groovy 脚本会报错。</p>
</li>
<li>
<p>安装 Jenkins 插件<code>Git Parameter</code>和<code>Extended Choice Parameter</code>，便于 Pipeline 参数化构建使用。</p>
</li>
<li>
<p>在 Jenkins 的<code>系统管理</code> &#8594; <code>系统设置</code>中，设置 <code>全局属性</code> &#8594; <code>环境变量</code>,具体参数详见：<a href="#jenkins-global-env">Jenkins Dew DevOps 全局环境变量</a></p>
</li>
</ol>
</div>
<div class="olist arabic">
<div class="title">核心流程</div>
<ol class="arabic">
<li>
<p>根据需要修改 <code>devops/cicd/jenkins/scripts/dew-devops.groovy</code> Pipeline 脚本</p>
</li>
<li>
<p>在 Jenkins 中创建一个<code>pipeline</code></p>
</li>
<li>
<p>在 Pipeline <code>Definition</code>选择需要的流水线类型</p>
<div class="ulist">
<ul>
<li>
<p>选择 <code>Pipeline script</code>，将修改后的<code>dew-devops.groovy</code>脚本内容粘贴进输入框即可。</p>
</li>
<li>
<p>若选择<code>Pipeline script from SCM</code> ，填入修改的脚本所在路径即可。e.g.</p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/pipeline-scm.jpg" alt="pipeline scm">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>在 General 部分，勾选<code>参数化构建过程</code>，填入需要的各项参数。详细参数可查 <a href="#Jenkins-Parameter-build">Dew Pipeline 参数化构建参数</a></p>
<div class="ulist">
<ul>
<li>
<p>一些必要参数</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Parameter Name </strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">git_repo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">需要部署项目的代码地址</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">branch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">需要部署项目的代码分支，格式为：origin/master</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">需要部署项目的配置profile，如不设置，默认根据 Pipeline Job名称中包含的关键字来匹配，匹配关键字： test/uat/prd/prod</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kube_config</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">需要将项目部署在的 Kubernetes 集群的 kube config 的base64 的值,通过在Kubernetes集群中执行``echo $(cat ~/.kube/config</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">base64)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tr -d " "`` 获取；如不设置，默认根据Pipeline Job的名字找到已有的全局环境变量中的 DEW_DEVOPS_KUBE_CONFIG_XXXX 。请确保该参数有值可取。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_phase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">需要执行的Dew DevOps类型，不填时默认为 deploy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_mvn_thread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">部署项目的线程数，如不设置，将单线程部署，部署速度较慢。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_assign_services</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">指定部署的服务名，以各模块的artifactId，多个以<code>,</code>逗号分隔。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
更多详情可看<a href="#Jenkins-pipeline">Jenkins pipeline 使用手册</a>
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="Jenkins-pipeline" class="paragraph">
<p>===== Jenkins Pipeline Job 使用手册</p>
</div>
<div class="paragraph">
<p>====== Jenkins Pipeline Job 创建</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>点击 新建任务 &#8594; 选择 pipeline（流水线），如图：</p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/pipeline-create.jpg" alt="pipeline create" width="70%" height="70%">
</div>
</div>
</li>
<li>
<p>在 General 中选择参数化构建过程</p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/parameter.jpg" alt="parameter" width="70%" height="70%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>点击参数化构建，添加相关的参数</p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/parameter-types.jpg" alt="parameter types" width="70%" height="70%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Git Parameter</p>
<div class="paragraph">
<p>Git Parameter 类型的参数适用于和Git相关的数据，可以通过<code>Use repository</code>设置Git repo的地址来自动获取相关参数值。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>e.g.</p>
<div class="paragraph">
<p>以变量<code>branch</code>为例，</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/parameter-branch-1.jpg" alt="parameter branch 1" width="70%" height="70%">
</div>
</div>
<div class="paragraph">
<p>点开高级可以进行更详细的设置</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/parameter-branch-2.jpg" alt="parameter branch 2" width="70%" height="70%">
</div>
</div>
<div class="paragraph">
<p>通过<code>Default Value</code>和<code>Selected Value</code>来设置<code>branch</code>变量的默认值。</p>
</div>
</li>
<li>
<p>Trouble Shooting</p>
<div class="paragraph">
<p>新创建的Job，在第一次参数化构建时，会显示以下内容，此为正常现象，在第一次构建完成后，会正常显示该repo中的branch信息。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/ts-git.jpg" alt="ts git" width="70%" height="70%">
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Extended Choice Parameter</p>
<div class="paragraph">
<p>此参数类型，通常用于多种参数值的进行选择的情况。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>e.g.</p>
<div class="paragraph">
<p>以变量<code>devops_assign_services</code>为例</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/parameter-assign-service.jpg" alt="parameter assign service" width="70%" height="70%">
</div>
</div>
<div class="paragraph">
<p>通过设置分隔符，value 及 value description，可以直接在参数化构建时，显示出列表。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/parameter-assign-service-view.jpg" alt="parameter assign service view" width="70%" height="70%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Tips</p>
<div class="paragraph">
<p>value 和 value description 的内容位置需要严格对应。</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>其他的参数类型使用可根据需要自行选择,其他的参数可以自行设置。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>在页面最下方的流水线设置中选择<code>SCM</code>的方式</p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/pipeline-scm.jpg" alt="pipeline scm" width="70%" height="70%">
</div>
</div>
<div class="paragraph">
<p>在<code>脚本路径</code>中，设置需要执行的脚本文件路径。<code>devops/cicd/jenkins/scripts/dew-devops.groovy</code>为使用<code>dew</code>来进行服务部署的 Pipeline 脚本。</p>
</div>
</li>
<li>
<p>在Job左侧点击参数化构建，即可开始Job的构建。</p>
<div class="ulist">
<ul>
<li>
<p>e.g.</p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/pipeline-build.jpg" alt="pipeline build" width="70%" height="70%">
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>====== Jenkins Pipeline Job 使用</p>
</div>
<div class="paragraph">
<p>使用 Dew DevOps 进行服务的管理的 Job 的参数化构建内容如图</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/pipeline-dew.jpg" alt="pipeline dew" width="70%" height="70%">
</div>
</div>
<div class="paragraph">
<p>直接点击开始构建，即可开始全部服务的部署，各参数使用当前默认值。</p>
</div>
<div class="ulist">
<div class="title">参数说明：</div>
<ul>
<li>
<p>branch 为部署代码的分支</p>
</li>
<li>
<p>profile 为部署代码的环境配置</p>
</li>
<li>
<p>devops_appended_cmd 为 Dew 部署命令的附加值，可为空。详细可查 <a href="http://doc.dew.idealworld.group/#devops-user-manual">Dew DevOps</a>。</p>
</li>
<li>
<p>devops_assign_services 为指定部署的服务，为空时部署全部服务。可多选。</p>
</li>
<li>
<p>devops_phase 为部署的类型，默认为 deploy（部署服务）。对应值说明见：<a href="../../README.html#devops_phase">devops_phase</a></p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/pipeline-devops-phase-view.jpg" alt="pipeline devops phase view" width="50%" height="50%">
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>====== Trouble Shootings</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>参数化构建时显示 The default value has been returned.</p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/ts-git.jpg" alt="ts git" width="70%" height="70%">
</div>
</div>
<div class="paragraph">
<p>A:
新创建的 Job，在第一次参数化构建时，会显示以上内容，此为正常现象，在第一次构建完成后，会正常显示该 Repo 对应信息。</p>
</div>
</li>
<li>
<p>Job 的 控制台输出中，显示 stage skip</p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/manual/ts-stage-skip.jpg" alt="ts stage skip" width="70%" height="70%">
</div>
</div>
<div class="paragraph">
<p>A:
此为正常现象。参数化构建时，因为参数不同时，会执行不同的脚本内容。</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>===== Jenkins pipeline 部署脚本说明</p>
</div>
<div class="paragraph">
<p>====== Jenkins 插件</p>
</div>
<div class="paragraph">
<p>以下为 Dew DevOps 在 Jenkins Pipeline 部署中使用到的 Jenkins 插件。</p>
</div>
<div class="paragraph">
<div class="title">Git Parameter</div>
<p>设置方法如图，e.g.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/git_branch.jpg" alt="git branch" width="70%" height="70%">
</div>
</div>
<div class="paragraph">
<div class="title">Mask Passwords Plugin</div>
<p>Mask Passwords Plugin 用于隐藏一些不应在 Jenkins Job 执行的控制台输出的敏感数据内容。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>可以通过在 Pipeline 脚本中设置需要隐藏的参数值, e.g.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">wrap([$class: 'MaskPasswordsBuildWrapper', varPasswordPairs: [[password: "${credentialsId}", var: 'credentialsId']]]) {
    git branch: "${branch}", credentialsId: "${credentialsId}", url: "${git_url}"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>+
TIP: 需要安装此插件，如不安装，使用<code>dew-devops.groovy</code>脚本会报错。</p>
</div>
<div class="paragraph">
<div class="title">Extended Choice Parameter</div>
<p>一款可以定义参数的插件</p>
</div>
<div class="paragraph">
<div class="title">插件使用方法</div>
<p>通过如下设置，可直接在 Pipeline 脚本中引用变量名<code>${git_repo}</code>或<code>${env.git_repo}</code>即可使用参数值。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/extend-choice-parameter.jpg" alt="extend choice parameter" width="70%" height="70%">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/git_repo.jpg" alt="git repo" width="70%" height="70%">
</div>
</div>
<div class="paragraph">
<p>p.s. 也可通过 Jenkins 自身的参数类型来设值。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/parameter.jpg" alt="parameter" width="50%" height="50%">
</div>
</div>
<div class="paragraph">
<p>====== Pipeline 脚本</p>
</div>
<div class="paragraph">
<p>脚本使用方法：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>创建一个Pipeline，按照如下方式配置，填入对应的脚本路径及名称</p>
<div class="imageblock">
<div class="content">
<img src="./images/images/devops-jenkins/pipeline-scm.jpg" alt="pipeline scm" width="70%" height="70%">
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">dew-maven-agent-update 脚本</div>
<p>用于更新 Jenkins 各节点 dew-maven-agent 版本时使用。脚本路径：<code>devops/cicd/jenkins/scripts/dew-maven-agent-update.groovy</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p>需要两个参数化构建参数</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jenkins_agents</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">需要更新的 Jenkins 节点，多个以<code>,</code>逗号分隔，如不填写，默认值为 master</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MAVEN_AGENT_URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">最新的 dew-maven-agent jar 包的地址；仓库路径：https://oss.sonatype.org/content/repositories/public/group/idealworld/dew/dew-maven-agent</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>需结合全局变量使用</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MAVEN_OPTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值一般为<code>-javaagent:/opt/jar/dew-maven-agent.jar  -Dorg.apache.maven.user-settings=/opt/maven/conf/settings.xml</code></p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
<div class="paragraph">
<div class="title">dew-devops 脚本</div>
<p>此脚本为 Dew DevOps 部署所用脚本，脚本中涉及的参数请查看 <a href="#Jenkins-Parameter">[Jenkins-Parameter]</a> 章节。<br>
脚本路径： <code>devops/cicd/jenkins/scripts/dew-devops.groovy</code></p>
</div>
<div id="Jenkins-Parameter" class="paragraph">
<p>====== Jenkins 参数</p>
</div>
<div id="jenkins-global-env" class="ulist">
<ul>
<li>
<p>Jenkins 全局环境变量</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREDENTIALSID_GIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">用来拉取代码的凭据</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEW_DEVOPS_DOCKERD_HOST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dockerD的地址，e.g. tcp://10.0.0.10:2375</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEW_DEVOPS_HARBOR_HOST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Harbor仓库的地址</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEW_DEVOPS_HARBOR_USERNAME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Harbor管理员的账号</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEW_DEVOPS_HARBOR_PASSWORD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Harbor管理员账号的密码</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEW_DEVOPS_PROJECT_PROFILE_XXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">部署代码的profile，e.g. DEW_DEVOPS_PROJECT_PROFILE_TEST=test</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEW_DEVOPS_KUBE_CONFIG_XXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">项目要部署的K8S集群的kube_config的base64加密的值，通过在该集群的master节点，执行此命令
``echo $(cat ~/.kube/config</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">base64)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tr -d " "``获取,注意配置变更时及时更新此值。<br>
参数名举例： DEW_DEVOPS_KUBE_CONFIG_TEST，DEW_DEVOPS_KUBE_CONFIG_UAT，DEW_DEVOPS_KUBE_CONFIG_PRD,DEW_DEVOPS_KUBE_CONFIG</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MAVEN_OPTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值一般为<code>-javaagent:/opt/jar/dew-maven-agent.jar  -Dorg.apache.maven.user-settings=/opt/maven/conf/settings.xml</code><br>
此参数需和<code>dew-maven-agent-update</code>脚本结合使用。</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
注意需要将mvn，node等工具加入环境变量<code>PATH</code>中。另外根据情况修改<code>dew-devops.groovy</code>脚本中<code>mvnHome</code>和<code>nodeHome</code>的值。
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div id="Jenkins-Parameter-build" class="ulist">
<ul>
<li>
<p>Pipeline Job 参数化构建参数</p>
<div class="ulist">
<ul>
<li>
<p>基础参数</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tip</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkout_enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否只checkout代码</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认为false。为true时，不进行其他stage的执行。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">git_repo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">为要部署项目的<code>SSH</code>格式的代码地址，在pipeline脚本中，直接使用<code>${git_repo}</code>即可获取git代码的值。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIP: 如果pipeline使用scm的方法进行部署，不建议此参数名设为git_url，因为可能会和</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">branch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要进行部署的代码的分支</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">此参数推荐使用Git Parameter插件来配置。branch的值为去除<code>origin/</code>的部分。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jenkins_agent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">运行Job的Jenkins节点</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认根据job名设值，job名包含test的为slave，包含uat/prd/prod的为master；profile为prd/prod的默认为master</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jenkins_agents</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">指定Job运行的Jenkins节点,多个用,分隔。</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如不指定，默认为<code>master</code>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要部署项目的profile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">如不指定，根据 Job 的名字来自动判断。p.s. 生产环境默认的profile为<code>prd</code>。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kube_config</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kubernetes集群的kube config的base64值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认根据job名设值</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maven_debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否启用mvnDebug进行调试</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认不启用</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>devops_x 各参数</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Parameter</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_assign_services</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_assign_services为指定部署的项目模块（服务）名，值为各模块的<code>artifactId</code>对应值。多个服务之间可以用<code>,</code>分隔。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_appended_cmd</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_appended_cmd为部署时的附加命令，如，进行scale或autoscale时，需要额外配置的参数，可通过此参数值来传递。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_mvn_thread</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_mvn_thread为进行部署项目时使用的线程数，如不配置此参数，默认为单线程.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_phase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_phase 进行部署的阶段，如果配置此参数，默认为<code>deploy</code></p></td>
</tr>
</tbody>
</table>
<div id="devops_phase" class="ulist">
<ul>
<li>
<p>devops_phase 可选参数值说明：</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Value</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deploy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用部署</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rollback</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用回滚</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unrelease</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用卸载</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">refresh/restart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用重启</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scale</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">伸缩应用服务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoscale</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">应用自动伸缩扩展</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">redeploy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">卸载应用并重新部署</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">远程调试服务</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</li>
<li>
<p>devops_phase 为<code>rollback</code>时的可选参数</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Parameter</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">history</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否显示历史部署版本 (rollback_input_enable=true时，也显示history)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rollback_input_enable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">是否启用交互式回滚方式</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">devops_rollback_version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">指定的回滚版本，默认为空</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-12-21 09:56:31 +0800
</div>
</div>
</body>
</html>